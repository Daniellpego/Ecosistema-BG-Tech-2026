<!DOCTYPE html>
<html lang="pt-BR" data-color-scheme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BG Tech | CFO Dashboard Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --color-bg: #030712;
            --color-surface: #0d1117;
            --color-card: rgba(13, 17, 23, 0.85);
            --color-border: rgba(255, 255, 255, 0.06);
            --color-border-hover: rgba(14, 165, 233, 0.4);
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --primary-glow: rgba(14, 165, 233, 0.4);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.3);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --text-dim: #475569;
            --sidebar-w: 280px;
            --radius: 20px;
            --radius-sm: 12px;
            --transition: cubic-bezier(0.16, 1, 0.3, 1);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--color-bg); color: var(--text); line-height: 1.6; overflow-x: hidden; min-height: 100vh; }
        .font-title { font-family: 'Plus Jakarta Sans', sans-serif; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 99px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .bg-grid { position: fixed; inset: 0; z-index: 0; pointer-events: none; background-image: radial-gradient(circle at 1px 1px, rgba(14, 165, 233, 0.15) 1px, transparent 0), linear-gradient(rgba(14, 165, 233, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(14, 165, 233, 0.03) 1px, transparent 1px); background-size: 40px 40px, 60px 60px, 60px 60px; mask-image: radial-gradient(ellipse at center, black 40%, transparent 80%); }
        .bg-glow { position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; filter: blur(120px); opacity: 0.6; animation: float 20s ease-in-out infinite; }
        .bg-glow-1 { width: 800px; height: 800px; background: rgba(14, 165, 233, 0.12); top: -300px; right: -300px; animation-delay: 0s; }
        .bg-glow-2 { width: 600px; height: 600px; background: rgba(239, 68, 68, 0.08); bottom: -200px; left: -200px; animation-delay: -10s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }

        #login-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: radial-gradient(ellipse at center, #0a0f1a 0%, #030712 100%); perspective: 1000px; }
        .app { display: none; min-height: 100vh; opacity: 0; transform: translateY(20px); transition: opacity 0.6s var(--transition), transform 0.6s var(--transition); }
        .app.visible { display: flex; opacity: 1; transform: translateY(0); flex-direction: column; }

        /* MENSAGEM DO GUSTAVO */
        #msg-gustavo { display: none; margin: 0; padding: 20px 24px; background: linear-gradient(90deg, rgba(14, 165, 233, 0.15), rgba(0, 0, 0, 0.5)); border-bottom: 1px solid var(--color-border); border-left: 4px solid var(--primary); align-items: center; gap: 20px; animation: slideDown 0.5s ease forwards; }
        #msg-gustavo.active { display: flex; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-w); background: linear-gradient(180deg, rgba(3, 7, 18, 0.98) 0%, rgba(13, 17, 23, 0.95) 100%); border-right: 1px solid var(--color-border); backdrop-filter: blur(20px) saturate(180%); display: flex; flex-direction: column; padding: 32px 20px; z-index: 100; transition: transform 0.4s var(--transition); }
        .sidebar-logo { display: flex; align-items: center; gap: 14px; padding: 0 12px 48px; position: relative; }
        .sidebar-logo::after { content: ''; position: absolute; bottom: 24px; left: 12px; right: 12px; height: 1px; background: linear-gradient(90deg, transparent, var(--color-border), transparent); }
        .sidebar-logo h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 900; letter-spacing: -0.03em; color: var(--text); }
        .sidebar-logo span { color: var(--primary); text-shadow: 0 0 20px var(--primary-glow); }
        .sidebar-logo svg { color: var(--primary); filter: drop-shadow(0 0 12px rgba(14, 165, 233, 0.6)); animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { filter: drop-shadow(0 0 12px rgba(14, 165, 233, 0.6)); } 50% { filter: drop-shadow(0 0 20px rgba(14, 165, 233, 0.9)); } }

        nav { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; padding-right: 4px; }
        .nav-section-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-dim); padding: 20px 18px 8px; }
        .nav-btn { display: flex; align-items: center; gap: 14px; width: 100%; padding: 14px 18px; border: 1px solid transparent; border-radius: var(--radius-sm); background: transparent; color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s var(--transition); text-align: left; position: relative; overflow: hidden; }
        .nav-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent); transform: translateX(-100%); transition: transform 0.5s ease; }
        .nav-btn:hover { color: var(--text); background: rgba(255, 255, 255, 0.04); transform: translateX(4px); }
        .nav-btn:hover::before { transform: translateX(100%); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(14, 165, 233, 0.05) 100%); color: var(--primary); border-color: rgba(14, 165, 233, 0.25); box-shadow: 0 4px 20px rgba(14, 165, 233, 0.15); }
        .nav-btn.active::before { content: ''; position: absolute; left: 0; top: 20%; bottom: 20%; width: 3px; background: var(--primary); border-radius: 0 4px 4px 0; box-shadow: 0 0 10px var(--primary); }
        .nav-btn svg { transition: transform 0.3s ease; }
        .nav-btn:hover svg { transform: scale(1.1); }

        .sidebar-footer { margin-top: auto; padding: 16px; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--color-border); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 12px; font-size: 12px; font-weight: 600; color: var(--text-muted); backdrop-filter: blur(10px); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); box-shadow: 0 0 12px var(--success); flex-shrink: 0; position: relative; }
        .sync-dot::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid var(--success); opacity: 0; animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }

        .main-wrapper { margin-left: var(--sidebar-w); flex: 1; min-width: 0; display: flex; flex-direction: column; }
        .main { padding: 40px clamp(24px, 5vw, 60px) 80px; position: relative; z-index: 1; flex: 1; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; gap: 24px; flex-wrap: wrap; margin-bottom: 48px; padding-bottom: 24px; border-bottom: 1px solid var(--color-border); }
        .page-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: clamp(28px, 4vw, 40px); font-weight: 900; letter-spacing: -0.03em; color: var(--text); }
        .page-sub { color: var(--text-muted); font-size: 15px; font-weight: 500; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        .header-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }

        .filter-group { display: flex; background: rgba(0, 0, 0, 0.6); border: 1px solid var(--color-border); border-radius: var(--radius-sm); overflow: hidden; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .filter-select { background: transparent; color: var(--text); border: none; padding: 12px 18px; font-size: 14px; font-weight: 600; cursor: pointer; appearance: none; outline: none; transition: all 0.2s ease; }
        .filter-select:hover { background: rgba(255, 255, 255, 0.03); }
        .filter-select option { background: #0d1117; padding: 8px; }
        .filter-sep { width: 1px; background: var(--color-border); margin: 10px 0; }

        .btn-primary, .btn-success, .form-save { position: relative; overflow: hidden; }
        .loading { pointer-events: none !important; color: transparent !important; }
        .loading::after { content: ""; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; }

        .btn-primary { display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--primary-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.3s var(--transition); white-space: nowrap; }
        .btn-primary::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); transform: translateX(-100%); transition: transform 0.6s ease; }
        .btn-primary:hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 8px 30px var(--primary-glow), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        .btn-primary:hover::before { transform: translateX(100%); }
        .btn-primary:active { transform: translateY(0) scale(0.98); }

        .btn-ghost { display: inline-flex; align-items: center; gap: 10px; padding: 12px 20px; border-radius: var(--radius-sm); border: 1px solid var(--color-border); background: rgba(255, 255, 255, 0.03); color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s var(--transition); backdrop-filter: blur(10px); }
        .btn-ghost:hover { color: var(--text); background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.15); transform: translateY(-1px); }

        .btn-success { display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--success-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.3s var(--transition); white-space: nowrap; }
        .btn-success:hover { filter: brightness(1.15); transform: translateY(-2px); }
        .btn-success:active { transform: translateY(0) scale(0.98); }

        .card { background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius); backdrop-filter: blur(20px) saturate(180%); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05); transition: all 0.4s var(--transition); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(14, 165, 233, 0.06), transparent 40%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .card:hover::before { opacity: 1; }
        .card:hover { border-color: var(--color-border-hover); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(14, 165, 233, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.08); transform: translateY(-4px); }

        /* TREND BADGES (MoM) */
        .trend-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; letter-spacing: 0.05em; }
        .trend-badge.up { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .trend-badge.down { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .trend-badge.neutral { background: rgba(255, 255, 255, 0.05); color: var(--text-dim); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { padding: 24px; border-top: 3px solid transparent; position: relative; }
        .stat-card.c-danger { border-top-color: var(--danger); }
        .stat-card.c-primary { border-top-color: var(--primary); }
        .stat-card.c-warning { border-top-color: var(--warning); }
        .stat-card.c-success { border-top-color: var(--success); }
        .stat-card.c-purple { border-top-color: #a855f7; }
        .stat-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .stat-value { font-family: 'Plus Jakarta Sans', sans-serif; font-size: clamp(24px, 3vw, 32px); font-weight: 900; letter-spacing: -0.03em; color: var(--text); }
        .stat-sub { font-size: 12px; color: var(--text-dim); font-weight: 600; margin-top: 10px; display: flex; align-items: center; gap: 6px; justify-content: space-between;}

        /* STATUS BANNER */
        #status-banner { margin-bottom: 24px; padding: 16px 24px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 16px; font-size: 14px; font-weight: 600; border: 1px solid transparent; transition: all 0.3s ease; }
        #status-banner.verde { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--success); }
        #status-banner.amarelo { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); color: var(--warning); }
        #status-banner.vermelho { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger); }

        .charts-row { display: grid; grid-template-columns: 3fr 2fr; gap: 24px; margin-bottom: 32px; }
        .chart-card { padding: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border); }
        .chart-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 16px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .chart-sub { font-size: 12px; color: var(--text-muted); font-weight: 600; background: rgba(255, 255, 255, 0.03); padding: 4px 10px; border-radius: 20px; }
        #chart-area, #chart-donut, #chart-dre-bar, #chart-dre-line { min-height: 280px; }

        /* ABA BALAN√áO ANUAL */
        .annual-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .month-tile { padding: 24px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--color-border); background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%); transition: all 0.4s var(--transition); position: relative; overflow: hidden; }
        .month-tile::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--primary); transform: scaleX(0); transition: transform 0.4s var(--transition); }
        .month-tile:hover { background: linear-gradient(145deg, rgba(14, 165, 233, 0.08) 0%, rgba(14, 165, 233, 0.02) 100%); border-color: rgba(14, 165, 233, 0.3); transform: translateY(-4px) scale(1.02); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); }
        .month-tile:hover::before { transform: scaleX(1); }
        .month-tile.current { border-color: rgba(14, 165, 233, 0.5); background: linear-gradient(145deg, rgba(14, 165, 233, 0.12) 0%, rgba(14, 165, 233, 0.04) 100%); box-shadow: 0 0 30px rgba(14, 165, 233, 0.15); }
        .month-tile.current::before { transform: scaleX(1); box-shadow: 0 0 10px var(--primary); }
        .month-tile-name { font-size: 14px; font-weight: 700; color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }

        /* MODAL DRILL DOWN MENSAL */
        .modal-month { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: linear-gradient(180deg, #0d1117 0%, #070a0f 100%); border: 1px solid var(--color-border); padding: 40px; border-radius: var(--radius); z-index: 201; width: 100%; max-width: 600px; opacity: 0; pointer-events: none; transition: all 0.3s var(--transition); box-shadow: 0 40px 100px rgba(0,0,0,0.8); }
        .modal-month.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
        .drill-section { padding: 16px; background: rgba(0,0,0,0.3); border-radius: var(--radius-sm); border: 1px solid var(--color-border); margin-bottom: 16px; }
        .drill-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 14px; color: var(--text-muted); }
        .drill-row:last-child { border-bottom: none; }
        .drill-val { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; color: var(--text); }

        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius-sm); }
        .data-table { width: 100%; min-width: 800px; border-collapse: separate; border-spacing: 0; }
        .data-table th { padding: 20px 24px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-dim); background: rgba(0, 0, 0, 0.3); white-space: nowrap; border-bottom: 1px solid var(--color-border); position: sticky; top: 0; z-index: 10; text-align: left;}
        .data-table td { padding: 20px 24px; border-bottom: 1px solid var(--color-border); vertical-align: middle; transition: all 0.3s ease; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr { transition: all 0.3s ease; }
        .data-table tr:hover td { background: rgba(14, 165, 233, 0.04); }
        .item-name { font-size: 15px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .item-desc { font-size: 13px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }
        .cat-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; background: rgba(14, 165, 233, 0.1); color: var(--primary); border: 1px solid rgba(14, 165, 233, 0.2); transition: all 0.3s ease; }
        .cat-badge:hover { background: rgba(14, 165, 233, 0.2); transform: translateY(-1px); }
        .cat-badge.income { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.2); }
        .recur-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.06em; transition: all 0.3s ease; }
        .recur-badge.sim { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .recur-badge.nao { background: rgba(148, 163, 184, 0.08); color: var(--text-dim); border: 1px solid rgba(148, 163, 184, 0.15); }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; transition: all 0.3s ease; }
        .status-badge.pago { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.25); box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
        .status-badge.pendente { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.25); box-shadow: 0 0 10px rgba(245, 158, 11, 0.1); }
        .amount-cell { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 17px; font-weight: 800; text-align: right; white-space: nowrap; letter-spacing: -0.01em; }
        .action-btn { background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 10px; border-radius: 10px; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:hover { background: rgba(255, 255, 255, 0.08); color: var(--text); transform: scale(1.1); }
        .action-btn.del:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); transform: scale(1.1) rotate(5deg); }

        /* TABELA DRE GERENCIAL */
        .dre-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .dre-table th { padding: 16px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); border-bottom: 2px solid var(--color-border); text-align: right; }
        .dre-table th:first-child { text-align: left; }
        .dre-row-main { background: rgba(255,255,255,0.02); font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; font-size: 15px; border-top: 1px solid var(--color-border); }
        .dre-row-main td { padding: 18px 16px; }
        .dre-row-sub { font-size: 13px; color: var(--text-dim); font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .dre-row-sub td { padding: 14px 16px; }
        .dre-row-sub td:first-child { padding-left: 40px; display: flex; align-items: center; gap: 8px; }
        .dre-val { text-align: right; font-family: 'Plus Jakarta Sans', sans-serif; white-space: nowrap; }
        .dre-pct { font-size: 11px; color: var(--text-dim); margin-left: 8px; font-weight: 700; display: inline-block; width: 45px; text-align: right; }
        .dre-positive { color: var(--success); }
        .dre-negative { color: var(--danger); }

        .empty-state { text-align: center; padding: 100px 24px; color: var(--text-muted); }
        .empty-state svg { width: 64px; height: 64px; opacity: 0.2; margin-bottom: 24px; stroke-width: 1.5; }
        .empty-state h3 { font-size: 20px; font-weight: 800; margin-bottom: 8px; color: var(--text); }
        .empty-state p { font-size: 14px; color: var(--text-dim); max-width: 300px; margin: 0 auto; }

        .view { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        .drawer-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(12px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
        .drawer-overlay.open { opacity: 1; pointer-events: all; }
        .drawer { position: fixed; top: 0; right: -100%; bottom: 0; width: min(600px, 100vw); background: linear-gradient(180deg, #0d1117 0%, #070a0f 100%); border-left: 1px solid var(--color-border); z-index: 201; padding: clamp(32px, 6vw, 48px); overflow-y: auto; transition: right 0.5s var(--transition); box-shadow: -40px 0 80px rgba(0, 0, 0, 0.8); }
        .drawer.open { right: 0; }
        .drawer-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 24px; border-bottom: 1px solid var(--color-border); }
        .drawer-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 26px; font-weight: 900; color: var(--text); }

        .type-tabs { display: flex; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--color-border); border-radius: var(--radius-sm); padding: 6px; gap: 6px; margin-bottom: 32px; position: relative; }
        .type-tab { flex: 1; padding: 14px; border: none; background: transparent; color: var(--text-muted); font-size: 14px; font-weight: 700; border-radius: 10px; cursor: pointer; transition: all 0.3s var(--transition); position: relative; z-index: 1; }
        .type-tab.active { background: rgba(255, 255, 255, 0.08); color: var(--text); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }

        .form-group { margin-bottom: 24px; }
        .form-label { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .form-input { width: 100%; padding: 16px 18px; border-radius: var(--radius-sm); background: rgba(0, 0, 0, 0.5); border: 1px solid var(--color-border); color: var(--text); font-size: 15px; font-weight: 500; transition: all 0.3s ease; outline: none; }
        .form-input:focus { border-color: var(--primary); background: rgba(14, 165, 233, 0.04); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .form-input::placeholder { color: var(--text-dim); }
        select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 16px; padding-right: 48px; }
        select.form-input option { background: #0d1117; padding: 12px; }
        .form-hint { font-size: 12px; color: var(--text-dim); margin-top: 8px; font-weight: 500; display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border-left: 3px solid var(--primary); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .login-card { width: 100%; max-width: 440px; margin: 24px; padding: 56px 48px; transform-style: preserve-3d; animation: cardFloat 6s ease-in-out infinite; }
        @keyframes cardFloat { 0%, 100% { transform: translateY(0) rotateX(0); } 50% { transform: translateY(-10px) rotateX(2deg); } }
        .login-logo { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 16px; }
        .login-logo h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 42px; font-weight: 900; color: var(--text); }
        .login-logo span { color: var(--primary); text-shadow: 0 0 30px var(--primary-glow); }
        .login-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 99px; background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.3); color: var(--primary); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 48px; }
        .login-field { position: relative; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 18px 18px 18px 52px; border-radius: var(--radius-sm); background: rgba(0, 0, 0, 0.6); border: 1px solid var(--color-border); color: var(--text); font-size: 16px; transition: all 0.3s ease; }
        .login-input:focus { border-color: var(--primary); background: rgba(14, 165, 233, 0.05); }
        .login-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-dim); transition: all 0.3s ease; }
        .login-input:focus+.login-icon { color: var(--primary); transform: translateY(-50%) scale(1.1); }

        .modal-export { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--color-surface); border: 1px solid var(--color-border); padding: 40px; border-radius: var(--radius); z-index: 201; width: 100%; max-width: 500px; opacity: 0; pointer-events: none; transition: all 0.3s var(--transition); box-shadow: 0 40px 100px rgba(0,0,0,0.8); }
        .modal-export.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }

        #toast-wrap { position: fixed; bottom: 32px; right: 32px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { background: rgba(13, 17, 23, 0.95); border: 1px solid var(--color-border); border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: var(--radius-sm); color: var(--text); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 12px; transform: translateX(120%) scale(0.9); opacity: 0; transition: all 0.5s var(--transition); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); pointer-events: all; }
        .toast.show { transform: translateX(0) scale(1); opacity: 1; }
        .toast.err { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }

        .search-wrap { padding: 20px 24px; border-bottom: 1px solid var(--color-border); background: rgba(0, 0, 0, 0.2); }
        .search-input { width: 100%; padding: 14px 18px 14px 48px; border-radius: var(--radius-sm); background: rgba(0, 0, 0, 0.4); border: 1px solid var(--color-border); color: var(--text); font-size: 14px; font-weight: 500; outline: none; position: relative; }
        .search-wrap .search-icon { position: absolute; left: 40px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .mobile-bar { display: none; }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-wrapper { margin-left: 0; }
            .main { padding: 24px 20px 100px; }
            .charts-row, .form-grid { grid-template-columns: 1fr; }
            .mobile-bar { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(3, 7, 18, 0.98); border-top: 1px solid var(--color-border); padding: 8px 4px calc(8px + env(safe-area-inset-bottom)); z-index: 150; justify-content: space-around; backdrop-filter: blur(20px); overflow-x: auto; gap: 2px; }
            .m-btn { background: none; border: none; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; padding: 6px 10px; border-radius: 12px; }
            .m-btn.active { color: var(--primary); background: rgba(14, 165, 233, 0.1); }
            #msg-gustavo { margin: 20px 20px 0 20px; flex-direction: column; text-align: center; }
        }
    </style>
</head>

<body>
    <div class="bg-grid"></div>
    <div class="bg-glow bg-glow-1"></div>
    <div class="bg-glow bg-glow-2"></div>

    <div id="login-screen">
        <div class="card login-card" id="login-card">
            <div class="login-logo">
                <i data-lucide="cpu" width="44" height="44"></i>
                <h1>BG <span>TECH</span></h1>
            </div>
            <div style="text-align:center;">
                <span class="login-badge"><i data-lucide="shield-check" width="16" height="16"></i> Acesso Restrito CFO</span>
            </div>
            <div class="login-field">
                <input type="text" id="lu" class="login-input" placeholder="ID de Acesso (ex: gustavo)" autocomplete="username">
                <i data-lucide="user" width="20" height="20" class="login-icon"></i>
            </div>
            <div class="login-field" style="margin-bottom:40px;">
                <input type="password" id="lp" class="login-input" placeholder="Senha do Cofre" autocomplete="current-password">
                <i data-lucide="key" width="20" height="20" class="login-icon"></i>
            </div>
            <button class="btn-primary" id="btn-login" style="width:100%;padding:18px;font-size:16px;justify-content:center;" onclick="A.login()">
                Destrancar Sistema <i data-lucide="arrow-right" width="20" height="20"></i>
            </button>
        </div>
    </div>

    <div class="app" id="app">
        
        <aside class="sidebar" id="sidebar" role="navigation">
            <div class="sidebar-logo">
                <i data-lucide="cpu" width="28" height="28"></i>
                <h1>BG <span>TECH</span></h1>
            </div>
            <nav>
                <div class="nav-section-label">Vis√£o Executiva</div>
                <button class="nav-btn active" data-tab="overview" onclick="A.tab('overview')"><i data-lucide="layout-dashboard"></i> Painel Geral</button>
                <button class="nav-btn" data-tab="dre" onclick="A.tab('dre')" style="color: var(--success);"><i data-lucide="calculator"></i> DRE Gerencial</button>
                <button class="nav-btn" data-tab="annual" onclick="A.tab('annual')"><i data-lucide="calendar-range"></i> Balan√ßo Anual</button>
                
                <div class="nav-section-label">Lan√ßamentos Financeiros</div>
                <button class="nav-btn" data-tab="entradas" onclick="A.tab('entradas')"><i data-lucide="wallet"></i> Receitas</button>
                <button class="nav-btn" data-tab="fixos" onclick="A.tab('fixos')"><i data-lucide="anchor"></i> Custos Fixos</button>
                <button class="nav-btn" data-tab="unicos" onclick="A.tab('unicos')"><i data-lucide="zap"></i> Gastos Vari√°veis</button>
                
                <div class="nav-section-label">An√°lise & Simula√ß√£o</div>
                <button class="nav-btn" data-tab="relatorios" onclick="A.tab('relatorios')"><i data-lucide="file-down"></i> Exportar</button>
                <button class="nav-btn" data-tab="projecoes" onclick="A.tab('projecoes')"><i data-lucide="line-chart"></i> Proje√ß√µes</button>
            </nav>
            <div class="sidebar-footer">
                <div class="sync-dot" id="sync-dot"></div>
                <span id="sync-txt">Conectado</span>
            </div>
        </aside>

        <div class="main-wrapper">
            <div id="msg-gustavo">
                <div style="padding: 12px; background: rgba(14, 165, 233, 0.2); border-radius: 50%;">
                    <i data-lucide="trending-up" width="32" height="32" style="color: var(--primary);"></i>
                </div>
                <div>
                    <h2 class="font-title" style="font-size: 24px; font-weight: 900; color: white; margin-bottom: 4px;">Seja bem vindo, Gustavo... o CFO mais foda da porra toda üöÄ</h2>
                    <p style="color: var(--primary); font-weight: 600; font-size: 14px;">Seu cockpit financeiro da BG Tech est√° 100% sincronizado e pronto para operar.</p>
                </div>
            </div>

            <main class="main" id="main-content">
                <header class="page-header">
                    <div>
                        <h2 class="page-title font-title" id="page-title">Painel Geral</h2>
                        <p class="page-sub" id="page-sub"><i data-lucide="activity" width="16" height="16"></i> Vis√£o executiva para decis√£o r√°pida</p>
                    </div>
                    <div class="header-right">
                        <div class="filter-group" id="main-filters">
                            <select id="fMonth" class="filter-select" onchange="A.render()">
                                <option value="anual">üìä Balan√ßo Anual</option>
                            </select>
                            <div class="filter-sep"></div>
                            <select id="fYear" class="filter-select" onchange="A.render()">
                                <option value="2025">2025</option>
                                <option value="2026" selected>2026</option>
                            </select>
                        </div>
                        <button class="btn-primary" id="btn-add-main" onclick="A.openDrawer()">
                            <i data-lucide="plus" width="18" height="18"></i> <span id="btn-add-label">Novo Lan√ßamento</span>
                        </button>
                    </div>
                </header>

                <div id="view-overview" class="view active" role="tabpanel">
                    
                    <div id="status-banner" class="verde">
                        <i data-lucide="check-circle" width="20" height="20"></i>
                        <span><strong>Status da Opera√ß√£o:</strong> Calculando sa√∫de financeira...</span>
                    </div>

                    <div style="background: rgba(255,255,255,0.02); border: 1px solid var(--color-border); border-radius: var(--radius-sm); padding: 12px 20px; margin-bottom: 24px; display: inline-flex; align-items: center; gap: 10px;">
                        <i data-lucide="info" width="16" height="16" style="color: var(--text-muted);"></i>
                        <span style="font-size: 12px; font-weight: 600; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">O Painel Geral existe para decidir r√°pido, com base em caixa, resultado e tend√™ncia.</span>
                    </div>

                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                        
                        <div class="card stat-card c-success" style="border-top-width: 4px; background: linear-gradient(180deg, rgba(16,185,129,0.05), transparent);">
                            <div class="stat-label">Caixa Dispon√≠vel <button onclick="A.editCaixa()" style="background:none;border:none;cursor:pointer;color:var(--text-dim);"><i data-lucide="edit-3" width="14" height="14"></i></button></div>
                            <div class="stat-value font-title" id="v-caixa" style="color:var(--success)">R$ 0,00</div>
                            <div class="stat-sub"><i data-lucide="landmark" width="14" height="14"></i> Saldo na conta banc√°ria</div>
                        </div>

                        <div class="card stat-card c-purple" id="card-runway" style="border-top-width: 4px; background: linear-gradient(180deg, rgba(168,85,247,0.05), transparent);">
                            <div class="stat-label">Runway (Sobreviv√™ncia) <i data-lucide="timer" width="18" height="18" style="color:#a855f7"></i></div>
                            <div class="stat-value font-title" id="v-runway" style="color:#a855f7">0,0 Meses</div>
                            <div class="stat-sub"><i data-lucide="shield" width="14" height="14"></i> Caixa √∑ Burn Rate Mensal</div>
                        </div>

                        <div class="card stat-card" id="card-res-liq" style="border-top-width: 4px;">
                            <div class="stat-label">Resultado L√≠quido <i data-lucide="scale" width="18" height="18" id="icon-res-liq"></i></div>
                            <div class="stat-value font-title" id="v-res-liq">R$ 0,00</div>
                            <div class="stat-sub" id="v-res-liq-sub"><span class="trend-badge neutral">0% Margem</span></div>
                        </div>

                        <div class="card stat-card c-primary">
                            <div class="stat-label">Receita Total <i data-lucide="trending-up" width="18" height="18" style="color:var(--primary)"></i></div>
                            <div class="stat-value font-title" id="v-receita-ov">R$ 0,00</div>
                            <div class="stat-sub" id="t-receita-ov"><span class="trend-badge neutral">-</span></div>
                        </div>

                        <div class="card stat-card c-primary" style="border-top-color: rgba(14,165,233,0.5);">
                            <div class="stat-label">MRR (Recorrente) <i data-lucide="repeat" width="18" height="18" style="color:var(--primary)"></i></div>
                            <div class="stat-value font-title" id="v-mrr-ov">R$ 0,00</div>
                            <div class="stat-sub" id="t-mrr-ov"><span class="trend-badge neutral">-</span></div>
                        </div>

                        <div class="card stat-card c-danger">
                            <div class="stat-label">Burn Rate Mensal <i data-lucide="flame" width="18" height="18" style="color:var(--danger)"></i></div>
                            <div class="stat-value font-title" id="v-burn-ov" style="color:var(--danger)">R$ 0,00</div>
                            <div class="stat-sub" id="t-burn-ov"><span class="trend-badge neutral">-</span></div>
                        </div>

                        <div class="card stat-card c-warning">
                            <div class="stat-label">Custos Fixos <i data-lucide="anchor" width="18" height="18" style="color:var(--warning)"></i></div>
                            <div class="stat-value font-title" id="v-fixos-ov">R$ 0,00</div>
                            <div class="stat-sub"><i data-lucide="info" width="14" height="14"></i> Despesa estrutural</div>
                        </div>

                        <div class="card stat-card c-warning" style="border-top-color: rgba(245,158,11,0.5);">
                            <div class="stat-label">Custos Vari√°veis <i data-lucide="zap" width="18" height="18" style="color:var(--warning)"></i></div>
                            <div class="stat-value font-title" id="v-var-ov">R$ 0,00</div>
                            <div class="stat-sub"><i data-lucide="info" width="14" height="14"></i> Impostos e pontuais</div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="card chart-card">
                            <div class="chart-header">
                                <span class="chart-title font-title"><i data-lucide="activity" width="20" height="20" style="color:var(--primary)"></i> Receitas vs Burn Rate</span>
                                <span class="chart-sub">√öltimos 6 meses</span>
                            </div>
                            <div id="chart-area"></div>
                        </div>
                        <div class="card chart-card">
                            <div class="chart-header">
                                <span class="chart-title font-title"><i data-lucide="pie-chart" width="20" height="20" style="color:var(--primary)"></i> Distribui√ß√£o Fixos</span>
                                <span class="chart-sub">Onde o dinheiro queima</span>
                            </div>
                            <div id="chart-donut"></div>
                        </div>
                    </div>
                </div>

                <div id="view-dre" class="view" role="tabpanel">
                    <div style="background: linear-gradient(90deg, rgba(14,165,233,0.1), transparent); border-left: 4px solid var(--primary); padding: 20px 24px; border-radius: 0 var(--radius-sm) var(--radius-sm) 0; margin-bottom: 32px; display: flex; gap: 16px; align-items: center;">
                        <i data-lucide="quote" width="24" height="24" style="color: var(--primary); opacity: 0.5;"></i>
                        <p style="font-size: 15px; font-weight: 500; color: var(--text-muted); font-style: italic;">"Essa aba representa a vis√£o financeira do CFO. <strong style="color: white;">N√£o √© contabilidade fiscal, √© intelig√™ncia financeira para tomada de decis√£o.</strong>"</p>
                    </div>

                    <div class="charts-row">
                        <div class="card chart-card">
                            <div class="chart-header">
                                <span class="chart-title font-title"><i data-lucide="bar-chart-2" width="20" height="20" style="color:var(--primary)"></i> Receita vs Custos Totais</span>
                            </div>
                            <div id="chart-dre-bar"></div>
                        </div>
                        <div class="card chart-card">
                            <div class="chart-header">
                                <span class="chart-title font-title"><i data-lucide="trending-up" width="20" height="20" style="color:var(--success)"></i> Resultado L√≠quido (6 Meses)</span>
                            </div>
                            <div id="chart-dre-line"></div>
                        </div>
                    </div>

                    <div class="card" style="padding: 32px; overflow-x: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 class="font-title" style="font-size: 20px;">Demonstra√ß√£o de Resultado (DRE)</h3>
                            <div style="font-size: 13px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 8px;">
                                Per√≠odo: <strong style="color: white;" id="dre-lbl-periodo">--</strong>
                            </div>
                        </div>

                        <table class="dre-table">
                            <thead>
                                <tr>
                                    <th>Estrutura do DRE</th>
                                    <th>M√™s / Sele√ß√£o</th>
                                    <th>Acumulado Ano (YTD)</th>
                                </tr>
                            </thead>
                            <tbody id="dre-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="view-annual" class="view" role="tabpanel">
                    <div class="card" style="padding:32px;margin-bottom:24px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;flex-wrap:wrap;gap:16px;">
                            <div>
                                <div class="chart-title font-title" style="font-size:24px;margin-bottom:8px;" id="annual-title">Balan√ßo Anual</div>
                                <div style="font-size:14px;color:var(--text-muted);display:flex;align-items:center;gap:8px;">
                                    <i data-lucide="mouse-pointer-2" width="14" height="14"></i> Clique em um m√™s para visualizar o Drill Down (Detalhes)
                                </div>
                            </div>
                            <div style="display:flex;gap:16px;flex-wrap:wrap;">
                                <div style="text-align:center;padding:16px 20px;background:rgba(16,185,129,0.08);border-radius:var(--radius-sm);border:1px solid rgba(16,185,129,0.25);">
                                    <div style="font-size:11px;color:var(--success);font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">Faturamento Ano</div>
                                    <div class="font-title" style="font-size:22px;font-weight:900;color:var(--success);" id="annual-total-in">R$ 0,00</div>
                                </div>
                                <div style="text-align:center;padding:16px 20px;background:rgba(239,68,68,0.08);border-radius:var(--radius-sm);border:1px solid rgba(239,68,68,0.25);">
                                    <div style="font-size:11px;color:var(--danger);font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">Gastos Ano</div>
                                    <div class="font-title" style="font-size:22px;font-weight:900;color:var(--danger);" id="annual-total-out">R$ 0,00</div>
                                </div>
                                <div style="text-align:center;padding:16px 20px;background:rgba(0,0,0,0.3);border-radius:var(--radius-sm);border:1px solid var(--color-border);">
                                    <div style="font-size:11px;color:var(--text-dim);font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">Saldo Anual</div>
                                    <div class="font-title" style="font-size:22px;font-weight:900;" id="annual-saldo">R$ 0,00</div>
                                </div>
                            </div>
                        </div>
                        <div class="annual-grid" id="annual-grid"></div>
                    </div>
                </div>

                <div id="view-list" class="view" role="tabpanel">
                    <div class="card" style="overflow:hidden;">
                        <div class="search-wrap" style="position:relative;">
                            <input type="text" id="search-gastos" class="search-input" placeholder="Buscar por nome, categoria..." oninput="A.render()">
                            <i data-lucide="search" width="16" height="16" class="search-icon"></i>
                        </div>
                        <div class="table-wrap">
                            <table class="data-table" role="table">
                                <thead>
                                    <tr>
                                        <th scope="col">Data</th>
                                        <th scope="col">Descri√ß√£o</th>
                                        <th scope="col">Categoria (DRE)</th>
                                        <th scope="col">Recorr√™ncia</th>
                                        <th scope="col">Status</th>
                                        <th scope="col" style="text-align:right">Valor</th>
                                        <th scope="col" style="text-align:center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                        <div id="table-empty" class="empty-state" style="display:none;">
                            <i data-lucide="check-circle"></i>
                            <h3>Nenhum registro encontrado</h3>
                            <p>Adicione um novo lan√ßamento para come√ßar a visualizar seus dados.</p>
                        </div>
                    </div>
                </div>

                <div id="view-entradas" class="view" role="tabpanel">
                    <div class="card" style="overflow:hidden;">
                        <div class="search-wrap" style="position:relative;">
                            <input type="text" id="search-entradas" class="search-input" placeholder="Buscar por cliente, projeto..." oninput="A.render()">
                            <i data-lucide="search" width="16" height="16" class="search-icon"></i>
                        </div>
                        <div class="table-wrap">
                            <table class="data-table" role="table">
                                <thead>
                                    <tr>
                                        <th scope="col">Data</th>
                                        <th scope="col">Descri√ß√£o / Cliente</th>
                                        <th scope="col">Tipo de Receita</th>
                                        <th scope="col">Recorr√™ncia</th>
                                        <th scope="col">Status</th>
                                        <th scope="col" style="text-align:right">Valor</th>
                                        <th scope="col" style="text-align:center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="table-entradas"></tbody>
                            </table>
                        </div>
                        <div id="entradas-empty" class="empty-state" style="display:none;">
                            <i data-lucide="wallet"></i>
                            <h3>Nenhuma receita registrada</h3>
                        </div>
                    </div>
                </div>

                <div id="view-relatorios" class="view" role="tabpanel">
                    <div class="card" style="padding:32px;">
                        <div class="chart-header" style="margin-bottom:32px;">
                            <span class="chart-title font-title" style="font-size:22px;">
                                <i data-lucide="file-down" width="22" height="22" style="color:var(--primary)"></i> Exporta√ß√£o de Dados
                            </span>
                        </div>
                        <p style="color: var(--text-muted); margin-bottom: 24px;">Gere relat√≥rios completos em PDF ou planilhas CSV para enviar ao seu contador ou para an√°lise externa profunda.</p>
                        <div class="export-btns">
                            <button class="btn-primary" onclick="A.openExportModal()">
                                <i data-lucide="download" width="18" height="18"></i> Configurar e Baixar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div id="view-projecoes" class="view" role="tabpanel">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                       <div class="report-filters" style="margin:0; flex: 1;">
                          <div class="filter-group" style="width: auto;">
                              <select id="p-horizonte" class="filter-select" onchange="A.renderProjecoes()">
                                 <option value="3">Pr√≥ximos 3 Meses</option>
                                 <option value="6" selected>Pr√≥ximos 6 Meses</option>
                                 <option value="12">Pr√≥ximos 12 Meses</option>
                              </select>
                          </div>
                          <div class="filter-group" style="width: auto;">
                              <select id="p-mes-filter" class="filter-select" onchange="A.renderProjecoes()">
                                 <option value="all">Todos os meses</option>
                              </select>
                          </div>
                       </div>
                       <div style="display:flex; gap:12px; flex-wrap: wrap;">
                          <button class="btn-success" onclick="A.openProjDrawer('entrada')"><i data-lucide="trending-up" width="16" height="16"></i> Projetar Receita</button>
                          <button class="btn-primary" onclick="A.openProjDrawer('saida')" style="background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%); box-shadow: 0 4px 20px var(--danger-glow);"><i data-lucide="trending-down" width="16" height="16"></i> Projetar Custo</button>
                       </div>
                    </div>

                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                        <div class="card stat-card c-success">
                            <div class="stat-label">Total Entradas <i data-lucide="trending-up" width="18" height="18" style="color:var(--success)"></i></div>
                            <div class="stat-value font-title" id="p-v-entradas" style="color:var(--success)">R$ 0,00</div>
                        </div>
                        <div class="card stat-card c-danger">
                            <div class="stat-label">Total Sa√≠das <i data-lucide="trending-down" width="18" height="18" style="color:var(--danger)"></i></div>
                            <div class="stat-value font-title" id="p-v-saidas" style="color:var(--danger)">R$ 0,00</div>
                        </div>
                        <div class="card stat-card" id="p-card-saldo" style="border-top:3px solid var(--success);">
                            <div class="stat-label">Saldo Projetado <i data-lucide="scale" width="18" height="18" style="color:var(--success)"></i></div>
                            <div class="stat-value font-title" id="p-v-saldo" style="color:var(--success)">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="card" style="overflow:hidden;">
                        <div class="table-wrap">
                            <table class="data-table" role="table">
                                <thead>
                                    <tr>
                                        <th scope="col">M√™s</th>
                                        <th scope="col">Descri√ß√£o</th>
                                        <th scope="col">Categoria (DRE)</th>
                                        <th scope="col">Status</th>
                                        <th scope="col" style="text-align:right">Valor</th>
                                        <th scope="col" style="text-align:center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="p-table-body"></tbody>
                            </table>
                        </div>
                        <div id="p-table-empty" class="empty-state" style="display:none;">
                            <i data-lucide="bar-chart-2"></i>
                            <h3>Nenhuma proje√ß√£o cadastrada</h3>
                            <p>Simule entradas e sa√≠das futuras para antecipar seu caixa.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <nav class="mobile-bar" role="navigation">
            <button class="m-btn active" data-tab="overview" onclick="A.tab('overview')"><i data-lucide="layout-dashboard"></i>Painel</button>
            <button class="m-btn" data-tab="dre" onclick="A.tab('dre')"><i data-lucide="calculator"></i>DRE</button>
            <button class="m-btn" data-tab="entradas" onclick="A.tab('entradas')"><i data-lucide="wallet"></i>Entradas</button>
            <button class="m-btn" data-tab="fixos" onclick="A.tab('fixos')"><i data-lucide="anchor"></i>Sa√≠das</button>
        </nav>
    </div>

    <div class="drawer-overlay" id="overlay" onclick="A.closeDrawer()"></div>
    <div class="drawer" id="drawer">
        <div class="drawer-head">
            <h2 class="drawer-title font-title" id="drawer-title">Novo Lan√ßamento</h2>
            <button class="btn-ghost" onclick="A.closeDrawer()" style="padding:10px;"><i data-lucide="x" width="20" height="20"></i></button>
        </div>
        <input type="hidden" id="f-id">

        <div class="type-tabs" id="modo-tabs" style="margin-bottom:16px;">
            <button class="type-tab active" id="tab-modo-despesa" onclick="A.setModo('despesa')">üí∏ Despesa</button>
            <button class="type-tab" id="tab-modo-entrada" onclick="A.setModo('entrada')">üí∞ Receita</button>
        </div>

        <div class="type-tabs" id="sub-type-tabs">
            <button class="type-tab active" id="tab-fixos" onclick="A.setType('fixos')">üìå Custo Fixo</button>
            <button class="type-tab" id="tab-unicos" onclick="A.setType('unicos')">‚ö° Vari√°vel / Imposto</button>
        </div>

        <div class="form-group">
            <label class="form-label" id="lbl-nome">Descri√ß√£o / Fornecedor *</label>
            <input type="text" id="f-nome" class="form-input" placeholder="Ex: Servidor AWS, An√∫ncios Meta..." autocomplete="off" required>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Valor (R$) *</label>
                <input type="text" id="f-valor" class="form-input" placeholder="0,00" oninput="A.maskMoney(event)" required>
            </div>
            <div class="form-group">
                <label class="form-label">Data de Compet√™ncia</label>
                <input type="date" id="f-data" class="form-input">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Recorr√™ncia</label>
            <select id="f-recor" class="form-input" onchange="A.onRecorChange()">
                <option value="unico">üî¥ √önico ‚Äî lan√ßamento manual neste m√™s</option>
                <option value="mensal">üîÑ Mensal ‚Äî replica para os 12 meses do ano</option>
                <option value="proximo">üìÖ Pr√≥ximos Meses ‚Äî replica a partir da data atual</option>
            </select>
            <div class="form-hint" id="recor-hint"><i data-lucide="info" width="14" height="14"></i> Lan√ßamento pontual.</div>
        </div>
        <div class="form-group">
            <label class="form-label">Categoria (Regra DRE) *</label>
            <select id="f-cat" class="form-input"></select>
        </div>
        <div class="form-group">
            <label class="form-label" id="lbl-status">Status de Fluxo de Caixa</label>
            <select id="f-status" class="form-input">
                <option value="Pago">‚úÖ Pago / Recebido (Entrou no Caixa)</option>
                <option value="Pendente">‚è≥ Pendente (A Pagar / A Receber)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Observa√ß√£o (Opcional)</label>
            <input type="text" id="f-desc" class="form-input" placeholder="Notas, link da NF, justificativa..." autocomplete="off">
        </div>
        <button class="form-save" id="btn-save" onclick="A.save()">
            <i data-lucide="save" width="20" height="20"></i> Salvar Registro
        </button>
    </div>

    <div class="drawer-overlay" id="proj-overlay" onclick="A.closeProjDrawer()"></div>
    <div class="drawer" id="proj-drawer">
        <div class="drawer-head">
            <h2 class="drawer-title font-title" id="proj-drawer-title">Nova Proje√ß√£o</h2>
            <button class="btn-ghost" onclick="A.closeProjDrawer()" style="padding:10px;"><i data-lucide="x" width="20" height="20"></i></button>
        </div>
        <input type="hidden" id="pf-id">

        <div class="type-tabs" id="proj-modo-tabs" style="margin-bottom:24px;">
            <button class="type-tab active" id="ptab-saida" onclick="A.setProjType('saida')">üí∏ Projetar Sa√≠da</button>
            <button class="type-tab" id="ptab-entrada" onclick="A.setProjType('entrada')">üí∞ Projetar Entrada</button>
        </div>

        <div class="form-group">
            <label class="form-label">Descri√ß√£o da Proje√ß√£o *</label>
            <input type="text" id="pf-nome" class="form-input" placeholder="Ex: Contrata√ß√£o de Dev..." autocomplete="off" required>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Valor Estimado (R$) *</label>
                <input type="text" id="pf-valor" class="form-input" placeholder="0,00" oninput="A.maskMoney(event)" required>
            </div>
            <div class="form-group">
                <label class="form-label">M√™s / Compet√™ncia *</label>
                <input type="month" id="pf-mes" class="form-input" required>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Categoria DRE</label>
            <select id="pf-cat" class="form-input"></select>
        </div>
        <div class="form-group">
            <label class="form-label">Grau de Certeza</label>
            <select id="pf-status" class="form-input">
                <option value="Previsto">‚è≥ Apenas Previsto (Simula√ß√£o DRE)</option>
                <option value="Confirmado">‚úÖ Confirmado (Certeza)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Justificativa</label>
            <input type="text" id="pf-desc" class="form-input" placeholder="Por que prevemos este gasto/receita?" autocomplete="off">
        </div>
        <button class="form-save" id="btn-proj-save" onclick="A.saveProj()">
            <i data-lucide="save" width="20" height="20"></i> Salvar Proje√ß√£o
        </button>
    </div>

    <div class="drawer-overlay" id="month-overlay" onclick="A.closeMonthModal()"></div>
    <div class="modal-month" id="month-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h3 class="font-title" style="font-size: 22px; color: white;" id="mm-title">Resumo Gerencial</h3>
            <button class="btn-ghost" onclick="A.closeMonthModal()" style="padding:8px;"><i data-lucide="x" width="16" height="16"></i></button>
        </div>
        
        <div class="drill-section">
            <div style="font-size:11px; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:12px;">Dados Realizados</div>
            <div class="drill-row"><span>Total Receitas</span><span class="drill-val" style="color:var(--success)" id="mm-rec">R$ 0,00</span></div>
            <div class="drill-row"><span>Custos Fixos</span><span class="drill-val" style="color:var(--primary)" id="mm-fix">R$ 0,00</span></div>
            <div class="drill-row"><span>Gastos Vari√°veis</span><span class="drill-val" style="color:var(--warning)" id="mm-var">R$ 0,00</span></div>
            <div class="drill-row" style="border-top: 1px solid var(--color-border); margin-top: 8px; padding-top: 16px;">
                <span style="font-weight:700; color:white;">Saldo Final</span>
                <span class="drill-val" id="mm-saldo" style="font-size:18px;">R$ 0,00</span>
            </div>
        </div>

        <div class="drill-section" style="background: rgba(14,165,233,0.05); border-color: rgba(14,165,233,0.2);">
            <div style="font-size:11px; font-weight:800; color:var(--primary); text-transform:uppercase; letter-spacing:0.1em; margin-bottom:12px;">Projetado vs Realizado</div>
            <div class="drill-row"><span>Receita (Proj. vs Real)</span><span class="drill-val" id="mm-p-rec">R$ 0,00</span></div>
            <div class="drill-row"><span>Despesa (Proj. vs Real)</span><span class="drill-val" id="mm-p-desp">R$ 0,00</span></div>
        </div>
    </div>

    <div class="drawer-overlay" id="export-overlay" onclick="A.closeExportModal()"></div>
    <div class="modal-export" id="export-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3 class="font-title" style="font-size: 22px; color: white; display:flex; align-items:center; gap:10px;">
                <i data-lucide="file-down" style="color:var(--primary);"></i> Gerar Relat√≥rio
            </h3>
            <button class="btn-ghost" onclick="A.closeExportModal()" style="padding:8px;"><i data-lucide="x" width="16" height="16"></i></button>
        </div>
        <div class="form-group">
            <label class="form-label">Formato do Arquivo</label>
            <select id="exp-format" class="form-input">
                <option value="pdf">üìÑ Documento PDF (Leitura)</option>
                <option value="csv">üìä Tabela CSV (Excel / BI)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Per√≠odo de Refer√™ncia</label>
            <select id="exp-period" class="form-input">
                <option value="1">üìÖ M√™s Atual</option>
                <option value="3">üìÖ Trimestre (√öltimos 3 meses)</option>
                <option value="6">üìÖ Semestre (√öltimos 6 meses)</option>
                <option value="12">üìÖ Anual (Este Ano Inteiro)</option>
            </select>
        </div>
        <button class="form-save" onclick="A.runExport()">
            <i data-lucide="download" width="20" height="20"></i> Gerar e Baixar Arquivo
        </button>
    </div>

    <script>
        const DB = { 
            url: "https://urpuiznydrlwmaqhdids.supabase.co/rest/v1/painel_gastos?id=eq.1", 
            key: "sb_publishable_9G6JUKnfZ1mekk7qUKdTQA_TXbARtR0" 
        };
        const MONTHS = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        
        // NOVO PLANO DE CONTAS (Exig√™ncia do CFO - DRE Gerencial)
        const CATS = {
            entradas: [
                "Receita de Setup (Pontual)", 
                "Receita de Mensalidades (Recorrente)", 
                "Projetos Avulsos / Servi√ßos Pontuais", 
                "Outras Receitas"
            ],
            fixos: [
                "Contabilidade", 
                "Ferramentas (Google, Software, etc.)", 
                "Hospedagem / Infraestrutura", 
                "Pr√≥-labore", 
                "Taxas Banc√°rias Fixas", 
                "Outros Custos Fixos"
            ],
            unicos: [
                "Marketing (Tr√°fego, Campanhas)", 
                "Taxas de Meios de Pagamento", 
                "Freelancers por Projeto", 
                "Servi√ßos Terceirizados Pontuais", 
                "APIs e Consumo Vari√°vel", 
                "Impostos sobre Faturamento",
                "Gasto N√£o Previsto"
            ]
        };
        const RECOR_HINTS = { unico: "Lan√ßamento pontual, somente neste m√™s.", mensal: "Replica automaticamente para todos os 12 meses do ano selecionado.", proximo: "Replica a partir do m√™s da data informada at√© dezembro do mesmo ano." };

        const A = {
            state: { tab: 'overview', type: 'fixos', modo: 'despesa', pTipo: 'saida', data: { fixos: [], unicos: [], entradas: [], projecoes: { entradas: [], saidas: [] }, caixa_disponivel: 0 }, supportsEntradas: true },
            ch: { area: null, donut: null, dreBar: null, dreLine: null },

            init() {
                lucide.createIcons();
                const sel = document.getElementById('fMonth');
                MONTHS.forEach((m, i) => sel.innerHTML += `<option value="${i}">${m}</option>`);
                sel.value = new Date().getMonth();
                document.getElementById('lp').addEventListener('keypress', e => { if (e.key === 'Enter') A.login() });
                document.getElementById('lu').addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('lp').focus() });
                document.getElementById('f-data').value = new Date().toISOString().split('T')[0];
            },

            genId(prefix) { return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9); },

            login() {
                const u = document.getElementById('lu').value.trim().toLowerCase(), p = document.getElementById('lp').value, lc = document.getElementById('login-card');
                const btn = document.getElementById('btn-login');
                if ((u === 'bgtech' || u === 'gustavo' || u === 'gui') && p === 'admin2024') {
                    if(btn) btn.classList.add('loading');
                    lc.style.animation = 'none'; lc.style.transform = 'scale(1.05)'; lc.style.opacity = '0'; lc.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('app').classList.add('visible');
                        
                        if (u === 'gustavo') {
                            const msg = document.getElementById('msg-gustavo');
                            if (msg) msg.classList.add('active');
                            document.getElementById('main-content').style.paddingTop = '10px';
                        }

                        A.initCharts(); 
                        A.fetchSync(); 
                        setInterval(() => A.fetchSync(true), 15000);
                        lucide.createIcons();
                    }, 500);
                } else {
                    A.toast("Credenciais inv√°lidas.", "err"); lc.classList.remove('shake'); void lc.offsetWidth; lc.classList.add('shake');
                    document.getElementById('lp').value = ''; document.getElementById('lp').focus();
                }
            },

            tab(t) {
                A.state.tab = t;
                document.querySelectorAll('[data-tab]').forEach(b => { const a = b.dataset.tab === t; b.classList.toggle('active', a); });
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                const viewMap = { 'overview':'view-overview', 'dre':'view-dre', 'annual':'view-annual', 'entradas':'view-entradas', 'relatorios':'view-relatorios', 'projecoes':'view-projecoes', 'fixos':'view-list', 'unicos':'view-list' };
                document.getElementById(viewMap[t]).classList.add('active');
                
                const titles = {
                    overview: ['Painel Geral', 'Vis√£o executiva para decis√£o r√°pida'],
                    dre: ['DRE Gerencial', 'Intelig√™ncia Financeira (N√£o Fiscal)'],
                    annual: ['Balan√ßo Anual', 'Proje√ß√£o e realizado por m√™s'],
                    fixos: ['Custos Fixos', 'Despesas necess√°rias para a empresa existir'],
                    unicos: ['Gastos Vari√°veis', 'Custos atrelados a vendas e impostos'],
                    entradas: ['Receitas', 'Entradas de capital (Setup, Recorrente, Avulso)'],
                    relatorios: ['Exportar', 'Relat√≥rios oficiais da opera√ß√£o'],
                    projecoes: ['Proje√ß√µes Futuras', 'Simulador de cen√°rios de DRE e Caixa']
                };
                document.getElementById('page-title').textContent = titles[t][0];
                document.getElementById('page-sub').innerHTML = `<i data-lucide="activity" width="16" height="16"></i> ${titles[t][1]}`;
                
                const addLabel = document.getElementById('btn-add-label');
                const addBtn = document.getElementById('btn-add-main');
                const hGroup = document.getElementById('main-filters');

                if(t === 'projecoes') {
                    if(hGroup) hGroup.style.display = 'none';
                    addLabel.textContent = 'Nova Proje√ß√£o'; addBtn.className = 'btn-primary'; addBtn.style.display = ''; addBtn.onclick = () => A.openProjDrawer('saida');
                    A.renderProjecoes();
                } else if (t === 'relatorios') {
                    if(hGroup) hGroup.style.display = 'flex'; addBtn.style.display = 'none'; A.render();
                } else {
                    if(hGroup) hGroup.style.display = 'flex'; addBtn.style.display = '';
                    if (t === 'entradas') { addLabel.textContent = 'Nova Receita'; addBtn.className = 'btn-success'; addBtn.onclick = () => A.openDrawer(null, 'entrada'); }
                    else { addLabel.textContent = 'Novo Lan√ßamento'; addBtn.className = 'btn-primary'; addBtn.onclick = () => A.openDrawer(); }
                    A.render();
                }
                lucide.createIcons();
            },

            async fetchSync(silent = false) {
                if (!silent) A.syncUI('load');
                try {
                    const r = await fetch(DB.url, { headers: { apikey: DB.key, Authorization: `Bearer ${DB.key}`, 'Cache-Control': 'no-cache' } });
                    if (!r.ok) throw new Error("HTTP error");
                    const d = await r.json();
                    if (d && d[0]) {
                        A.state.data.fixos = Array.isArray(d[0].fixos) ? d[0].fixos : JSON.parse(d[0].fixos || '[]');
                        A.state.data.unicos = Array.isArray(d[0].unicos) ? d[0].unicos : JSON.parse(d[0].unicos || '[]');
                        A.state.data.entradas = Array.isArray(d[0].entradas) ? d[0].entradas : JSON.parse(d[0].entradas || '[]');
                        A.state.data.projecoes = typeof d[0].projecoes === 'string' ? JSON.parse(d[0].projecoes) : (d[0].projecoes || { entradas: [], saidas: [] });
                        A.state.data.caixa_disponivel = d[0].caixa_disponivel || 0;
                    }
                    A.syncUI('ok'); A.render();
                } catch (e) { 
                    A.syncUI('err'); 
                    if(!silent) A.toast("Trabalhando Offline. Banco inacess√≠vel.", "warning");
                }
            },

            async pushSync() {
                A.syncUI('load');
                try {
                    const payload = { 
                        fixos: A.state.data.fixos || [], 
                        unicos: A.state.data.unicos || [], 
                        entradas: A.state.data.entradas || [],
                        projecoes: A.state.data.projecoes || { entradas: [], saidas: [] },
                        caixa_disponivel: A.state.data.caixa_disponivel || 0,
                        updated_at: new Date().toISOString() 
                    };
                    const r = await fetch(DB.url, { method: 'PATCH', headers: { apikey: DB.key, Authorization: `Bearer ${DB.key}`, 'Content-Type': 'application/json', Prefer: 'return=minimal' }, body: JSON.stringify(payload) });
                    if (!r.ok) throw new Error("Falha ao salvar");
                    A.syncUI('ok');
                } catch (e) { A.syncUI('err'); A.toast("Erro ao salvar na Nuvem.", "warning"); }
            },

            syncUI(s) { const dot = document.getElementById('sync-dot'), txt = document.getElementById('sync-txt'), m = { load: ['var(--warning)', 'Sincronizando...'], ok: ['var(--success)', 'Nuvem Conectada'], err: ['var(--danger)', 'Modo Offline'] }; dot.style.background = m[s][0]; dot.style.boxShadow = `0 0 12px ${m[s][0]}`; txt.textContent = m[s][1]; },
            maskMoney(e) { let v = e.target.value.replace(/\D/g, ''); if (!v) { e.target.value = ''; return; } v = (parseInt(v) / 100).toFixed(2); e.target.value = v.replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); },
            cleanMoney(s) { return parseFloat((s || '0').replace(/\./g, '').replace(',', '.')) || 0; },
            fmtR(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); },
            fmtD(d) { if (!d) return '--'; const p = d.split('-'); return p.length === 3 ? `${p[2]}/${p[1]}` : d; },
            
            filterData(arr, mStr, yStr, isYTD = false) {
                return (arr||[]).filter(x => {
                    if(!x.data) return false;
                    const [y, m] = x.data.split('-');
                    if (y !== yStr) return false;
                    if (mStr === 'anual') return true;
                    if (isYTD) return parseInt(m) <= (parseInt(mStr) + 1);
                    return parseInt(m) === (parseInt(mStr) + 1);
                });
            },

            async editCaixa() {
                const atual = A.state.data.caixa_disponivel || 0;
                const input = prompt("Atualize o saldo banc√°rio da empresa (Caixa Dispon√≠vel em R$):", parseFloat(atual).toFixed(2));
                if(input !== null) {
                    const val = A.cleanMoney(input);
                    A.state.data.caixa_disponivel = val;
                    A.render();
                    await A.pushSync();
                }
            },

            trendHTML(curr, prev, invertColors = false) {
                if (!prev || prev === 0) return `<span class="trend-badge neutral">Sem hist√≥rico</span>`;
                const pct = ((curr - prev) / prev) * 100;
                let isGood = pct >= 0;
                if (invertColors) isGood = !isGood;
                return `<span class="trend-badge ${isGood ? 'up' : 'down'}"><i data-lucide="${pct >= 0 ? 'trending-up' : 'trending-down'}" width="12" height="12"></i> ${Math.abs(pct).toFixed(1)}%</span>`;
            },

            render() {
                if(A.state.tab === 'projecoes') return; 
                
                const mVal = document.getElementById('fMonth').value, yVal = document.getElementById('fYear').value, t = A.state.tab;
                
                const eM = A.filterData(A.state.data.entradas, mVal, yVal);
                const fM = A.filterData(A.state.data.fixos, mVal, yVal);
                const uM = A.filterData(A.state.data.unicos, mVal, yVal);

                let prevM = mVal, prevY = yVal;
                if(mVal !== 'anual') {
                    let calcM = parseInt(mVal) - 1;
                    if (calcM < 0) { calcM = 11; prevY = (parseInt(yVal) - 1).toString(); }
                    prevM = calcM.toString();
                } else {
                    prevY = (parseInt(yVal) - 1).toString();
                }
                const ePrev = A.filterData(A.state.data.entradas, prevM, prevY);
                const fPrev = A.filterData(A.state.data.fixos, prevM, prevY);
                const uPrev = A.filterData(A.state.data.unicos, prevM, prevY);

                const sumE = eM.reduce((a, b) => a + Number(b.valor), 0);
                const sumF = fM.reduce((a, b) => a + Number(b.valor), 0);
                const sumU = uM.reduce((a, b) => a + Number(b.valor), 0);
                const sumBurn = sumF + sumU; 
                
                const sumMRR = eM.filter(x => x.categoria.includes("Mensalidade") || x.recorrente === 'mensal').reduce((a, b) => a + Number(b.valor), 0);
                const sumImp = uM.filter(x => x.categoria.includes("Imposto")).reduce((a, b) => a + Number(b.valor), 0);
                const resLiq = sumE - sumBurn; 
                const margem = sumE > 0 ? ((resLiq / sumE) * 100).toFixed(1) : '0.0';

                const prevSumE = ePrev.reduce((a, b) => a + Number(b.valor), 0);
                const prevSumBurn = fPrev.reduce((a, b) => a + Number(b.valor), 0) + uPrev.reduce((a, b) => a + Number(b.valor), 0);
                const prevSumMRR = ePrev.filter(x => x.categoria.includes("Mensalidade") || x.recorrente === 'mensal').reduce((a, b) => a + Number(b.valor), 0);

                const caixaVal = A.state.data.caixa_disponivel || 0;
                const runway = sumBurn > 0 ? (caixaVal / sumBurn).toFixed(1) : '99+';

                if(t === 'overview') {
                    A.animateValue('v-caixa', caixaVal);
                    document.getElementById('v-runway').textContent = `${runway} Meses`;
                    
                    A.animateValue('v-receita-ov', sumE);
                    document.getElementById('t-receita-ov').innerHTML = A.trendHTML(sumE, prevSumE, false) + ' vs m√™s anterior';
                    
                    A.animateValue('v-mrr-ov', sumMRR);
                    document.getElementById('t-mrr-ov').innerHTML = A.trendHTML(sumMRR, prevSumMRR, false) + ' de Base Fixa';
                    
                    A.animateValue('v-burn-ov', sumBurn);
                    document.getElementById('t-burn-ov').innerHTML = A.trendHTML(sumBurn, prevSumBurn, true) + ' vs m√™s anterior';
                    
                    A.animateValue('v-fixos-ov', sumF); A.animateValue('v-var-ov', sumU);
                    
                    A.animateValue('v-res-liq', Math.abs(resLiq));
                    const elRes = document.getElementById('v-res-liq'), cardRes = document.getElementById('card-res-liq'), iconRes = document.getElementById('icon-res-liq'), subRes = document.getElementById('v-res-liq-sub');
                    
                    if (resLiq >= 0) {
                        elRes.textContent = '+ ' + A.fmtR(resLiq); elRes.style.color = 'var(--success)'; cardRes.className = 'card stat-card c-success'; iconRes.style.color = 'var(--success)';
                        subRes.innerHTML = `<span class="trend-badge up"><i data-lucide="check-circle" width="12" height="12"></i> Lucro: ${margem}%</span>`;
                    } else {
                        elRes.textContent = '- ' + A.fmtR(Math.abs(resLiq)); elRes.style.color = 'var(--danger)'; cardRes.className = 'card stat-card c-danger'; iconRes.style.color = 'var(--danger)';
                        subRes.innerHTML = `<span class="trend-badge down"><i data-lucide="alert-circle" width="12" height="12"></i> Preju√≠zo: ${margem}%</span>`;
                    }

                    const banner = document.getElementById('status-banner');
                    const rNum = parseFloat(runway);
                    if (rNum >= 3 && resLiq >= 0) {
                        banner.className = 'verde'; banner.innerHTML = `<i data-lucide="check-circle" width="20" height="20"></i><span><strong>Opera√ß√£o Saud√°vel:</strong> O caixa garante mais de 3 meses de Runway e o DRE gerou lucro no per√≠odo.</span>`;
                    } else if (rNum < 1 || (sumBurn > sumE && caixaVal < sumBurn)) {
                        banner.className = 'vermelho'; banner.innerHTML = `<i data-lucide="alert-octagon" width="20" height="20"></i><span><strong>Risco Cr√≠tico de Caixa:</strong> Sobreviv√™ncia inferior a 1 m√™s. Necess√°ria inje√ß√£o de capital ou corte dr√°stico imediato.</span>`;
                    } else {
                        banner.className = 'amarelo'; banner.innerHTML = `<i data-lucide="alert-triangle" width="20" height="20"></i><span><strong>Aten√ß√£o:</strong> Runway intermedi√°rio (${runway} meses) ou queima de caixa registrada no per√≠odo. Monitore de perto.</span>`;
                    }
                }

                if(t === 'dre') {
                    document.getElementById('dre-lbl-periodo').textContent = mVal === 'anual' ? `Ano ${yVal}` : `${MONTHS[mVal]} de ${yVal}`;
                    
                    const eYTD = A.filterData(A.state.data.entradas, mVal, yVal, true);
                    const fYTD = A.filterData(A.state.data.fixos, mVal, yVal, true);
                    const uYTD = A.filterData(A.state.data.unicos, mVal, yVal, true);

                    const calcRB = (arr) => {
                        const setup = arr.filter(x => x.categoria.includes("Setup")).reduce((a,b)=>a+Number(b.valor),0);
                        const mensal = arr.filter(x => x.categoria.includes("Mensalidade")).reduce((a,b)=>a+Number(b.valor),0);
                        const avulso = arr.filter(x => x.categoria.includes("Avulsos")).reduce((a,b)=>a+Number(b.valor),0);
                        const outros = arr.filter(x => x.categoria.includes("Outras")).reduce((a,b)=>a+Number(b.valor),0);
                        return { total: setup+mensal+avulso+outros, setup, mensal, avulso, outros };
                    };
                    const rbM = calcRB(eM); const rbYTD = calcRB(eYTD);

                    const calcCV = (arr) => {
                        const mkt = arr.filter(x => x.categoria.includes("Marketing")).reduce((a,b)=>a+Number(b.valor),0);
                        const taxas = arr.filter(x => x.categoria.includes("Pagamento")).reduce((a,b)=>a+Number(b.valor),0);
                        const freelas = arr.filter(x => x.categoria.includes("Freelancers") || x.categoria.includes("Terceirizados")).reduce((a,b)=>a+Number(b.valor),0);
                        const api = arr.filter(x => x.categoria.includes("APIs")).reduce((a,b)=>a+Number(b.valor),0);
                        const outros = arr.filter(x => x.categoria.includes("Gasto N√£o Previsto")).reduce((a,b)=>a+Number(b.valor),0);
                        return { total: mkt+taxas+freelas+api+outros, mkt, taxas, freelas, api, outros };
                    };
                    const cvM = calcCV(uM); const cvYTD = calcCV(uYTD);

                    const mbM = rbM.total - cvM.total; const mbYTD = rbYTD.total - cvYTD.total;
                    const cfM = fM.reduce((a,b)=>a+Number(b.valor),0); const cfYTD = fYTD.reduce((a,b)=>a+Number(b.valor),0);
                    const roM = mbM - cfM; const roYTD = mbYTD - cfYTD;
                    const impM = uM.filter(x => x.categoria.includes("Imposto")).reduce((a,b)=>a+Number(b.valor),0); const impYTD = uYTD.filter(x => x.categoria.includes("Imposto")).reduce((a,b)=>a+Number(b.valor),0);
                    const rlM = roM - impM; const rlYTD = roYTD - impYTD;

                    const pct = (val, base) => base > 0 ? ((val/base)*100).toFixed(1) + '%' : '0.0%';
                    const rowMain = (title, valM, valYTD, pM, pYTD, isNeg=false) => `
                        <tr class="dre-row-main">
                            <td>${title}</td>
                            <td class="dre-val ${isNeg ? (valM>0?'dre-negative':'') : (valM>0?'dre-positive':'dre-negative')}">${isNeg && valM>0?'-':''}R$ ${valM.toLocaleString('pt-BR', {minimumFractionDigits:2})} <span class="dre-pct">${pM}</span></td>
                            <td class="dre-val ${isNeg ? (valYTD>0?'dre-negative':'') : (valYTD>0?'dre-positive':'dre-negative')}">${isNeg && valYTD>0?'-':''}R$ ${valYTD.toLocaleString('pt-BR', {minimumFractionDigits:2})} <span class="dre-pct">${pYTD}</span></td>
                        </tr>`;
                    const rowSub = (title, valM, valYTD, baseM, baseYTD) => `
                        <tr class="dre-row-sub">
                            <td><div style="width:4px;height:4px;border-radius:50%;background:var(--text-dim);"></div> ${title}</td>
                            <td class="dre-val">R$ ${valM.toLocaleString('pt-BR', {minimumFractionDigits:2})} <span class="dre-pct">${pct(valM, baseM)}</span></td>
                            <td class="dre-val">R$ ${valYTD.toLocaleString('pt-BR', {minimumFractionDigits:2})} <span class="dre-pct">${pct(valYTD, baseYTD)}</span></td>
                        </tr>`;

                    let html = '';
                    html += rowMain("1. RECEITA BRUTA", rbM.total, rbYTD.total, "100%", "100%");
                    html += rowSub("Receita de Setup (Pontual)", rbM.setup, rbYTD.setup, rbM.total, rbYTD.total);
                    html += rowSub("Mensalidades (Recorrente)", rbM.mensal, rbYTD.mensal, rbM.total, rbYTD.total);
                    html += rowSub("Projetos Avulsos / Servi√ßos", rbM.avulso, rbYTD.avulso, rbM.total, rbYTD.total);
                    html += rowSub("Outras Receitas", rbM.outros, rbYTD.outros, rbM.total, rbYTD.total);
                    
                    html += rowMain("2. (-) CUSTOS VARI√ÅVEIS", cvM.total, cvYTD.total, pct(cvM.total, rbM.total), pct(cvYTD.total, rbYTD.total), true);
                    html += rowSub("Marketing e Tr√°fego", cvM.mkt, cvYTD.mkt, rbM.total, rbYTD.total);
                    html += rowSub("Taxas de Meios de Pagamento", cvM.taxas, cvYTD.taxas, rbM.total, rbYTD.total);
                    html += rowSub("Freelancers e Terceirizados", cvM.freelas, cvYTD.freelas, rbM.total, rbYTD.total);
                    html += rowSub("APIs e Consumo", cvM.api, cvYTD.api, rbM.total, rbYTD.total);
                    html += rowSub("Gasto N√£o Previsto", cvM.outros, cvYTD.outros, rbM.total, rbYTD.total);

                    html += rowMain("3. (=) MARGEM BRUTA", mbM, mbYTD, pct(mbM, rbM.total), pct(mbYTD, rbYTD.total));
                    html += rowMain("4. (-) CUSTOS FIXOS", cfM, cfYTD, pct(cfM, rbM.total), pct(cfYTD, rbYTD.total), true);
                    html += rowMain("5. (=) RESULTADO OPERACIONAL", roM, roYTD, pct(roM, rbM.total), pct(roYTD, rbYTD.total));
                    html += rowMain("6. (-) IMPOSTOS", impM, impYTD, pct(impM, rbM.total), pct(impYTD, rbYTD.total), true);

                    html += `<tr class="dre-row-main" style="background: rgba(14, 165, 233, 0.15); border-top: 2px solid var(--primary);">
                            <td style="color: white; font-size: 16px;">7. (=) RESULTADO L√çQUIDO FINAL</td>
                            <td class="dre-val ${rlM>=0?'dre-positive':'dre-negative'}" style="font-size: 18px;">R$ ${rlM.toLocaleString('pt-BR', {minimumFractionDigits:2})} <span class="dre-pct" style="color:white">${pct(rlM, rbM.total)}</span></td>
                            <td class="dre-val ${rlYTD>=0?'dre-positive':'dre-negative'}" style="font-size: 18px;">R$ ${rlYTD.toLocaleString('pt-BR', {minimumFractionDigits:2})} <span class="dre-pct" style="color:white">${pct(rlYTD, rbYTD.total)}</span></td>
                        </tr>`;

                    document.getElementById('dre-tbody').innerHTML = html;
                }

                if(t === 'entradas') {
                    A.animateValue('v-receita-total', sumE, false, 'var(--success)');
                    A.animateValue('v-receita-recor', sumMRR);
                    A.animateValue('v-receita-avulsa', sumE - sumMRR);
                    A.animateValue('v-saldo-entradas', resLiq);
                    const cardSaldoEnt = document.getElementById('card-saldo-ent');
                    const elSaldoEnt = document.getElementById('v-saldo-entradas');
                    if (cardSaldoEnt && elSaldoEnt) {
                        if (resLiq >= 0) { cardSaldoEnt.style.borderTopColor = 'var(--success)'; elSaldoEnt.style.color = 'var(--success)'; }
                        else { cardSaldoEnt.style.borderTopColor = 'var(--danger)'; elSaldoEnt.style.color = 'var(--danger)'; }
                    }
                }

                if (t === 'fixos') A.renderTable(fM, 'table-body', 'table-empty', 'gasto');
                if (t === 'unicos') A.renderTable(uM, 'table-body', 'table-empty', 'gasto');
                if (t === 'entradas') A.renderTable(eM, 'table-entradas', 'entradas-empty', 'entrada');
                if (t === 'annual') A.renderAnnual(yVal);
                
                A.updateCharts();
                lucide.createIcons();
            },

            animateValue(id, value, isInt = false, forceColor = null) {
                const el = document.getElementById(id); if (!el) return;
                const absVal = Math.abs(value);
                const start = parseFloat(el.textContent.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                const duration = 800, startTime = performance.now();
                if (forceColor) el.style.color = forceColor;
                const animate = (ct) => {
                    const elapsed = ct - startTime, progress = Math.min(elapsed / duration, 1), ep = 1 - Math.pow(1 - progress, 3);
                    const cur = Math.abs(start) + (absVal - Math.abs(start)) * ep;
                    el.textContent = isInt ? Math.round(cur) : (value < 0 ? '- ' + A.fmtR(cur) : A.fmtR(cur));
                    if (progress < 1) requestAnimationFrame(animate);
                    else el.textContent = isInt ? Math.round(value) : (value < 0 ? '- ' + A.fmtR(absVal) : A.fmtR(absVal));
                };
                requestAnimationFrame(animate);
            },

            renderTable(list, tbodyId, emptyId, tipo) {
                const searchQ = (document.getElementById(tipo === 'entrada' ? 'search-entradas' : 'search-gastos')?.value || '').toLowerCase();
                const filtered = list.filter(i => (i.nome||'').toLowerCase().includes(searchQ) || (i.categoria||'').toLowerCase().includes(searchQ));
                
                const sorted = [...filtered].sort((a, b) => (b.data || '').localeCompare(a.data || ''));
                const tbody = document.getElementById(tbodyId), empty = document.getElementById(emptyId);
                if (sorted.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; }
                else {
                    empty.style.display = 'none';
                    const isIncome = tipo === 'entrada';
                    tbody.innerHTML = sorted.map((i, idx) => {
                        const isPend = i.status === 'Pendente', isRecur = i.recorrente === 'mensal' || i.recorrente === 'proximo';
                        return `<tr style="animation:fadeInUp 0.5s ease ${idx * 50}ms both;">
          <td style="color:var(--text-muted);font-size:13px;font-weight:600;white-space:nowrap">${A.fmtD(i.data)}</td>
          <td><div class="item-name">${esc(i.nome)}</div>${i.descricao ? `<div class="item-desc">${esc(i.descricao)}</div>` : ''}</td>
          <td><span class="cat-badge${isIncome ? ' income' : ''}">${esc(i.categoria || '‚Äî')}</span></td>
          <td><span class="recur-badge ${isRecur ? 'sim' : 'nao'}">${isRecur ? 'üîÑ Mensal' : '√önico'}</span></td>
          <td><span class="status-badge ${isPend ? 'pendente' : 'pago'}">${isPend ? '‚è≥ Pendente' : '‚úÖ ' + (isIncome ? 'Recebido' : 'Pago')}</span></td>
          <td class="amount-cell font-title" style="color:${isIncome ? 'var(--success)' : (isPend ? 'var(--text-muted)' : 'var(--text)')}">${isIncome ? '+ ' : ''}${A.fmtR(i.valor)}</td>
          <td style="text-align:center;white-space:nowrap">
            <button class="action-btn" onclick="A.edit('${i.id}')" title="Editar"><i data-lucide="edit-2" width="16" height="16"></i></button>
            <button class="action-btn del" onclick="A.del('${i.id}')" title="Excluir"><i data-lucide="trash-2" width="16" height="16"></i></button>
          </td></tr>`;
                    }).join('');
                    lucide.createIcons();
                }
            },

            // ==========================================
            // ABA BALAN√áO ANUAL E MODAL DRILL DOWN
            // ==========================================
            renderAnnual(year) {
                document.getElementById('annual-title').textContent = `Balan√ßo Anual ${year}`;
                const grid = document.getElementById('annual-grid'), now = new Date();
                let allIn = [], allOut = [];
                for (let m = 0; m < 12; m++) {
                    allIn.push(A.filterData(A.state.data.entradas, m.toString(), year).reduce((a, b) => a + Number(b.valor), 0));
                    allOut.push(A.filterData(A.state.data.fixos, m.toString(), year).reduce((a, b) => a + Number(b.valor), 0) + A.filterData(A.state.data.unicos, m.toString(), year).reduce((a, b) => a + Number(b.valor), 0));
                }
                const yearIn = allIn.reduce((a, b) => a + b, 0);
                const yearOut = allOut.reduce((a, b) => a + b, 0);
                const yearSaldo = yearIn - yearOut;
                
                document.getElementById('annual-total-in').textContent = A.fmtR(yearIn);
                document.getElementById('annual-total-out').textContent = A.fmtR(yearOut);
                const elSaldo = document.getElementById('annual-saldo');
                elSaldo.textContent = A.fmtR(yearSaldo); elSaldo.style.color = yearSaldo >= 0 ? 'var(--success)' : 'var(--danger)';
                
                const maxVal = Math.max(...allIn, ...allOut, 1);
                grid.innerHTML = MONTHS.map((name, m) => {
                    const inv = allIn[m], outv = allOut[m], saldo = inv - outv;
                    const isCur = m === now.getMonth() && year === now.getFullYear().toString();
                    const pctIn = Math.round((inv / maxVal) * 100) || 0;
                    const pctOut = Math.round((outv / maxVal) * 100) || 0;
                    return `<div class="month-tile${isCur ? ' current' : ''}" onclick="A.openMonthModal(${m},'${year}')" style="animation:fadeInUp 0.5s ease ${m * 50}ms both;">
        <div class="month-tile-name">${name}${isCur ? ' <span style="font-size:11px;color:var(--primary);font-weight:800;">‚óè ATUAL</span>' : ''}</div>
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
          <div style="color:var(--success);font-weight:800;font-size:13px;">+ ${A.fmtR(inv)}</div>
          <div style="color:var(--danger);font-weight:800;font-size:13px;">- ${A.fmtR(outv)}</div>
        </div>
        <div style="height:5px;background:rgba(255,255,255,0.05);border-radius:3px;display:flex;overflow:hidden;margin-bottom:10px;">
          <div style="background:var(--success);width:${pctIn}%;border-radius:3px 0 0 3px;transition:width 0.8s var(--transition);"></div>
          <div style="background:var(--danger);width:${pctOut}%;border-radius:0 3px 3px 0;transition:width 0.8s var(--transition);"></div>
        </div>
        <div style="font-size:12px;text-align:right;font-weight:800;color:${saldo >= 0 ? 'var(--success)' : 'var(--danger)'}">
          Saldo: ${saldo >= 0 ? '+' : ''}${A.fmtR(saldo)}
        </div>
      </div>`;
                }).join('');
            },

            openMonthModal(m, y) {
                document.getElementById('mm-title').textContent = `Resumo Gerencial - ${MONTHS[m]} ${y}`;
                
                // Dados Realizados
                const mStr = m.toString();
                const totalE = A.filterData(A.state.data.entradas, mStr, y).reduce((a,b)=>a+Number(b.valor),0);
                const totalF = A.filterData(A.state.data.fixos, mStr, y).reduce((a,b)=>a+Number(b.valor),0);
                const totalV = A.filterData(A.state.data.unicos, mStr, y).reduce((a,b)=>a+Number(b.valor),0);
                const saldo = totalE - totalF - totalV;

                document.getElementById('mm-rec').textContent = '+ R$ ' + A.fmtR(totalE);
                document.getElementById('mm-fix').textContent = '- R$ ' + A.fmtR(totalF);
                document.getElementById('mm-var').textContent = '- R$ ' + A.fmtR(totalV);
                
                const elSaldo = document.getElementById('mm-saldo');
                elSaldo.textContent = (saldo >= 0 ? '+ ' : '- ') + 'R$ ' + A.fmtR(Math.abs(saldo));
                elSaldo.style.color = saldo >= 0 ? 'var(--success)' : 'var(--danger)';

                // Dados Projetados (Simulador)
                const mesProjStr = `${y}-${String(m+1).padStart(2, '0')}`;
                const projE = (A.state.data.projecoes.entradas || []).filter(p => p.mes === mesProjStr).reduce((a,b)=>a+Number(b.valor),0);
                const projS = (A.state.data.projecoes.saidas || []).filter(p => p.mes === mesProjStr).reduce((a,b)=>a+Number(b.valor),0);

                const diffE = totalE - projE;
                const diffS = (totalF + totalV) - projS;

                document.getElementById('mm-p-rec').innerHTML = `R$ ${A.fmtR(projE)} <span style="font-size:11px; margin-left:8px; color:${diffE >= 0 ? 'var(--success)' : 'var(--danger)'}">(${diffE >= 0 ? '+' : ''}${A.fmtR(diffE)})</span>`;
                document.getElementById('mm-p-desp').innerHTML = `R$ ${A.fmtR(projS)} <span style="font-size:11px; margin-left:8px; color:${diffS <= 0 ? 'var(--success)' : 'var(--danger)'}">(${diffS > 0 ? '+' : ''}${A.fmtR(diffS)})</span>`;

                document.getElementById('month-modal').classList.add('open');
                document.getElementById('month-overlay').classList.add('open');
            },

            closeMonthModal() {
                document.getElementById('month-modal').classList.remove('open');
                document.getElementById('month-overlay').classList.remove('open');
            },

            initCharts() {
                const base = { chart: { background: 'transparent', fontFamily: 'Inter', toolbar: { show: false }, animations: { enabled: true, speed: 800, easing: 'easeinout' } }, theme: { mode: 'dark' } };
                
                A.ch.area = new ApexCharts(document.querySelector('#chart-area'), {
                    ...base, series: [{ name: 'Receitas', data: [] }, { name: 'Burn Rate (Despesas)', data: [] }],
                    chart: { ...base.chart, type: 'area', height: 280 }, colors: ['#10b981', '#ef4444'],
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.05, stops: [0, 90, 100] } },
                    stroke: { curve: 'smooth', width: 3 }, dataLabels: { enabled: false },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4, xaxis: { lines: { show: false } } },
                    xaxis: { categories: [], labels: { style: { colors: '#94a3b8', fontSize: '13px', fontWeight: 600 } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { labels: { style: { colors: '#94a3b8', fontSize: '12px' }, formatter: v => `R$${(v / 1000).toFixed(0)}k` } },
                    legend: { labels: { colors: '#94a3b8' }, fontWeight: 600 }, tooltip: { theme: 'dark', x: { show: true }, y: { formatter: v => A.fmtR(v) } }
                });
                
                A.ch.donut = new ApexCharts(document.querySelector('#chart-donut'), { 
                    ...base, series: [], labels: [], chart: { ...base.chart, type: 'donut', height: 280 }, 
                    colors: ['#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd', '#0284c7', '#0369a1'], stroke: { show: true, colors: ['#0d1117'], width: 3 }, 
                    dataLabels: { enabled: false }, legend: { position: 'bottom', labels: { colors: '#94a3b8' }, fontSize: '13px', fontWeight: 600 }, 
                    plotOptions: { pie: { donut: { size: '75%', labels: { show: true, name: { color: '#94a3b8', fontSize: '14px', fontWeight: 600 }, value: { color: 'white', fontSize: '24px', fontWeight: 900, formatter: v => A.fmtR(v) }, total: { show: true, label: 'Total Fixos', color: '#94a3b8', fontSize: '14px', fontWeight: 600, formatter: w => A.fmtR(w.globals.seriesTotals.reduce((a, b) => a + b, 0)) } } } } }, tooltip: { theme: 'dark', y: { formatter: v => A.fmtR(v) } } 
                });

                A.ch.dreBar = new ApexCharts(document.querySelector('#chart-dre-bar'), {
                    ...base, series: [], chart: { ...base.chart, type: 'bar', height: 280, stacked: false },
                    colors: ['#10b981', '#f59e0b', '#ef4444'], plotOptions: { bar: { borderRadius: 4, columnWidth: '60%' } },
                    dataLabels: { enabled: false }, stroke: { show: true, width: 2, colors: ['transparent'] },
                    xaxis: { categories: [], labels: { style: { colors: '#94a3b8', fontWeight: 600 } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { labels: { style: { colors: '#94a3b8' }, formatter: v => `R$${(v / 1000).toFixed(0)}k` } },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 }, legend: { position: 'top', horizontalAlign: 'right' },
                    tooltip: { theme: 'dark', y: { formatter: v => A.fmtR(v) } }
                });

                A.ch.dreLine = new ApexCharts(document.querySelector('#chart-dre-line'), {
                    ...base, series: [], chart: { ...base.chart, type: 'area', height: 280 },
                    colors: ['#0ea5e9'], stroke: { curve: 'smooth', width: 3 },
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.05, stops: [0, 90, 100] } },
                    dataLabels: { enabled: false }, markers: { size: 4, colors: ['#0ea5e9'], strokeColors: '#0d1117', strokeWidth: 2 },
                    xaxis: { categories: [], labels: { style: { colors: '#94a3b8', fontWeight: 600 } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { labels: { style: { colors: '#94a3b8' }, formatter: v => `R$${(v / 1000).toFixed(0)}k` } },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
                    tooltip: { theme: 'dark', y: { formatter: v => A.fmtR(v) } }
                });

                A.ch.area.render(); A.ch.donut.render(); A.ch.dreBar.render(); A.ch.dreLine.render();
            },

            updateCharts() {
                const aRec = [], aDesp = [], aCats = [];
                const dreRB = [], dreCV = [], dreCF = [], dreRL = [];

                for (let i = 5; i >= 0; i--) {
                    const d = new Date(); d.setMonth(d.getMonth() - i);
                    const mStr = d.getMonth().toString(), yStr = d.getFullYear().toString();
                    
                    const e = A.filterData(A.state.data.entradas, mStr, yStr).reduce((a, b) => a + Number(b.valor), 0);
                    const f = A.filterData(A.state.data.fixos, mStr, yStr).reduce((a, b) => a + Number(b.valor), 0);
                    const uArr = A.filterData(A.state.data.unicos, mStr, yStr);
                    const varTot = uArr.filter(x => !x.categoria.includes("Imposto")).reduce((a, b) => a + Number(b.valor), 0);
                    const impTot = uArr.filter(x => x.categoria.includes("Imposto")).reduce((a, b) => a + Number(b.valor), 0);
                    
                    const totalSaidas = f + varTot + impTot;
                    
                    aRec.push(e); 
                    aDesp.push(totalSaidas);
                    aCats.push(MONTHS[d.getMonth()].substring(0, 3));

                    dreRB.push(e);
                    dreCV.push(varTot);
                    dreCF.push(f);
                    dreRL.push(e - totalSaidas);
                }

                if (A.ch.area) {
                    A.ch.area.updateSeries([{ name: 'Receita Bruta', data: aRec }, { name: 'Burn Rate (Despesas)', data: aDesp }]);
                    A.ch.area.updateOptions({ xaxis: { categories: aCats } });
                }

                if (A.ch.dreBar) {
                    A.ch.dreBar.updateSeries([{ name: 'Receita Bruta', data: dreRB }, { name: 'Custos Vari√°veis', data: dreCV }, { name: 'Custo Fixo', data: dreCF }]);
                    A.ch.dreBar.updateOptions({ xaxis: { categories: aCats } });
                }

                if (A.ch.dreLine) {
                    A.ch.dreLine.updateSeries([{ name: 'Resultado L√≠quido', data: dreRL }]);
                    A.ch.dreLine.updateOptions({ xaxis: { categories: aCats } });
                }

                const mVal = document.getElementById('fMonth').value, yVal = document.getElementById('fYear').value;
                const curFixos = A.filterData(A.state.data.fixos, mVal, yVal);
                const catMap = {}; curFixos.forEach(x => { catMap[x.categoria] = (catMap[x.categoria] || 0) + Number(x.valor); });
                const labels = Object.keys(catMap), series = Object.values(catMap);
                
                if (A.ch.donut) {
                    if (series.length > 0) { A.ch.donut.updateOptions({ labels }); A.ch.donut.updateSeries(series); }
                    else { A.ch.donut.updateSeries([1]); A.ch.donut.updateOptions({ labels: ['Sem dados'], colors: ['#1e293b'] }); }
                }
            },

            setModo(modo) {
                A.state.modo = modo;
                document.getElementById('tab-modo-despesa').classList.toggle('active', modo === 'despesa');
                document.getElementById('tab-modo-entrada').classList.toggle('active', modo === 'entrada');
                const subTabs = document.getElementById('sub-type-tabs');
                const lblNome = document.getElementById('lbl-nome');
                const lblStatus = document.getElementById('lbl-status');
                const saveBtn = document.getElementById('btn-save');
                if (modo === 'entrada') {
                    subTabs.style.display = 'none';
                    lblNome.textContent = 'De onde vem a receita? (Cliente/Produto) *';
                    lblStatus.textContent = 'Status de Fluxo de Caixa';
                    saveBtn.className = 'form-save save-income';
                    saveBtn.innerHTML = '<i data-lucide="save" width="20" height="20"></i> Salvar Receita';
                    document.getElementById('drawer-title').textContent = 'Nova Receita';
                    const sel = document.getElementById('f-cat'); sel.innerHTML = '';
                    CATS.entradas.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                } else {
                    subTabs.style.display = 'flex';
                    lblNome.textContent = 'O que est√° sendo pago? (Fornecedor/Servi√ßo) *';
                    lblStatus.textContent = 'Status de Fluxo de Caixa';
                    saveBtn.className = 'form-save';
                    saveBtn.innerHTML = '<i data-lucide="save" width="20" height="20"></i> Salvar Registro';
                    document.getElementById('drawer-title').textContent = 'Novo Lan√ßamento';
                    A.setType(A.state.type);
                }
                lucide.createIcons();
            },

            openDrawer(item = null, modo = null) {
                document.getElementById('drawer').classList.add('open'); document.getElementById('overlay').classList.add('open');
                if (item) {
                    const isEntrada = (A.state.data.entradas||[]).some(i => i.id === item.id);
                    const isFixo = (A.state.data.fixos||[]).some(i => i.id === item.id);
                    A.setModo(isEntrada ? 'entrada' : 'despesa');
                    if (!isEntrada) A.setType(isFixo ? 'fixos' : 'unicos');
                    document.getElementById('drawer-title').textContent = isEntrada ? 'Editar Receita' : 'Editar Lan√ßamento';
                    document.getElementById('f-id').value = item.id;
                    document.getElementById('f-nome').value = item.nome;
                    document.getElementById('f-valor').value = A.fmtR(item.valor).replace('R$\u00a0', '').replace('R$', '').trim();
                    document.getElementById('f-data').value = item.data || '';
                    document.getElementById('f-cat').value = item.categoria || '';
                    document.getElementById('f-status').value = item.status || 'Pago';
                    document.getElementById('f-desc').value = item.descricao || '';
                    document.getElementById('f-recor').value = item.recorrente || 'unico';
                    A.onRecorChange();
                } else {
                    A.setModo(modo || 'despesa');
                    const defType = A.state.tab === 'unicos' ? 'unicos' : 'fixos';
                    if (A.state.modo === 'despesa') A.setType(defType);
                    document.getElementById('f-id').value = ''; document.getElementById('f-nome').value = '';
                    document.getElementById('f-valor').value = ''; document.getElementById('f-data').value = new Date().toISOString().split('T')[0];
                    document.getElementById('f-status').value = 'Pago'; document.getElementById('f-desc').value = '';
                    document.getElementById('f-recor').value = 'unico'; A.onRecorChange();
                }
                setTimeout(() => document.getElementById('f-nome').focus(), 100); lucide.createIcons();
            },

            closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('overlay').classList.remove('open'); },

            setType(t) {
                A.state.type = t;
                document.getElementById('tab-fixos').classList.toggle('active', t === 'fixos');
                document.getElementById('tab-unicos').classList.toggle('active', t === 'unicos');
                const sel = document.getElementById('f-cat'); sel.innerHTML = '';
                CATS[t].forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            },

            onRecorChange() { const v = document.getElementById('f-recor').value; document.getElementById('recor-hint').innerHTML = `<i data-lucide="info" width="14" height="14"></i> ${RECOR_HINTS[v] || ''}`; lucide.createIcons(); },

            async save() {
                const btn = document.getElementById('btn-save');
                if(btn.classList.contains('loading')) return; 

                const nome = document.getElementById('f-nome').value.trim(), valor = A.cleanMoney(document.getElementById('f-valor').value);
                if (!nome || valor <= 0) { A.toast("Preencha nome e valor v√°lido.", "err"); document.getElementById('f-nome').focus(); return; }
                
                btn.classList.add('loading');
                try {
                    const dataBase = document.getElementById('f-data').value, recorrente = document.getElementById('f-recor').value, editId = document.getElementById('f-id').value;
                    const base = { id: editId || A.genId('bgt'), nome, valor, data: dataBase, categoria: document.getElementById('f-cat').value, status: document.getElementById('f-status').value, descricao: document.getElementById('f-desc').value.trim(), recorrente };
                    const isIncome = A.state.modo === 'entrada';
                    const arrKey = isIncome ? 'entradas' : A.state.type;
                    const arr = A.state.data[arrKey] || [];
                    
                    if (editId) {
                        ['fixos', 'unicos', 'entradas'].forEach(k => { A.state.data[k] = (A.state.data[k]||[]).filter(i => i.id !== editId); });
                        arr.push(base);
                    } else {
                        if (recorrente === 'mensal') {
                            const [y, , d] = dataBase.split('-');
                            for (let m = 0; m < 12; m++) arr.push({ ...base, id: A.genId('bgt'), data: `${y}-${String(m + 1).padStart(2, '0')}-${d}` });
                            A.toast(`12 ${isIncome ? 'receitas' : 'lan√ßamentos'} mensais criados! ‚ú®`);
                        } else if (recorrente === 'proximo') {
                            const [y, mo, d] = dataBase.split('-'); const startM = parseInt(mo) - 1; let count = 0;
                            for (let m = startM; m < 12; m++) { arr.push({ ...base, id: A.genId('bgt'), data: `${y}-${String(m + 1).padStart(2, '0')}-${d}` }); count++; }
                            A.toast(`${count} ${isIncome ? 'receitas' : 'lan√ßamentos'} criados! ‚ú®`);
                        } else {
                            arr.push(base);
                            A.toast(`${isIncome ? 'Receita registrada' : 'Lan√ßamento salvo'} com sucesso! ‚úÖ`);
                        }
                    }
                    
                    A.state.data[arrKey] = arr;
                    A.closeDrawer(); 
                    A.render(); 
                    await A.pushSync();
                } finally {
                    btn.classList.remove('loading');
                }
            },

            edit(id) { const item = (A.state.data.fixos||[]).find(i => i.id === id) || (A.state.data.unicos||[]).find(i => i.id === id) || (A.state.data.entradas||[]).find(i => i.id === id); if (item) A.openDrawer(item); },

            del(id) {
                if (confirm("Excluir permanentemente este registro da base?")) {
                    A.state.data.fixos = A.state.data.fixos.filter(i => i.id !== id);
                    A.state.data.unicos = A.state.data.unicos.filter(i => i.id !== id);
                    A.state.data.entradas = A.state.data.entradas.filter(i => i.id !== id);
                    A.render(); A.pushSync(); A.toast("Registro exclu√≠do. üóëÔ∏è");
                }
            },

            onReportTipoChange() {
                const tipo = document.getElementById('report-tipo').value;
                const sel = document.getElementById('report-period'); sel.innerHTML = '';
                if (tipo === 'mensal') MONTHS.forEach((m, i) => sel.innerHTML += `<option value="${i}">${m}</option>`);
                else if (tipo === 'trimestral') ['1¬∞ Trimestre (Jan-Mar)', '2¬∞ Trimestre (Abr-Jun)', '3¬∞ Trimestre (Jul-Set)', '4¬∞ Trimestre (Out-Dez)'].forEach((q, i) => sel.innerHTML += `<option value="${i}">${q}</option>`);
                else['1¬∞ Semestre (Jan-Jun)', '2¬∞ Semestre (Jul-Dez)'].forEach((s, i) => sel.innerHTML += `<option value="${i}">${s}</option>`);
                const curMonth = new Date().getMonth();
                if (tipo === 'mensal') sel.value = curMonth;
                else if (tipo === 'trimestral') sel.value = Math.floor(curMonth / 3);
                else sel.value = curMonth < 6 ? 0 : 1;
                A.renderRelatorios();
            },

            getReportRange() {
                const tipo = document.getElementById('report-tipo').value, period = parseInt(document.getElementById('report-period').value), year = parseInt(document.getElementById('report-year').value);
                let sm, em, label;
                if (tipo === 'mensal') { sm = em = period; label = `${MONTHS[period]} ${year}`; }
                else if (tipo === 'trimestral') { sm = period * 3; em = sm + 2; label = `${period + 1}¬∞ Trimestre ${year}`; }
                else { sm = period * 6; em = sm + 5; label = `${period + 1}¬∞ Semestre ${year}`; }
                return { sm, em, year, label };
            },

            renderRelatorios() {
                const { sm, em, year, label } = A.getReportRange();
                
                let entradas = [], fixos = [], unicos = [];
                for(let m = sm; m <= em; m++){
                    entradas = entradas.concat(A.filterData(A.state.data.entradas, m.toString(), year.toString()));
                    fixos = fixos.concat(A.filterData(A.state.data.fixos, m.toString(), year.toString()));
                    unicos = unicos.concat(A.filterData(A.state.data.unicos, m.toString(), year.toString()));
                }

                const totalE = entradas.reduce((a, b) => a + Number(b.valor), 0);
                const totalS = fixos.reduce((a, b) => a + Number(b.valor), 0) + unicos.reduce((a, b) => a + Number(b.valor), 0);
                const saldo = totalE - totalS; const totalMov = totalE + totalS;
                
                document.getElementById('report-kpis').innerHTML = `
      <div class="report-kpi"><div class="report-kpi-label">Total Movimentado</div><div class="report-kpi-value" style="color:var(--text)">${A.fmtR(totalMov)}</div></div>
      <div class="report-kpi"><div class="report-kpi-label">Total Receitas</div><div class="report-kpi-value positive">${A.fmtR(totalE)}</div></div>
      <div class="report-kpi"><div class="report-kpi-label">Total Custos</div><div class="report-kpi-value negative">${A.fmtR(totalS)}</div></div>
      <div class="report-kpi"><div class="report-kpi-label">Resultado L√≠quido</div><div class="report-kpi-value ${saldo >= 0 ? 'positive' : 'negative'}">${A.fmtR(saldo)}</div></div>`;
                
                const catMap = {};
                entradas.forEach(x => { const k = 'üì• ' + x.categoria; catMap[k] = (catMap[k] || { sum: 0, type: 'income' }); catMap[k].sum += Number(x.valor); });
                fixos.concat(unicos).forEach(x => { const k = 'üì§ ' + x.categoria; catMap[k] = (catMap[k] || { sum: 0, type: 'expense' }); catMap[k].sum += Number(x.valor); });
                const maxCat = Math.max(...Object.values(catMap).map(v => v.sum), 1);
                const catsEl = document.getElementById('report-cats');
                const sortedCats = Object.entries(catMap).sort((a, b) => b[1].sum - a[1].sum);
                if (sortedCats.length === 0) { catsEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);">Nenhum dado no per√≠odo selecionado</div>'; }
                else {
                    catsEl.innerHTML = sortedCats.map(([name, { sum, type }]) => {
                        const pct = Math.round((sum / maxCat) * 100);
                        return `<div class="report-cat-item">
        <div class="report-cat-name">${name}</div>
        <div class="report-cat-bar-wrap"><div class="report-cat-bar ${type}" style="width:${pct}%"></div></div>
        <div class="report-cat-val" style="color:${type === 'income' ? 'var(--success)' : 'var(--danger)'}">${A.fmtR(sum)}</div>
      </div>`;
                    }).join('');
                }
                lucide.createIcons();
            },

            loadProjecoes() {
                // Legado: As proje√ß√µes agora v√™m do Supabase via fetchSync. Isso aqui √© s√≥ fallback de seguran√ßa.
                if(!A.state.data.projecoes) A.state.data.projecoes = { entradas: [], saidas: [] };
            },

            setProjType(t) {
                A.state.pTipo = t;
                document.getElementById('ptab-entrada').classList.toggle('active', t === 'entrada');
                document.getElementById('ptab-saida').classList.toggle('active', t === 'saida');
                const sel = document.getElementById('pf-cat');
                sel.innerHTML = '';
                const cats = t === 'entrada' ? CATS.entradas : [...CATS.fixos, ...CATS.unicos];
                cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                
                const btn = document.getElementById('btn-proj-save');
                if(t === 'entrada') {
                    btn.className = 'form-save save-income';
                } else {
                    btn.className = 'form-save';
                    btn.style.background = 'linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%)';
                    btn.style.boxShadow = '0 6px 30px var(--danger-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
                }
            },

            openProjDrawer(tipo, id = null) {
                document.getElementById('proj-drawer').classList.add('open'); 
                document.getElementById('proj-overlay').classList.add('open');
                
                if (id) {
                    const item = A.state.data.projecoes[tipo+'s'].find(i => i.id === id);
                    if(!item) return;
                    A.setProjType(tipo);
                    document.getElementById('proj-drawer-title').textContent = 'Editar Proje√ß√£o';
                    document.getElementById('pf-id').value = item.id;
                    document.getElementById('pf-nome').value = item.nome;
                    document.getElementById('pf-valor').value = A.fmtR(item.valor).replace('R$\u00a0', '').replace('R$', '').trim();
                    document.getElementById('pf-mes').value = item.mes;
                    document.getElementById('pf-cat').value = item.categoria || '';
                    document.getElementById('pf-status').value = item.status || 'Previsto';
                    document.getElementById('pf-desc').value = item.descricao || '';
                } else {
                    A.setProjType(tipo || 'saida');
                    document.getElementById('proj-drawer-title').textContent = 'Nova Proje√ß√£o';
                    document.getElementById('pf-id').value = '';
                    document.getElementById('pf-nome').value = '';
                    document.getElementById('pf-valor').value = '';
                    const now = new Date();
                    document.getElementById('pf-mes').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    document.getElementById('pf-status').value = 'Previsto';
                    document.getElementById('pf-desc').value = '';
                }
                setTimeout(() => document.getElementById('pf-nome').focus(), 100); 
                lucide.createIcons();
            },

            closeProjDrawer() {
                document.getElementById('proj-drawer').classList.remove('open'); 
                document.getElementById('proj-overlay').classList.remove('open');
            },

            async saveProj() {
                const btn = document.getElementById('btn-proj-save');
                if(btn.classList.contains('loading')) return;
                
                const nome = document.getElementById('pf-nome').value.trim();
                const valor = A.cleanMoney(document.getElementById('pf-valor').value);
                if (!nome || valor <= 0) { A.toast("Preencha descri√ß√£o e valor.", "err"); document.getElementById('pf-nome').focus(); return; }

                const mes = document.getElementById('pf-mes').value; 
                if(!mes) return A.toast("M√™s/Compet√™ncia √© obrigat√≥rio.", "err");

                btn.classList.add('loading');
                
                try {
                    const tipo = A.state.pTipo; 
                    const id = document.getElementById('pf-id').value || A.genId('proj');

                    const base = {
                        id, nome, valor, mes,
                        categoria: document.getElementById('pf-cat').value,
                        status: document.getElementById('pf-status').value,
                        descricao: document.getElementById('pf-desc').value.trim(),
                        created_at: new Date().toISOString()
                    };

                    const arrKey = tipo + 's'; 
                    if(!A.state.data.projecoes) A.state.data.projecoes = {entradas:[], saidas:[]};
                    
                    A.state.data.projecoes.entradas = (A.state.data.projecoes.entradas||[]).filter(x => x.id !== id);
                    A.state.data.projecoes.saidas = (A.state.data.projecoes.saidas||[]).filter(x => x.id !== id);
                    A.state.data.projecoes[arrKey].push(base);

                    A.closeProjDrawer();
                    A.renderProjecoes();
                    await A.pushSync(); // Salva na NUVEM agora
                    A.toast("Proje√ß√£o salva na nuvem e no simulador! üîÆ");
                } finally {
                    btn.classList.remove('loading');
                }
            },

            async delProj(tipo, id) {
                if (confirm("Excluir permanentemente esta proje√ß√£o da nuvem?")) {
                    A.state.data.projecoes.entradas = (A.state.data.projecoes.entradas||[]).filter(x => x.id !== id);
                    A.state.data.projecoes.saidas = (A.state.data.projecoes.saidas||[]).filter(x => x.id !== id);
                    A.renderProjecoes();
                    await A.pushSync(); // Salva na Nuvem
                    A.toast("Proje√ß√£o removida da nuvem. üóëÔ∏è");
                }
            },

            renderProjecoes() {
                const horizon = parseInt(document.getElementById('p-horizonte').value);
                const monthFilter = document.getElementById('p-mes-filter');
                const prevSelected = monthFilter.value;
                
                const now = new Date();
                const curY = now.getFullYear();
                const curM = now.getMonth() + 1; 
                const toAbs = (y, m) => y * 12 + m;
                const absNow = toAbs(curY, curM);
                const absEnd = absNow + horizon - 1;

                monthFilter.innerHTML = '<option value="all">Todos os meses do horizonte</option>';
                for(let i=0; i<horizon; i++) {
                   let targetAbs = absNow + i;
                   let ty = Math.floor((targetAbs - 1) / 12);
                   let tm = ((targetAbs - 1) % 12) + 1;
                   let str = `${ty}-${String(tm).padStart(2,'0')}`;
                   let label = `${MONTHS[tm-1]} ${ty}`;
                   monthFilter.innerHTML += `<option value="${str}">${label}</option>`;
                }
                if([...monthFilter.options].some(o => o.value === prevSelected)) monthFilter.value = prevSelected;

                const proj = A.state.data.projecoes || {entradas:[], saidas:[]};
                const allProj = [
                   ...(proj.entradas || []).map(x => ({...x, _tipo: 'entrada'})),
                   ...(proj.saidas || []).map(x => ({...x, _tipo: 'saida'}))
                ];

                const filtered = allProj.filter(p => {
                   if(!p.mes) return false;
                   const [py, pm] = p.mes.split('-');
                   const pAbs = toAbs(parseInt(py), parseInt(pm));
                   if (pAbs < absNow || pAbs > absEnd) return false; 
                   if (monthFilter.value !== 'all' && p.mes !== monthFilter.value) return false;
                   return true;
                });

                const totalE = filtered.filter(x => x._tipo === 'entrada').reduce((acc, curr) => acc + Number(curr.valor), 0);
                const totalS = filtered.filter(x => x._tipo === 'saida').reduce((acc, curr) => acc + Number(curr.valor), 0);
                const saldo = totalE - totalS;

                A.animateValue('p-v-entradas', totalE, false, 'var(--success)');
                A.animateValue('p-v-saidas', totalS, false, 'var(--danger)');
                A.animateValue('p-v-saldo', saldo);

                const cardSaldo = document.getElementById('p-card-saldo');
                const valSaldo = document.getElementById('p-v-saldo');
                if (cardSaldo && valSaldo) {
                    if (saldo >= 0) { cardSaldo.className = 'card stat-card c-success'; valSaldo.style.color = 'var(--success)'; }
                    else { cardSaldo.className = 'card stat-card c-danger'; valSaldo.style.color = 'var(--danger)'; }
                }

                filtered.sort((a,b) => a.mes.localeCompare(b.mes));
                const tbody = document.getElementById('p-table-body');
                const empty = document.getElementById('p-table-empty');

                if(filtered.length === 0) {
                   tbody.innerHTML = '';
                   empty.style.display = 'block';
                } else {
                   empty.style.display = 'none';
                   tbody.innerHTML = filtered.map((i, idx) => {
                      const isE = i._tipo === 'entrada';
                      const isConf = i.status === 'Confirmado';
                      return `<tr style="animation:fadeInUp 0.5s ease ${idx*30}ms both;">
                         <td style="color:var(--text-muted);font-weight:600;white-space:nowrap">${i.mes.split('-').reverse().join('/')}</td>
                         <td><div class="item-name">${esc(i.nome)}</div>${i.descricao ? `<div class="item-desc">${esc(i.descricao)}</div>`:''}</td>
                         <td><span class="cat-badge ${isE ? 'income' : ''}">${esc(i.categoria||'‚Äî')}</span></td>
                         <td><span class="status-badge ${isConf ? 'pago' : 'pendente'}">${isConf ? '‚úÖ Confirmado' : '‚è≥ Previsto'}</span></td>
                         <td class="amount-cell font-title" style="color:${isE ? 'var(--success)' : 'var(--text)'}">${isE?'+ ':''}${A.fmtR(i.valor)}</td>
                         <td style="text-align:center;white-space:nowrap">
                            <button class="action-btn" onclick="A.openProjDrawer('${i._tipo}', '${i.id}')" title="Editar"><i data-lucide="edit-2" width="16" height="16"></i></button>
                            <button class="action-btn del" onclick="A.delProj('${i._tipo}', '${i.id}')" title="Excluir"><i data-lucide="trash-2" width="16" height="16"></i></button>
                         </td>
                      </tr>`;
                   }).join('');
                }
                lucide.createIcons();
            },

            openExportModal() { document.getElementById('export-modal').classList.add('open'); document.getElementById('export-overlay').classList.add('open'); },
            closeExportModal() { document.getElementById('export-modal').classList.remove('open'); document.getElementById('export-overlay').classList.remove('open'); },
            
            runExport() {
                const format = document.getElementById('exp-format').value;
                const monthsBack = parseInt(document.getElementById('exp-period').value);
                let allData = [];
                (A.state.data.entradas||[]).forEach(d => allData.push({...d, fluxo: 'Entrada'}));
                (A.state.data.fixos||[]).forEach(d => allData.push({...d, fluxo: 'Sa√≠da (Fixo)'}));
                (A.state.data.unicos||[]).forEach(d => allData.push({...d, fluxo: 'Sa√≠da (Vari√°vel)'}));
                
                const now = new Date(), curM = now.getMonth(), curY = now.getFullYear();
                let filtered = [];
                if (monthsBack === 12) { 
                    filtered = allData.filter(x => { const p = A.parseDate(x.data); return p && p.y === curY; });
                } else {
                    filtered = allData.filter(d => {
                        const p = A.parseDate(d.data); if(!p) return false;
                        const itemDate = new Date(p.y, p.m, 1), limitDate = new Date(curY, curM - monthsBack + 1, 1), endDate = new Date(curY, curM + 1, 0); 
                        return itemDate >= limitDate && itemDate <= endDate;
                    });
                }
                filtered.sort((a,b) => (a.data||'').localeCompare(b.data||''));
                const filename = `Relatorio_Financeiro_BGTech_${monthsBack}M`;
                
                if (format === 'csv') {
                    const rows = [["Data", "Fluxo", "Descri√ß√£o", "Categoria", "Status", "Valor"]];
                    filtered.forEach(d => { rows.push([A.fmtD(d.data), d.fluxo, d.nome, d.categoria, d.status, d.valor]); });
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n")));
                    link.setAttribute("download", filename + ".csv");
                    document.body.appendChild(link); link.click();
                } else {
                    const { jsPDF } = window.jspdf; const doc = new jsPDF();
                    doc.setFontSize(16); doc.text("Relatorio Financeiro DRE - BG Tech", 14, 20);
                    doc.setFontSize(10); doc.text(`Periodo: Ultimos ${monthsBack} meses`, 14, 28);
                    doc.autoTable({
                        startY: 35, head: [['Data', 'Fluxo', 'Descricao', 'Categoria', 'Status', 'Valor (R$)']],
                        body: filtered.map(d => [ A.fmtD(d.data), d.fluxo, d.nome, d.categoria, d.status, A.fmtR(d.valor) ]),
                        theme: 'grid', headStyles: { fillColor: [14, 165, 233] }, styles: { fontSize: 8 }
                    });
                    doc.save(filename + ".pdf");
                }
                A.closeExportModal(); A.toast(`Relat√≥rio ${format.toUpperCase()} baixado! üì•`);
            },

            toast(msg, type = 'ok') {
                const w = document.getElementById('toast-wrap'), t = document.createElement('div');
                t.className = `toast${type === 'err' ? ' err' : ''}`;
                const icon = type === 'err' ? 'alert-circle' : 'check-circle', col = type === 'err' ? '#ef4444' : '#10b981';
                t.innerHTML = `<i data-lucide="${icon}" width="20" height="20" style="color:${col};flex-shrink:0"></i><span>${msg}</span>`;
                w.appendChild(t); lucide.createIcons();
                requestAnimationFrame(() => t.classList.add('show'));
                setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, 4500);
            }
        };

        function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
        window.onload = A.init;
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { A.closeDrawer(); A.closeProjDrawer(); A.closeExportModal(); A.closeMonthModal(); } });
    </script>
</body>
</html>
