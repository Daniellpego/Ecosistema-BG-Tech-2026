<!DOCTYPE html>
<html lang="pt-BR" data-color-scheme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BG Tech | CFO Dashboard Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --color-bg: #030712;
            --color-surface: #0d1117;
            --color-card: rgba(13, 17, 23, 0.85);
            --color-border: rgba(255, 255, 255, 0.06);
            --color-border-hover: rgba(14, 165, 233, 0.4);
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --primary-glow: rgba(14, 165, 233, 0.4);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.3);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --text-dim: #475569;
            --sidebar-w: 280px;
            --radius: 20px;
            --radius-sm: 12px;
            --transition: cubic-bezier(0.16, 1, 0.3, 1);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--color-bg); color: var(--text); line-height: 1.6; overflow-x: hidden; min-height: 100vh; }
        .font-title { font-family: 'Plus Jakarta Sans', sans-serif; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 99px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .bg-grid { position: fixed; inset: 0; z-index: 0; pointer-events: none; background-image: radial-gradient(circle at 1px 1px, rgba(14, 165, 233, 0.15) 1px, transparent 0), linear-gradient(rgba(14, 165, 233, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(14, 165, 233, 0.03) 1px, transparent 1px); background-size: 40px 40px, 60px 60px, 60px 60px; mask-image: radial-gradient(ellipse at center, black 40%, transparent 80%); }
        .bg-glow { position: fixed; border-radius: 50%; pointer-events: none; z-index: 0; filter: blur(120px); opacity: 0.6; animation: float 20s ease-in-out infinite; }
        .bg-glow-1 { width: 800px; height: 800px; background: rgba(14, 165, 233, 0.12); top: -300px; right: -300px; animation-delay: 0s; }
        .bg-glow-2 { width: 600px; height: 600px; background: rgba(239, 68, 68, 0.08); bottom: -200px; left: -200px; animation-delay: -10s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }

        #login-screen { position: fixed; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: radial-gradient(ellipse at center, #0a0f1a 0%, #030712 100%); perspective: 1000px; }
        .app { display: none; min-height: 100vh; opacity: 0; transform: translateY(20px); transition: opacity 0.6s var(--transition), transform 0.6s var(--transition); }
        .app.visible { display: flex; opacity: 1; transform: translateY(0); }

        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: var(--sidebar-w); background: linear-gradient(180deg, rgba(3, 7, 18, 0.98) 0%, rgba(13, 17, 23, 0.95) 100%); border-right: 1px solid var(--color-border); backdrop-filter: blur(20px) saturate(180%); display: flex; flex-direction: column; padding: 32px 20px; z-index: 100; transition: transform 0.4s var(--transition); }
        .sidebar-logo { display: flex; align-items: center; gap: 14px; padding: 0 12px 48px; position: relative; }
        .sidebar-logo::after { content: ''; position: absolute; bottom: 24px; left: 12px; right: 12px; height: 1px; background: linear-gradient(90deg, transparent, var(--color-border), transparent); }
        .sidebar-logo h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 900; letter-spacing: -0.03em; color: var(--text); }
        .sidebar-logo span { color: var(--primary); text-shadow: 0 0 20px var(--primary-glow); }
        .sidebar-logo svg { color: var(--primary); filter: drop-shadow(0 0 12px rgba(14, 165, 233, 0.6)); animation: pulse 4s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { filter: drop-shadow(0 0 12px rgba(14, 165, 233, 0.6)); } 50% { filter: drop-shadow(0 0 20px rgba(14, 165, 233, 0.9)); } }

        nav { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .nav-section-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-dim); padding: 20px 18px 8px; }
        .nav-btn { display: flex; align-items: center; gap: 14px; width: 100%; padding: 14px 18px; border: 1px solid transparent; border-radius: var(--radius-sm); background: transparent; color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s var(--transition); text-align: left; position: relative; overflow: hidden; }
        .nav-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(14, 165, 233, 0.1), transparent); transform: translateX(-100%); transition: transform 0.5s ease; }
        .nav-btn:hover { color: var(--text); background: rgba(255, 255, 255, 0.04); transform: translateX(4px); }
        .nav-btn:hover::before { transform: translateX(100%); }
        .nav-btn.active { background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(14, 165, 233, 0.05) 100%); color: var(--primary); border-color: rgba(14, 165, 233, 0.25); box-shadow: 0 4px 20px rgba(14, 165, 233, 0.15); }
        .nav-btn.active::before { content: ''; position: absolute; left: 0; top: 20%; bottom: 20%; width: 3px; background: var(--primary); border-radius: 0 4px 4px 0; box-shadow: 0 0 10px var(--primary); }
        .nav-btn svg { transition: transform 0.3s ease; }
        .nav-btn:hover svg { transform: scale(1.1); }

        .sidebar-footer { margin-top: auto; padding: 16px; background: rgba(0, 0, 0, 0.4); border: 1px solid var(--color-border); border-radius: var(--radius-sm); display: flex; align-items: center; gap: 12px; font-size: 12px; font-weight: 600; color: var(--text-muted); backdrop-filter: blur(10px); }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); box-shadow: 0 0 12px var(--success); flex-shrink: 0; position: relative; }
        .sync-dot::after { content: ''; position: absolute; inset: -4px; border-radius: 50%; border: 2px solid var(--success); opacity: 0; animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }

        .main { margin-left: var(--sidebar-w); flex: 1; min-width: 0; padding: 40px clamp(24px, 5vw, 60px) 80px; position: relative; z-index: 1; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; gap: 24px; flex-wrap: wrap; margin-bottom: 48px; padding-bottom: 24px; border-bottom: 1px solid var(--color-border); }
        .page-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: clamp(28px, 4vw, 40px); font-weight: 900; letter-spacing: -0.03em; color: var(--text); }
        .page-sub { color: var(--text-muted); font-size: 15px; font-weight: 500; margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        .header-right { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }

        .filter-group { display: flex; background: rgba(0, 0, 0, 0.6); border: 1px solid var(--color-border); border-radius: var(--radius-sm); overflow: hidden; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); }
        .filter-select { background: transparent; color: var(--text); border: none; padding: 12px 18px; font-size: 14px; font-weight: 600; cursor: pointer; appearance: none; outline: none; transition: all 0.2s ease; }
        .filter-select:hover { background: rgba(255, 255, 255, 0.03); }
        .filter-select option { background: #0d1117; padding: 8px; }
        .filter-sep { width: 1px; background: var(--color-border); margin: 10px 0; }

        /* LOADING SPINNER NA ACTION */
        .btn-primary, .btn-success, .form-save { position: relative; overflow: hidden; }
        .loading { pointer-events: none !important; color: transparent !important; }
        .loading::after {
            content: ""; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top-color: #fff; animation: spin 1s linear infinite;
        }

        .btn-primary { display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--primary-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.3s var(--transition); white-space: nowrap; }
        .btn-primary::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); transform: translateX(-100%); transition: transform 0.6s ease; }
        .btn-primary:hover { filter: brightness(1.15); transform: translateY(-2px); box-shadow: 0 8px 30px var(--primary-glow), inset 0 1px 0 rgba(255, 255, 255, 0.3); }
        .btn-primary:hover::before { transform: translateX(100%); }
        .btn-primary:active { transform: translateY(0) scale(0.98); }

        .btn-ghost { display: inline-flex; align-items: center; gap: 10px; padding: 12px 20px; border-radius: var(--radius-sm); border: 1px solid var(--color-border); background: rgba(255, 255, 255, 0.03); color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s var(--transition); backdrop-filter: blur(10px); }
        .btn-ghost:hover { color: var(--text); background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.15); transform: translateY(-1px); }

        .btn-success { display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; font-size: 14px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px var(--success-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.3s var(--transition); white-space: nowrap; }
        .btn-success:hover { filter: brightness(1.15); transform: translateY(-2px); }
        .btn-success:active { transform: translateY(0) scale(0.98); }

        .card { background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius); backdrop-filter: blur(20px) saturate(180%); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05); transition: all 0.4s var(--transition); position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(600px circle at var(--mouse-x, 50%) var(--mouse-y, 50%), rgba(14, 165, 233, 0.06), transparent 40%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .card:hover::before { opacity: 1; }
        .card:hover { border-color: var(--color-border-hover); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(14, 165, 233, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.08); transform: translateY(-4px); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { padding: 28px; border-top: 3px solid transparent; position: relative; }
        .stat-card.c-danger { border-top-color: var(--danger); }
        .stat-card.c-primary { border-top-color: var(--primary); }
        .stat-card.c-warning { border-top-color: var(--warning); }
        .stat-card.c-success { border-top-color: var(--success); }
        .stat-label { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
        .stat-value { font-family: 'Plus Jakarta Sans', sans-serif; font-size: clamp(28px, 3vw, 36px); font-weight: 900; letter-spacing: -0.03em; color: var(--text); }
        .stat-sub { font-size: 13px; color: var(--text-dim); font-weight: 500; margin-top: 10px; display: flex; align-items: center; gap: 6px; }

        /* CFO INSIGHTS GRIDS */
        .cfo-insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .insight-card { background: rgba(0,0,0,0.4); border-left: 4px solid var(--primary); padding: 18px 24px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 16px; font-size: 13px; color: var(--text-muted); border-top: 1px solid var(--color-border); border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); }
        .insight-card strong { color: var(--text); font-size: 14px; display: block; margin-bottom: 4px; }
        .insight-card i { flex-shrink: 0; width: 24px; height: 24px; }
        .insight-card.danger { border-left-color: var(--danger); background: linear-gradient(90deg, rgba(239,68,68,0.1), rgba(0,0,0,0.4)); }
        .insight-card.danger i { color: var(--danger); }
        .insight-card.warning { border-left-color: var(--warning); background: linear-gradient(90deg, rgba(245,158,11,0.1), rgba(0,0,0,0.4)); }
        .insight-card.warning i { color: var(--warning); }
        .insight-card.success { border-left-color: var(--success); background: linear-gradient(90deg, rgba(16,185,129,0.1), rgba(0,0,0,0.4)); }
        .insight-card.success i { color: var(--success); }

        .charts-row { display: grid; grid-template-columns: 3fr 2fr; gap: 24px; margin-bottom: 32px; }
        .chart-card { padding: 28px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--color-border); }
        .chart-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .chart-sub { font-size: 13px; color: var(--text-muted); font-weight: 600; background: rgba(255, 255, 255, 0.03); padding: 6px 12px; border-radius: 20px; }
        #chart-area, #chart-donut { min-height: 300px; }

        .annual-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
        .month-tile { padding: 24px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--color-border); background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%); transition: all 0.4s var(--transition); position: relative; overflow: hidden; }
        .month-tile::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--primary); transform: scaleX(0); transition: transform 0.4s var(--transition); }
        .month-tile:hover { background: linear-gradient(145deg, rgba(14, 165, 233, 0.08) 0%, rgba(14, 165, 233, 0.02) 100%); border-color: rgba(14, 165, 233, 0.3); transform: translateY(-4px) scale(1.02); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); }
        .month-tile:hover::before { transform: scaleX(1); }
        .month-tile.current { border-color: rgba(14, 165, 233, 0.5); background: linear-gradient(145deg, rgba(14, 165, 233, 0.12) 0%, rgba(14, 165, 233, 0.04) 100%); box-shadow: 0 0 30px rgba(14, 165, 233, 0.15); }
        .month-tile.current::before { transform: scaleX(1); box-shadow: 0 0 10px var(--primary); }
        .month-tile-name { font-size: 14px; font-weight: 700; color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .month-tile-val { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 22px; font-weight: 900; color: var(--text); letter-spacing: -0.02em; }

        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius-sm); }
        .data-table { width: 100%; min-width: 800px; border-collapse: separate; border-spacing: 0; }
        .data-table th { padding: 20px 24px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-dim); background: rgba(0, 0, 0, 0.3); white-space: nowrap; border-bottom: 1px solid var(--color-border); position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: 20px 24px; border-bottom: 1px solid var(--color-border); vertical-align: middle; transition: all 0.3s ease; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr { transition: all 0.3s ease; }
        .data-table tr:hover td { background: rgba(14, 165, 233, 0.04); }
        .item-name { font-size: 15px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .item-desc { font-size: 13px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }
        .cat-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; background: rgba(14, 165, 233, 0.1); color: var(--primary); border: 1px solid rgba(14, 165, 233, 0.2); transition: all 0.3s ease; }
        .cat-badge:hover { background: rgba(14, 165, 233, 0.2); transform: translateY(-1px); }
        .cat-badge.income { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.2); }
        .recur-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.06em; transition: all 0.3s ease; }
        .recur-badge.sim { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .recur-badge.nao { background: rgba(148, 163, 184, 0.08); color: var(--text-dim); border: 1px solid rgba(148, 163, 184, 0.15); }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; transition: all 0.3s ease; }
        .status-badge.pago { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.25); box-shadow: 0 0 10px rgba(16, 185, 129, 0.1); }
        .status-badge.pendente { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.25); box-shadow: 0 0 10px rgba(245, 158, 11, 0.1); }
        .amount-cell { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 17px; font-weight: 800; text-align: right; white-space: nowrap; letter-spacing: -0.01em; }
        .action-btn { background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 10px; border-radius: 10px; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; }
        .action-btn:hover { background: rgba(255, 255, 255, 0.08); color: var(--text); transform: scale(1.1); }
        .action-btn.del:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); transform: scale(1.1) rotate(5deg); }

        .empty-state { text-align: center; padding: 100px 24px; color: var(--text-muted); }
        .empty-state svg { width: 64px; height: 64px; opacity: 0.2; margin-bottom: 24px; stroke-width: 1.5; }
        .empty-state h3 { font-size: 20px; font-weight: 800; margin-bottom: 8px; color: var(--text); }
        .empty-state p { font-size: 14px; color: var(--text-dim); max-width: 300px; margin: 0 auto; }

        .drawer-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(12px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
        .drawer-overlay.open { opacity: 1; pointer-events: all; }
        .drawer { position: fixed; top: 0; right: -100%; bottom: 0; width: min(600px, 100vw); background: linear-gradient(180deg, #0d1117 0%, #070a0f 100%); border-left: 1px solid var(--color-border); z-index: 201; padding: clamp(32px, 6vw, 48px); overflow-y: auto; transition: right 0.5s var(--transition); box-shadow: -40px 0 80px rgba(0, 0, 0, 0.8); }
        .drawer.open { right: 0; }
        .drawer-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 24px; border-bottom: 1px solid var(--color-border); }
        .drawer-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 26px; font-weight: 900; color: var(--text); }

        .type-tabs { display: flex; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--color-border); border-radius: var(--radius-sm); padding: 6px; gap: 6px; margin-bottom: 32px; position: relative; }
        .type-tab { flex: 1; padding: 14px; border: none; background: transparent; color: var(--text-muted); font-size: 14px; font-weight: 700; border-radius: 10px; cursor: pointer; transition: all 0.3s var(--transition); position: relative; z-index: 1; }
        .type-tab.active { background: rgba(255, 255, 255, 0.08); color: var(--text); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); }

        .form-group { margin-bottom: 24px; }
        .form-label { font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .form-input { width: 100%; padding: 16px 18px; border-radius: var(--radius-sm); background: rgba(0, 0, 0, 0.5); border: 1px solid var(--color-border); color: var(--text); font-size: 15px; font-weight: 500; transition: all 0.3s ease; outline: none; }
        .form-input:focus { border-color: var(--primary); background: rgba(14, 165, 233, 0.04); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .form-input::placeholder { color: var(--text-dim); }
        select.form-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; background-size: 16px; padding-right: 48px; }
        select.form-input option { background: #0d1117; padding: 12px; }
        .form-hint { font-size: 12px; color: var(--text-dim); margin-top: 8px; font-weight: 500; display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(255, 255, 255, 0.02); border-radius: 8px; border-left: 3px solid var(--primary); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-save { width: 100%; padding: 18px; border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; font-size: 16px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 6px 30px var(--primary-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.3s var(--transition); margin-top: 32px; position: relative; overflow: hidden; }
        .form-save::before { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transform: translateX(-100%); transition: transform 0.6s ease; }
        .form-save:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: 0 10px 40px var(--primary-glow); }
        .form-save:hover::before { transform: translateX(100%); }
        .form-save.save-income { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); box-shadow: 0 6px 30px var(--success-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
        .form-save.save-income:hover { box-shadow: 0 10px 40px var(--success-glow); }

        .login-card { width: 100%; max-width: 440px; margin: 24px; padding: 56px 48px; transform-style: preserve-3d; animation: cardFloat 6s ease-in-out infinite; }
        @keyframes cardFloat { 0%, 100% { transform: translateY(0) rotateX(0); } 50% { transform: translateY(-10px) rotateX(2deg); } }
        .login-logo { display: flex; align-items: center; justify-content: center; gap: 14px; margin-bottom: 16px; }
        .login-logo h1 { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 42px; font-weight: 900; color: var(--text); }
        .login-logo span { color: var(--primary); text-shadow: 0 0 30px var(--primary-glow); }
        .login-logo svg { color: var(--primary); filter: drop-shadow(0 0 15px rgba(14, 165, 233, 0.8)); animation: spin 20s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .login-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 18px; border-radius: 99px; background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.3); color: var(--primary); font-size: 12px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 48px; box-shadow: 0 0 20px rgba(14, 165, 233, 0.1); }
        .login-field { position: relative; margin-bottom: 20px; }
        .login-input { width: 100%; padding: 18px 18px 18px 52px; border-radius: var(--radius-sm); background: rgba(0, 0, 0, 0.6); border: 1px solid var(--color-border); color: var(--text); font-size: 16px; transition: all 0.3s ease; }
        .login-input:focus { border-color: var(--primary); background: rgba(14, 165, 233, 0.05); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .login-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--text-dim); transition: all 0.3s ease; }
        .login-input:focus+.login-icon { color: var(--primary); transform: translateY(-50%) scale(1.1); }
        input:-webkit-autofill, input:-webkit-autofill:focus { -webkit-box-shadow: 0 0 0 50px #0d1117 inset; -webkit-text-fill-color: white; transition: background-color 5000s ease-in-out 0s; }

        #toast-wrap { position: fixed; bottom: 32px; right: 32px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { background: rgba(13, 17, 23, 0.95); border: 1px solid var(--color-border); border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: var(--radius-sm); color: var(--text); font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 12px; transform: translateX(120%) scale(0.9); opacity: 0; transition: all 0.5s var(--transition); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); backdrop-filter: blur(20px); max-width: 380px; pointer-events: all; }
        .toast.show { transform: translateX(0) scale(1); opacity: 1; }
        .toast.err { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }

        .report-filters { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 32px; }
        .report-filters .filter-group { flex: 1; min-width: 180px; }
        .report-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .report-kpi { padding: 24px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--color-border); border-radius: var(--radius-sm); text-align: center; transition: all 0.3s var(--transition); }
        .report-kpi:hover { border-color: rgba(14, 165, 233, 0.3); transform: translateY(-2px); }
        .report-kpi-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin-bottom: 10px; }
        .report-kpi-value { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 900; }
        .report-kpi-value.positive { color: var(--success); }
        .report-kpi-value.negative { color: var(--danger); }
        .report-cat-list { margin-bottom: 32px; }
        .report-cat-item { display: flex; align-items: center; gap: 16px; padding: 14px 0; border-bottom: 1px solid var(--color-border); }
        .report-cat-item:last-child { border-bottom: none; }
        .report-cat-name { flex: 1; font-size: 14px; font-weight: 600; }
        .report-cat-val { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 15px; font-weight: 800; min-width: 120px; text-align: right; }
        .report-cat-bar-wrap { flex: 2; height: 8px; background: rgba(255, 255, 255, 0.06); border-radius: 4px; overflow: hidden; }
        .report-cat-bar { height: 100%; border-radius: 4px; transition: width 0.8s var(--transition); }
        .report-cat-bar.income { background: linear-gradient(90deg, var(--success), #34d399); }
        .report-cat-bar.expense { background: linear-gradient(90deg, var(--danger), #f87171); }
        .export-btns { display: flex; gap: 16px; flex-wrap: wrap; }
        .export-btns .btn-primary, .export-btns .btn-ghost { flex: 1; min-width: 160px; justify-content: center; }

        .mobile-bar { display: none; }
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; padding: 24px 20px 100px; }
            .charts-row, .form-grid { grid-template-columns: 1fr; }
            .page-header { flex-direction: column; align-items: stretch; gap: 20px; }
            .header-right { flex-direction: column; width: 100%; }
            .filter-group { width: 100%; justify-content: space-between; }
            .btn-primary, .btn-success { width: 100%; justify-content: center; }
            .mobile-bar { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(3, 7, 18, 0.98); border-top: 1px solid var(--color-border); padding: 8px 4px calc(8px + env(safe-area-inset-bottom)); z-index: 150; justify-content: space-around; backdrop-filter: blur(20px); box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5); overflow-x: auto; gap: 2px; }
            .m-btn { background: none; border: none; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; cursor: pointer; padding: 6px 10px; border-radius: 12px; transition: all 0.3s var(--transition); position: relative; white-space: nowrap; }
            .m-btn.active { color: var(--primary); background: rgba(14, 165, 233, 0.1); }
            .m-btn.active::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }
            .report-filters { flex-direction: column; }
        }

        .view { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .view.active { display: block; opacity: 1; transform: translateY(0); }

        .search-wrap { padding: 20px 24px; border-bottom: 1px solid var(--color-border); background: rgba(0, 0, 0, 0.2); }
        .search-input { width: 100%; padding: 14px 18px 14px 48px; border-radius: var(--radius-sm); background: rgba(0, 0, 0, 0.4); border: 1px solid var(--color-border); color: var(--text); font-size: 14px; font-weight: 500; transition: all 0.3s ease; outline: none; position: relative; }
        .search-input:focus { border-color: var(--primary); background: rgba(14, 165, 233, 0.04); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        .search-input::placeholder { color: var(--text-dim); }
        .search-wrap .search-icon { position: absolute; left: 40px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .shake { animation: shake 0.5s ease; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>
    <div class="bg-grid"></div>
    <div class="bg-glow bg-glow-1"></div>
    <div class="bg-glow bg-glow-2"></div>

    <div id="login-screen">
        <div class="card login-card" id="login-card">
            <div class="login-logo">
                <i data-lucide="cpu" width="44" height="44"></i>
                <h1>BG <span>TECH</span></h1>
            </div>
            <div style="text-align:center;">
                <span class="login-badge"><i data-lucide="shield-check" width="16" height="16"></i> Acesso Restrito CFO</span>
            </div>
            <div class="login-field">
                <input type="text" id="lu" class="login-input" placeholder="ID de Acesso" autocomplete="username" aria-label="ID de Acesso">
                <i data-lucide="user" width="20" height="20" class="login-icon"></i>
            </div>
            <div class="login-field" style="margin-bottom:40px;">
                <input type="password" id="lp" class="login-input" placeholder="Senha do Cofre" autocomplete="current-password" aria-label="Senha">
                <i data-lucide="key" width="20" height="20" class="login-icon"></i>
            </div>
            <button class="btn-primary" id="btn-login" style="width:100%;padding:18px;font-size:16px;justify-content:center;" onclick="A.login()">
                Destrancar Sistema <i data-lucide="arrow-right" width="20" height="20"></i>
            </button>
        </div>
    </div>

    <div class="app" id="app">
        <aside class="sidebar" id="sidebar" role="navigation" aria-label="Navega√ß√£o principal">
            <div class="sidebar-logo">
                <i data-lucide="cpu" width="28" height="28"></i>
                <h1>BG <span>TECH</span></h1>
            </div>
            <nav>
                <div class="nav-section-label">Vis√£o Geral</div>
                <button class="nav-btn active" data-tab="overview" onclick="A.tab('overview')" aria-current="page">
                    <i data-lucide="layout-dashboard" width="18" height="18"></i> Painel Geral
                </button>
                <button class="nav-btn" data-tab="annual" onclick="A.tab('annual')">
                    <i data-lucide="calendar-range" width="18" height="18"></i> Balan√ßo Anual
                </button>
                
                <div class="nav-section-label">Financeiro</div>
                <button class="nav-btn" data-tab="entradas" onclick="A.tab('entradas')">
                    <i data-lucide="wallet" width="18" height="18"></i> Entradas
                </button>
                <button class="nav-btn" data-tab="fixos" onclick="A.tab('fixos')">
                    <i data-lucide="anchor" width="18" height="18"></i> Custos Fixos
                </button>
                <button class="nav-btn" data-tab="unicos" onclick="A.tab('unicos')">
                    <i data-lucide="zap" width="18" height="18"></i> Gastos Vari√°veis
                </button>
                
                <div class="nav-section-label">An√°lise</div>
                <button class="nav-btn" data-tab="relatorios" onclick="A.tab('relatorios')">
                    <i data-lucide="file-bar-chart" width="18" height="18"></i> Relat√≥rios
                </button>
                <button class="nav-btn" data-tab="projecoes" onclick="A.tab('projecoes')">
                    <i data-lucide="line-chart" width="18" height="18"></i> Proje√ß√µes
                </button>
            </nav>
            <div class="sidebar-footer">
                <div class="sync-dot" id="sync-dot" aria-label="Status de conex√£o"></div>
                <span id="sync-txt">Conectado</span>
            </div>
        </aside>

        <main class="main" role="main">
            <header class="page-header">
                <div>
                    <h2 class="page-title font-title" id="page-title">Painel Geral</h2>
                    <p class="page-sub" id="page-sub"><i data-lucide="activity" width="16" height="16"></i> Monitoramento de despesas operacionais em tempo real</p>
                </div>
                <div class="header-right">
                    <div class="filter-group" id="main-filters">
                        <select id="fMonth" class="filter-select" onchange="A.render()" aria-label="Selecionar m√™s">
                            <option value="anual">üìä Balan√ßo Anual</option>
                        </select>
                        <div class="filter-sep"></div>
                        <select id="fYear" class="filter-select" onchange="A.render()" aria-label="Selecionar ano">
                            <option value="2025">2025</option>
                            <option value="2026" selected>2026</option>
                        </select>
                    </div>
                    <button class="btn-primary" id="btn-add-main" onclick="A.openDrawer()" aria-label="Adicionar novo registro">
                        <i data-lucide="plus" width="18" height="18"></i> <span id="btn-add-label">Novo Gasto</span>
                    </button>
                </div>
            </header>

            <div id="view-overview" class="view active" role="tabpanel">
                
                <div class="cfo-insights-grid" id="cfo-insights"></div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    <div class="card stat-card c-success">
                        <div class="stat-label">Receita Total <i data-lucide="trending-up" width="18" height="18" style="color:var(--success)"></i></div>
                        <div class="stat-value font-title" id="v-receita-ov" style="color:var(--success)">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="wallet" width="14" height="14"></i> Faturamento do per√≠odo</div>
                    </div>
                    <div class="card stat-card c-primary">
                        <div class="stat-label">MRR <i data-lucide="repeat" width="18" height="18" style="color:var(--primary)"></i></div>
                        <div class="stat-value font-title" id="v-mrr-ov">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="layers" width="14" height="14"></i> Receitas recorrentes mensais</div>
                    </div>
                    <div class="card stat-card c-danger">
                        <div class="stat-label">Sangria Total <i data-lucide="trending-down" width="18" height="18" style="color:var(--danger)"></i></div>
                        <div class="stat-value font-title" id="v-total">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="minus-circle" width="14" height="14"></i> Custos Fixos + Vari√°veis</div>
                    </div>
                    <div class="card stat-card c-primary">
                        <div class="stat-label">Custo Fixo <i data-lucide="anchor" width="18" height="18" style="color:var(--primary)"></i></div>
                        <div class="stat-value font-title" id="v-fixos">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="repeat" width="14" height="14"></i> Despesas recorrentes mensais</div>
                    </div>
                    <div class="card stat-card c-warning">
                        <div class="stat-label">Vari√°veis <i data-lucide="zap" width="18" height="18" style="color:var(--warning)"></i></div>
                        <div class="stat-value font-title" id="v-unicos">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="sparkles" width="14" height="14"></i> Gastos pontuais e extras</div>
                    </div>
                    <div class="card stat-card" id="card-saldo-ov" style="border-top:3px solid var(--success);">
                        <div class="stat-label">Saldo L√≠quido <i data-lucide="scale" width="18" height="18" id="icon-saldo-ov" style="color:var(--success)"></i></div>
                        <div class="stat-value font-title" id="v-saldo-ov" style="color:var(--success)">R$ 0,00</div>
                        <div class="stat-sub" id="v-saldo-ov-sub"><i data-lucide="info" width="14" height="14"></i> Receitas ‚àí Despesas</div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card chart-card">
                        <div class="chart-header">
                            <span class="chart-title font-title"><i data-lucide="activity" width="20" height="20" style="color:var(--primary)"></i> Curva de Gastos</span>
                            <span class="chart-sub">√öltimos 6 meses</span>
                        </div>
                        <div id="chart-area"></div>
                    </div>
                    <div class="card chart-card">
                        <div class="chart-header">
                            <span class="chart-title font-title"><i data-lucide="pie-chart" width="20" height="20" style="color:var(--primary)"></i> Distribui√ß√£o Fixos</span>
                            <span class="chart-sub">Por categoria</span>
                        </div>
                        <div id="chart-donut"></div>
                    </div>
                </div>
            </div>

            <div id="view-annual" class="view" role="tabpanel">
                <div class="card" style="padding:32px;margin-bottom:24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;flex-wrap:wrap;gap:16px;">
                        <div>
                            <div class="chart-title font-title" style="font-size:24px;margin-bottom:8px;" id="annual-title">Balan√ßo Anual 2026</div>
                            <div style="font-size:14px;color:var(--text-muted);display:flex;align-items:center;gap:8px;">
                                <i data-lucide="mouse-pointer-2" width="14" height="14"></i> Clique em um m√™s para visualizar os detalhes
                            </div>
                        </div>
                        <div style="display:flex;gap:16px;flex-wrap:wrap;">
                            <div style="text-align:center;padding:16px 20px;background:rgba(16,185,129,0.08);border-radius:var(--radius-sm);border:1px solid rgba(16,185,129,0.25);">
                                <div style="font-size:11px;color:var(--success);font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">Faturamento Ano</div>
                                <div class="font-title" style="font-size:22px;font-weight:900;color:var(--success);" id="annual-total-in">R$ 0,00</div>
                            </div>
                            <div style="text-align:center;padding:16px 20px;background:rgba(239,68,68,0.08);border-radius:var(--radius-sm);border:1px solid rgba(239,68,68,0.25);">
                                <div style="font-size:11px;color:var(--danger);font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">Gastos Ano</div>
                                <div class="font-title" style="font-size:22px;font-weight:900;color:var(--danger);" id="annual-total-out">R$ 0,00</div>
                            </div>
                            <div style="text-align:center;padding:16px 20px;background:rgba(0,0,0,0.3);border-radius:var(--radius-sm);border:1px solid var(--color-border);">
                                <div style="font-size:11px;color:var(--text-dim);font-weight:800;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;">Saldo Anual</div>
                                <div class="font-title" style="font-size:22px;font-weight:900;" id="annual-saldo">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="annual-grid" id="annual-grid"></div>
                </div>
            </div>

            <div id="view-list" class="view" role="tabpanel">
                <div class="card" style="overflow:hidden;">
                    <div class="search-wrap" style="position:relative;">
                        <input type="text" id="search-gastos" class="search-input" placeholder="Buscar por nome, categoria..." oninput="A.render()">
                        <i data-lucide="search" width="16" height="16" class="search-icon"></i>
                    </div>
                    <div class="table-wrap">
                        <table class="data-table" role="table">
                            <thead>
                                <tr>
                                    <th scope="col">Data</th>
                                    <th scope="col">Descri√ß√£o</th>
                                    <th scope="col">Categoria</th>
                                    <th scope="col">Recorr√™ncia</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" style="text-align:right">Valor</th>
                                    <th scope="col" style="text-align:center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    <div id="table-empty" class="empty-state" style="display:none;">
                        <i data-lucide="check-circle"></i>
                        <h3>Nenhum registro encontrado</h3>
                        <p>Adicione um novo gasto para come√ßar a visualizar seus dados.</p>
                    </div>
                </div>
            </div>

            <div id="view-entradas" class="view" role="tabpanel">
                <div class="stats-grid" id="entradas-stats">
                    <div class="card stat-card c-success">
                        <div class="stat-label">Receita Total <i data-lucide="trending-up" width="18" height="18" style="color:var(--success)"></i></div>
                        <div class="stat-value font-title" id="v-receita-total">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="wallet" width="14" height="14"></i> Entradas do per√≠odo</div>
                    </div>
                    <div class="card stat-card c-primary">
                        <div class="stat-label">Recorrentes <i data-lucide="repeat" width="18" height="18" style="color:var(--primary)"></i></div>
                        <div class="stat-value font-title" id="v-receita-recor">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="calendar-check" width="14" height="14"></i> Pagamentos mensais fixos</div>
                    </div>
                    <div class="card stat-card c-warning">
                        <div class="stat-label">Avulsas <i data-lucide="sparkles" width="18" height="18" style="color:var(--warning)"></i></div>
                        <div class="stat-value font-title" id="v-receita-avulsa">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="zap" width="14" height="14"></i> Pagamentos pontuais</div>
                    </div>
                    <div class="card stat-card" id="card-saldo-ent" style="border-top:3px solid var(--success);">
                        <div class="stat-label">Saldo do Per√≠odo <i data-lucide="scale" width="18" height="18" style="color:var(--success)"></i></div>
                        <div class="stat-value font-title" id="v-saldo-entradas" style="color:var(--success)">R$ 0,00</div>
                        <div class="stat-sub" id="v-saldo-entradas-sub"><i data-lucide="info" width="14" height="14"></i> Entradas ‚àí Sa√≠das</div>
                    </div>
                </div>
                <div class="card" style="overflow:hidden;">
                    <div class="search-wrap" style="position:relative;">
                        <input type="text" id="search-entradas" class="search-input" placeholder="Buscar por nome, categoria..." oninput="A.render()">
                        <i data-lucide="search" width="16" height="16" class="search-icon"></i>
                    </div>
                    <div class="table-wrap">
                        <table class="data-table" role="table">
                            <thead>
                                <tr>
                                    <th scope="col">Data</th>
                                    <th scope="col">Descri√ß√£o</th>
                                    <th scope="col">Categoria</th>
                                    <th scope="col">Recorr√™ncia</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" style="text-align:right">Valor</th>
                                    <th scope="col" style="text-align:center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="table-entradas"></tbody>
                        </table>
                    </div>
                    <div id="entradas-empty" class="empty-state" style="display:none;">
                        <i data-lucide="wallet"></i>
                        <h3>Nenhuma entrada registrada</h3>
                        <p>Clique em "Nova Entrada" para adicionar uma receita.</p>
                    </div>
                </div>
            </div>

            <div id="view-relatorios" class="view" role="tabpanel">
                <div class="card" style="padding:32px;">
                    <div class="chart-header" style="margin-bottom:32px;">
                        <span class="chart-title font-title" style="font-size:22px;">
                            <i data-lucide="file-bar-chart" width="22" height="22" style="color:var(--primary)"></i> Relat√≥rio Financeiro
                        </span>
                    </div>
                    <div class="report-filters">
                        <div class="filter-group">
                            <select id="report-tipo" class="filter-select" onchange="A.onReportTipoChange()" style="width:100%;">
                                <option value="mensal">üìÖ Mensal</option>
                                <option value="trimestral">üìä Trimestral</option>
                                <option value="semestral">üìà Semestral</option>
                            </select>
                        </div>
                        <div class="filter-group" id="report-period-wrap">
                            <select id="report-period" class="filter-select" onchange="A.renderRelatorios()" style="width:100%;"></select>
                        </div>
                        <div class="filter-group">
                            <select id="report-year" class="filter-select" onchange="A.onReportTipoChange()" style="width:100%;">
                                <option value="2025">2025</option>
                                <option value="2026" selected>2026</option>
                            </select>
                        </div>
                    </div>
                    <div class="report-kpi-grid" id="report-kpis"></div>
                    <div class="chart-title font-title" style="font-size:16px;margin-bottom:20px;">
                        <i data-lucide="bar-chart-3" width="18" height="18" style="color:var(--primary)"></i> Resumo por Categoria
                    </div>
                    <div class="card" style="padding:24px;margin-bottom:32px;background:rgba(0,0,0,0.3);">
                        <div id="report-cats"></div>
                    </div>
                    <div class="export-btns">
                        <button class="btn-primary" onclick="A.exportPDF()">
                            <i data-lucide="file-text" width="18" height="18"></i> Baixar PDF
                        </button>
                        <button class="btn-ghost" onclick="A.exportCSV()">
                            <i data-lucide="table" width="18" height="18"></i> Baixar CSV
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-projecoes" class="view" role="tabpanel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                   <div class="report-filters" style="margin:0; flex: 1;">
                      <div class="filter-group" style="width: auto;">
                          <select id="p-horizonte" class="filter-select" onchange="A.renderProjecoes()">
                             <option value="3">Pr√≥ximos 3 Meses</option>
                             <option value="6" selected>Pr√≥ximos 6 Meses</option>
                             <option value="12">Pr√≥ximos 12 Meses</option>
                          </select>
                      </div>
                      <div class="filter-group" style="width: auto;">
                          <select id="p-mes-filter" class="filter-select" onchange="A.renderProjecoes()">
                             <option value="all">Todos os meses do horizonte</option>
                          </select>
                      </div>
                   </div>
                   <div style="display:flex; gap:12px; flex-wrap: wrap;">
                      <button class="btn-success" onclick="A.openProjDrawer('entrada')"><i data-lucide="trending-up" width="16" height="16"></i> Projetar Entrada</button>
                      <button class="btn-primary" onclick="A.openProjDrawer('saida')" style="background: linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%); box-shadow: 0 4px 20px var(--danger-glow);"><i data-lucide="trending-down" width="16" height="16"></i> Projetar Sa√≠da</button>
                   </div>
                </div>

                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                    <div class="card stat-card c-success">
                        <div class="stat-label">Total Entradas <i data-lucide="trending-up" width="18" height="18" style="color:var(--success)"></i></div>
                        <div class="stat-value font-title" id="p-v-entradas" style="color:var(--success)">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="calendar" width="14" height="14"></i> Receitas projetadas</div>
                    </div>
                    <div class="card stat-card c-danger">
                        <div class="stat-label">Total Sa√≠das <i data-lucide="trending-down" width="18" height="18" style="color:var(--danger)"></i></div>
                        <div class="stat-value font-title" id="p-v-saidas" style="color:var(--danger)">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="calendar" width="14" height="14"></i> Custos projetados</div>
                    </div>
                    <div class="card stat-card" id="p-card-saldo" style="border-top:3px solid var(--success);">
                        <div class="stat-label">Saldo Projetado <i data-lucide="scale" width="18" height="18" style="color:var(--success)"></i></div>
                        <div class="stat-value font-title" id="p-v-saldo" style="color:var(--success)">R$ 0,00</div>
                        <div class="stat-sub"><i data-lucide="info" width="14" height="14"></i> Resultado do horizonte</div>
                    </div>
                </div>

                <div class="card" style="overflow:hidden;">
                    <div class="table-wrap">
                        <table class="data-table" role="table">
                            <thead>
                                <tr>
                                    <th scope="col">Compet√™ncia</th>
                                    <th scope="col">Descri√ß√£o</th>
                                    <th scope="col">Categoria</th>
                                    <th scope="col">Status</th>
                                    <th scope="col" style="text-align:right">Valor</th>
                                    <th scope="col" style="text-align:center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="p-table-body"></tbody>
                        </table>
                    </div>
                    <div id="p-table-empty" class="empty-state" style="display:none;">
                        <i data-lucide="bar-chart-2"></i>
                        <h3>Nenhuma proje√ß√£o cadastrada</h3>
                        <p>Simule entradas e sa√≠das futuras para antecipar seu caixa.</p>
                    </div>
                </div>
            </div>

        </main>

        <nav class="mobile-bar" role="navigation" aria-label="Navega√ß√£o mobile">
            <button class="m-btn active" data-tab="overview" onclick="A.tab('overview')"><i data-lucide="layout-dashboard" width="20" height="20"></i>Painel</button>
            <button class="m-btn" data-tab="entradas" onclick="A.tab('entradas')"><i data-lucide="wallet" width="20" height="20"></i>Entradas</button>
            <button class="m-btn" data-tab="fixos" onclick="A.tab('fixos')"><i data-lucide="anchor" width="20" height="20"></i>Fixos</button>
            <button class="m-btn" data-tab="unicos" onclick="A.tab('unicos')"><i data-lucide="zap" width="20" height="20"></i>Vari√°veis</button>
            <button class="m-btn" data-tab="projecoes" onclick="A.tab('projecoes')"><i data-lucide="line-chart" width="20" height="20"></i>Proje√ß√µes</button>
        </nav>
    </div>

    <div class="drawer-overlay" id="overlay" onclick="A.closeDrawer()" role="dialog" aria-hidden="true"></div>
    <div class="drawer" id="drawer" role="dialog" aria-modal="true" aria-labelledby="drawer-title">
        <div class="drawer-head">
            <h2 class="drawer-title font-title" id="drawer-title">Novo Gasto</h2>
            <button class="btn-ghost" onclick="A.closeDrawer()" aria-label="Fechar" style="padding:10px;">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <input type="hidden" id="f-id">

        <div class="type-tabs" id="modo-tabs" style="margin-bottom:16px;">
            <button class="type-tab active" id="tab-modo-despesa" onclick="A.setModo('despesa')">üí∏ Despesa</button>
            <button class="type-tab" id="tab-modo-entrada" onclick="A.setModo('entrada')">üí∞ Receita</button>
        </div>

        <div class="type-tabs" id="sub-type-tabs" role="tablist">
            <button class="type-tab active" id="tab-fixos" onclick="A.setType('fixos')" role="tab" aria-selected="true">üìå Custo Fixo</button>
            <button class="type-tab" id="tab-unicos" onclick="A.setType('unicos')" role="tab" aria-selected="false">‚ö° Vari√°vel</button>
        </div>

        <div class="form-group">
            <label class="form-label" for="f-nome" id="lbl-nome">O que est√° sendo pago? *</label>
            <input type="text" id="f-nome" class="form-input" placeholder="Ex: Assinatura Notion, Servidor..." autocomplete="off" required>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label" for="f-valor">Valor (R$) *</label>
                <input type="text" id="f-valor" class="form-input" placeholder="0,00" oninput="A.maskMoney(event)" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="f-data">Data / Vencimento</label>
                <input type="date" id="f-data" class="form-input">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label" for="f-recor">Tipo de Recorr√™ncia</label>
            <select id="f-recor" class="form-input" onchange="A.onRecorChange()">
                <option value="unico">üî¥ √önico ‚Äî lan√ßamento manual</option>
                <option value="mensal">üîÑ Mensal ‚Äî replica todo m√™s</option>
                <option value="proximo">üìÖ Pr√≥ximos Meses ‚Äî replica a partir da data</option>
            </select>
            <div class="form-hint" id="recor-hint"><i data-lucide="info" width="14" height="14"></i> Lan√ßamento pontual, somente neste m√™s.</div>
        </div>
        <div class="form-group">
            <label class="form-label" for="f-cat">Categoria</label>
            <select id="f-cat" class="form-input"></select>
        </div>
        <div class="form-group">
            <label class="form-label" for="f-status" id="lbl-status">Status do Pagamento</label>
            <select id="f-status" class="form-input">
                <option value="Pago">‚úÖ Pago</option>
                <option value="Pendente">‚è≥ Pendente</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" for="f-desc">Observa√ß√£o (opcional)</label>
            <input type="text" id="f-desc" class="form-input" placeholder="Detalhes adicionais..." autocomplete="off">
        </div>
        <button class="form-save" id="btn-save" onclick="A.save()">
            <i data-lucide="save" width="20" height="20"></i> Salvar Registro
        </button>
    </div>

    <div class="drawer-overlay" id="proj-overlay" onclick="A.closeProjDrawer()" role="dialog" aria-hidden="true"></div>
    <div class="drawer" id="proj-drawer" role="dialog" aria-modal="true" aria-labelledby="proj-drawer-title">
        <div class="drawer-head">
            <h2 class="drawer-title font-title" id="proj-drawer-title">Nova Proje√ß√£o</h2>
            <button class="btn-ghost" onclick="A.closeProjDrawer()" aria-label="Fechar" style="padding:10px;">
                <i data-lucide="x" width="20" height="20"></i>
            </button>
        </div>
        <input type="hidden" id="pf-id">

        <div class="type-tabs" id="proj-modo-tabs" style="margin-bottom:24px;">
            <button class="type-tab active" id="ptab-saida" onclick="A.setProjType('saida')">üí∏ Projetar Sa√≠da</button>
            <button class="type-tab" id="ptab-entrada" onclick="A.setProjType('entrada')">üí∞ Projetar Entrada</button>
        </div>

        <div class="form-group">
            <label class="form-label" for="pf-nome">Descri√ß√£o da Proje√ß√£o *</label>
            <input type="text" id="pf-nome" class="form-input" placeholder="Ex: Contrato X, Imposto Y..." autocomplete="off" required>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label" for="pf-valor">Valor Estimado (R$) *</label>
                <input type="text" id="pf-valor" class="form-input" placeholder="0,00" oninput="A.maskMoney(event)" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="pf-mes">M√™s/Compet√™ncia *</label>
                <input type="month" id="pf-mes" class="form-input" required>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label" for="pf-cat">Categoria</label>
            <select id="pf-cat" class="form-input"></select>
        </div>
        <div class="form-group">
            <label class="form-label" for="pf-status">Grau de Certeza</label>
            <select id="pf-status" class="form-input">
                <option value="Previsto">‚è≥ Apenas Previsto (Simula√ß√£o)</option>
                <option value="Confirmado">‚úÖ Confirmado (Certeza)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label" for="pf-desc">Observa√ß√£o (opcional)</label>
            <input type="text" id="pf-desc" class="form-input" placeholder="Detalhes ou justificativa..." autocomplete="off">
        </div>
        <button class="form-save" id="btn-proj-save" onclick="A.saveProj()">
            <i data-lucide="save" width="20" height="20"></i> Salvar Proje√ß√£o
        </button>
    </div>

    <div class="drawer-overlay" id="export-overlay" onclick="A.closeExportModal()"></div>
    <div class="modal-export" id="export-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h3 class="font-title" style="font-size: 22px; color: white; display:flex; align-items:center; gap:10px;">
                <i data-lucide="file-down" style="color:var(--primary);"></i> Gerar Relat√≥rio
            </h3>
            <button class="btn-ghost" onclick="A.closeExportModal()" style="padding:8px;"><i data-lucide="x" width="16" height="16"></i></button>
        </div>
        <div class="form-group">
            <label class="form-label">Formato do Arquivo</label>
            <select id="exp-format" class="form-input">
                <option value="pdf">üìÑ Documento PDF</option>
                <option value="csv">üìä Tabela CSV (Excel)</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Per√≠odo de Refer√™ncia</label>
            <select id="exp-period" class="form-input">
                <option value="1">üìÖ M√™s Atual</option>
                <option value="3">üìÖ Trimestre (√öltimos 3 meses)</option>
                <option value="6">üìÖ Semestre (√öltimos 6 meses)</option>
                <option value="12">üìÖ Anual (Este Ano Inteiro)</option>
            </select>
        </div>
        <button class="form-save" onclick="A.runExport()">
            <i data-lucide="download" width="20" height="20"></i> Gerar e Baixar
        </button>
    </div>

    <div id="toast-wrap" role="region" aria-live="polite" aria-label="Notifica√ß√µes"></div>

    <script>
        const DB = { 
            url: "https://urpuiznydrlwmaqhdids.supabase.co/rest/v1/painel_gastos?id=eq.1", 
            key: "sb_publishable_9G6JUKnfZ1mekk7qUKdTQA_TXbARtR0" 
        };
        const MONTHS = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const CATS = {
            fixos: ["Software e Automa√ß√£o", "Nuvem e Infra", "Pr√≥-labore e Equipe", "Marketing Fixo", "Estrutura", "Outros Custos Fixos"],
            unicos: ["Hardware e Pe√ßas", "Tr√°fego Pago", "Impostos e Taxas", "Terceirizados", "Eventos", "Gasto N√£o Previsto"],
            entradas: ["Servi√ßo Prestado", "Mensalidade Cliente", "Projeto √önico", "Consultoria", "Revenda", "Outras Receitas"]
        };
        const RECOR_HINTS = { unico: "Lan√ßamento pontual, somente neste m√™s.", mensal: "Replica automaticamente para todos os 12 meses do ano selecionado.", proximo: "Replica a partir do m√™s da data informada at√© dezembro do mesmo ano." };

        const A = {
            state: { tab: 'overview', type: 'fixos', modo: 'despesa', pTipo: 'saida', data: { fixos: [], unicos: [], entradas: [], projecoes: { entradas: [], saidas: [] } }, supportsEntradas: true },
            ch: { area: null, donut: null },

            init() {
                lucide.createIcons();
                const sel = document.getElementById('fMonth');
                MONTHS.forEach((m, i) => sel.innerHTML += `<option value="${i}">${m}</option>`);
                sel.value = new Date().getMonth();
                document.getElementById('lp').addEventListener('keypress', e => { if (e.key === 'Enter') A.login() });
                document.getElementById('lu').addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('lp').focus() });
                document.querySelectorAll('.card').forEach(card => {
                    card.addEventListener('mousemove', e => { const r = card.getBoundingClientRect(); card.style.setProperty('--mouse-x', `${e.clientX - r.left}px`); card.style.setProperty('--mouse-y', `${e.clientY - r.top}px`); });
                });
            },

            // --- üõ°Ô∏è Gera√ß√£o de IDs Blindada ---
            genId(prefix) {
                return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
            },

            // --- üõ°Ô∏è Persist√™ncia Local Completa ---
            saveLocal() {
                try {
                    localStorage.setItem('bg_cfo_data', JSON.stringify({
                        fixos: A.state.data.fixos || [],
                        unicos: A.state.data.unicos || [],
                        entradas: A.state.data.entradas || []
                    }));
                } catch(e) {}
            },

            loadLocal() {
                try {
                    const stored = localStorage.getItem('bg_cfo_data');
                    if(stored) {
                        const parsed = JSON.parse(stored);
                        A.state.data.fixos = parsed.fixos || [];
                        A.state.data.unicos = parsed.unicos || [];
                        A.state.data.entradas = parsed.entradas || [];
                    }
                } catch(e) {}
            },

            login() {
                const u = document.getElementById('lu').value.trim().toLowerCase(), p = document.getElementById('lp').value, lc = document.getElementById('login-card');
                const btn = document.getElementById('btn-login');
                if (u === 'bgtech' && p === 'admin2024') {
                    if(btn) btn.classList.add('loading');
                    lc.style.animation = 'none'; lc.style.transform = 'scale(1.05)'; lc.style.opacity = '0'; lc.style.transition = 'all 0.5s ease';
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('app').classList.add('visible');
                        A.loadProjecoes();
                        A.initCharts(); 
                        A.fetchSync(); // Fetch vai fazer o fallback para local cache automaticamente se falhar
                        setInterval(() => A.fetchSync(true), 15000);
                        A.onReportTipoChange();
                        lucide.createIcons();
                    }, 500);
                } else {
                    A.toast("Credenciais inv√°lidas.", "err"); lc.classList.remove('shake'); void lc.offsetWidth; lc.classList.add('shake');
                    document.getElementById('lp').value = ''; document.getElementById('lp').focus();
                }
            },

            tab(t) {
                A.state.tab = t;
                document.querySelectorAll('[data-tab]').forEach(b => { const a = b.dataset.tab === t; b.classList.toggle('active', a); b.setAttribute('aria-current', a ? 'page' : 'false'); });
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                
                let viewId;
                if (t === 'overview') viewId = 'view-overview';
                else if (t === 'annual') viewId = 'view-annual';
                else if (t === 'entradas') viewId = 'view-entradas';
                else if (t === 'relatorios') viewId = 'view-relatorios';
                else if (t === 'projecoes') viewId = 'view-projecoes';
                else viewId = 'view-list';
                
                document.getElementById(viewId).classList.add('active');
                
                const titles = {
                    overview: ['Painel Geral', 'Monitoramento de despesas operacionais em tempo real'],
                    annual: ['Balan√ßo Anual', 'Proje√ß√£o e realizado por m√™s'],
                    fixos: ['Custos Fixos', 'Despesas recorrentes da opera√ß√£o'],
                    unicos: ['Gastos Vari√°veis', 'Despesas pontuais e extras'],
                    entradas: ['Entradas', 'Receitas e pagamentos recebidos'],
                    relatorios: ['Relat√≥rios', 'Exportar relat√≥rios financeiros'],
                    projecoes: ['Proje√ß√µes Futuras', 'Vis√£o e simula√ß√£o de fluxo (n√£o afeta dados reais)']
                };
                document.getElementById('page-title').textContent = titles[t][0];
                document.getElementById('page-sub').innerHTML = `<i data-lucide="activity" width="16" height="16"></i> ${titles[t][1]}`;
                
                const addLabel = document.getElementById('btn-add-label');
                const addBtn = document.getElementById('btn-add-main');
                const hGroup = document.getElementById('main-filters');

                if(t === 'projecoes') {
                    if(hGroup) hGroup.style.display = 'none';
                    addLabel.textContent = 'Nova Proje√ß√£o'; 
                    addBtn.className = 'btn-primary'; 
                    addBtn.style.display = ''; 
                    addBtn.onclick = () => A.openProjDrawer('saida');
                    A.renderProjecoes();
                } else {
                    if(hGroup) hGroup.style.display = 'flex';
                    if (t === 'entradas') { addLabel.textContent = 'Nova Entrada'; addBtn.className = 'btn-success'; addBtn.style.display = ''; addBtn.onclick = () => A.openDrawer(null, 'entrada'); }
                    else if (t === 'relatorios') { addBtn.style.display = 'none'; }
                    else { addLabel.textContent = 'Novo Gasto'; addBtn.className = 'btn-primary'; addBtn.style.display = ''; addBtn.onclick = () => A.openDrawer(); }
                    A.render();
                }
                
                lucide.createIcons();
                if (t === 'relatorios') A.renderRelatorios();
            },

            async fetchSync(silent = false) {
                if (!silent) A.syncUI('load');
                A.loadLocal(); // Prote√ß√£o: sempre carregar da RAM local primeiro
                A.render(); // Renderiza na hora, sem esperar o banco

                try {
                    const r = await fetch(DB.url, { headers: { apikey: DB.key, Authorization: `Bearer ${DB.key}`, 'Cache-Control': 'no-cache' } });
                    if (!r.ok) throw new Error("HTTP error " + r.status);
                    const d = await r.json();
                    if (d && d[0]) {
                        A.state.data.fixos = Array.isArray(d[0].fixos) ? d[0].fixos : JSON.parse(d[0].fixos || '[]');
                        A.state.data.unicos = Array.isArray(d[0].unicos) ? d[0].unicos : JSON.parse(d[0].unicos || '[]');
                        A.state.data.entradas = Array.isArray(d[0].entradas) ? d[0].entradas : JSON.parse(d[0].entradas || '[]');
                        A.saveLocal(); // Sobrescreve local apenas se o banco respondeu com sucesso
                    }
                    A.syncUI('ok'); 
                    A.render();
                } catch (e) { 
                    A.syncUI('err'); 
                    if(!silent) A.toast("Trabalhando Offline. Dados em cache.", "warning");
                }
            },

            async pushSync() {
                A.syncUI('load');
                A.saveLocal(); // Garantia 100% que o dado j√° est√° salvo na m√°quina
                try {
                    const payload = { fixos: A.state.data.fixos || [], unicos: A.state.data.unicos || [], updated_at: new Date().toISOString() };
                    if (A.state.supportsEntradas) payload.entradas = A.state.data.entradas || [];
                    
                    const r = await fetch(DB.url, { method: 'PATCH', headers: { apikey: DB.key, Authorization: `Bearer ${DB.key}`, 'Content-Type': 'application/json', Prefer: 'return=minimal' }, body: JSON.stringify(payload) });
                    if (!r.ok && A.state.supportsEntradas) {
                        A.state.supportsEntradas = false;
                        delete payload.entradas;
                        await fetch(DB.url, { method: 'PATCH', headers: { apikey: DB.key, Authorization: `Bearer ${DB.key}`, 'Content-Type': 'application/json', Prefer: 'return=minimal' }, body: JSON.stringify(payload) });
                    }
                    A.syncUI('ok');
                } catch (e) { 
                    A.syncUI('err'); 
                    A.toast("Erro na Nuvem. Salvo localmente.", "warning"); 
                }
            },

            syncUI(s) { const dot = document.getElementById('sync-dot'), txt = document.getElementById('sync-txt'), m = { load: ['var(--warning)', 'Sincronizando...'], ok: ['var(--success)', 'Nuvem Conectada'], err: ['var(--danger)', 'Modo Offline'] }; dot.style.background = m[s][0]; dot.style.boxShadow = `0 0 12px ${m[s][0]}`; txt.textContent = m[s][1]; },
            maskMoney(e) { let v = e.target.value.replace(/\D/g, ''); if (!v) { e.target.value = ''; return; } v = (parseInt(v) / 100).toFixed(2); e.target.value = v.replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); },
            cleanMoney(s) { return parseFloat((s || '0').replace(/\./g, '').replace(',', '.')) || 0; },
            fmtR(v) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0); },
            fmtD(d) { if (!d) return '--'; const p = d.split('-'); return p.length === 3 ? `${p[2]}/${p[1]}` : d; },
            parseDate(d) { if (!d) return null; const p = d.split('-'); return p.length === 3 ? { y: +p[0], m: +p[1] - 1, d: +p[2] } : null; },
            filterByMonth(arr, m, y) { return (arr||[]).filter(x => { const p = A.parseDate(x.data); return p && p.m === m && p.y === y; }); },
            filterByYear(arr, y) { return (arr||[]).filter(x => { const p = A.parseDate(x.data); return p && p.y === y; }); },
            filterByRange(arr, sm, em, y) { return (arr||[]).filter(x => { const p = A.parseDate(x.data); return p && p.y === y && p.m >= sm && p.m <= em; }); },

            render() {
                if(A.state.tab === 'projecoes') return; 
                
                const mVal = document.getElementById('fMonth').value, year = parseInt(document.getElementById('fYear').value), t = A.state.tab;
                let fixos, unicos, entradas;
                if (mVal === 'anual') { fixos = A.filterByYear(A.state.data.fixos, year); unicos = A.filterByYear(A.state.data.unicos, year); entradas = A.filterByYear(A.state.data.entradas, year); }
                else { const mo = parseInt(mVal); fixos = A.filterByMonth(A.state.data.fixos, mo, year); unicos = A.filterByMonth(A.state.data.unicos, mo, year); entradas = A.filterByMonth(A.state.data.entradas, mo, year); }

                const sumF = fixos.reduce((a, b) => a + Number(b.valor), 0);
                const sumU = unicos.reduce((a, b) => a + Number(b.valor), 0);
                const sumSaidas = sumF + sumU;
                const sumE = entradas.reduce((a, b) => a + Number(b.valor), 0);
                const sumMRR = entradas.filter(x => x.recorrente === 'mensal' || x.recorrente === 'proximo').reduce((a, b) => a + Number(b.valor), 0);
                const sumER = entradas.filter(x => x.recorrente === 'mensal' || x.recorrente === 'proximo').reduce((a, b) => a + Number(b.valor), 0);
                const sumEA = entradas.filter(x => x.recorrente === 'unico' || !x.recorrente).reduce((a, b) => a + Number(b.valor), 0);
                const saldo = sumE - sumSaidas;
                const margem = sumE > 0 ? ((saldo / sumE) * 100).toFixed(1) : '0.0';

                // --- ü§ñ INTELIG√äNCIA CFO (Alertas autom√°ticos no Painel Geral) ---
                if(t === 'overview') {
                    A.animateValue('v-receita-ov', sumE, false, 'var(--success)');
                    A.animateValue('v-mrr-ov', sumMRR);
                    A.animateValue('v-total', sumSaidas, false, 'var(--danger)');
                    A.animateValue('v-fixos', sumF);
                    A.animateValue('v-unicos', sumU);
                    A.animateValue('v-saldo-ov', saldo);

                    const cardSaldoOv = document.getElementById('card-saldo-ov');
                    const elSaldoOv = document.getElementById('v-saldo-ov');
                    const elSaldoOvSub = document.getElementById('v-saldo-ov-sub');
                    if (cardSaldoOv && elSaldoOv) {
                        if (saldo >= 0) {
                            cardSaldoOv.style.borderTopColor = 'var(--success)';
                            elSaldoOv.style.color = 'var(--success)';
                            if (elSaldoOvSub) elSaldoOvSub.innerHTML = `<i data-lucide="trending-up" width="14" height="14"></i> Margem: +${margem}% de lucro`;
                        } else {
                            cardSaldoOv.style.borderTopColor = 'var(--danger)';
                            elSaldoOv.style.color = 'var(--danger)';
                            if (elSaldoOvSub) elSaldoOvSub.innerHTML = `<i data-lucide="trending-down" width="14" height="14"></i> Margem negativa: ${margem}%`;
                        }
                    }

                    // Renderiza CFO Insights se estiver vendo um M√™s Espec√≠fico
                    const insightsEl = document.getElementById('cfo-insights');
                    if(insightsEl) {
                        if(mVal !== 'anual') {
                            const mo = parseInt(mVal);
                            let prevM = mo - 1, prevY = year;
                            if (prevM < 0) { prevM = 11; prevY--; }
                            
                            const prevE = A.filterByMonth(A.state.data.entradas, prevM, prevY).reduce((a,b)=>a+Number(b.valor),0);
                            let html = '';
                            
                            if(saldo < 0) html += `<div class="insight-card danger"><i data-lucide="alert-triangle"></i><div><strong>Risco de Caixa (Burn Rate)</strong>Sua opera√ß√£o queimou R$ ${A.fmtR(Math.abs(saldo))} a mais do que arrecadou.</div></div>`;
                            if(sumE > 0 && (sumF / sumE) > 0.6) html += `<div class="insight-card warning"><i data-lucide="alert-circle"></i><div><strong>Peso Estrutural Alto</strong>Seus custos fixos est√£o consumindo ${((sumF/sumE)*100).toFixed(0)}% da sua receita. Teto ideal √© 50%.</div></div>`;
                            if(prevE > 0) {
                                const varE = ((sumE - prevE) / prevE) * 100;
                                const isUp = varE >= 0;
                                html += `<div class="insight-card ${isUp ? 'success' : 'warning'}"><i data-lucide="${isUp ? 'trending-up' : 'trending-down'}"></i><div><strong>Varia√ß√£o de Receita (MoM)</strong>Faturamento ${isUp ? 'cresceu' : 'encolheu'} ${Math.abs(varE).toFixed(1)}% em rela√ß√£o a ${MONTHS[prevM]}.</div></div>`;
                            }
                            if(html === '') html = `<div class="insight-card success"><i data-lucide="check-circle"></i><div><strong>Opera√ß√£o Saud√°vel</strong>Margens e teto de gastos fixos dentro da normalidade para o per√≠odo.</div></div>`;
                            
                            insightsEl.innerHTML = html;
                        } else {
                            insightsEl.innerHTML = '';
                        }
                    }
                }

                if(t === 'entradas') {
                    A.animateValue('v-receita-total', sumE, false, 'var(--success)');
                    A.animateValue('v-receita-recor', sumER);
                    A.animateValue('v-receita-avulsa', sumEA);
                    A.animateValue('v-saldo-entradas', saldo);

                    const cardSaldoEnt = document.getElementById('card-saldo-ent');
                    const elSaldoEnt = document.getElementById('v-saldo-entradas');
                    if (cardSaldoEnt && elSaldoEnt) {
                        if (saldo >= 0) { cardSaldoEnt.style.borderTopColor = 'var(--success)'; elSaldoEnt.style.color = 'var(--success)'; }
                        else { cardSaldoEnt.style.borderTopColor = 'var(--danger)'; elSaldoEnt.style.color = 'var(--danger)'; }
                    }
                }

                if (t === 'fixos' || t === 'unicos') A.renderTable(t === 'fixos' ? fixos : unicos, 'table-body', 'table-empty', 'gasto');
                if (t === 'entradas') A.renderTable(entradas, 'table-entradas', 'entradas-empty', 'entrada');
                if (t === 'annual') A.renderAnnual(year);
                A.updateCharts();
                lucide.createIcons();
            },

            animateValue(id, value, isInt = false, forceColor = null) {
                const el = document.getElementById(id); if (!el) return;
                const absVal = Math.abs(value);
                const start = parseFloat(el.textContent.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
                const duration = 800, startTime = performance.now();
                if (forceColor) el.style.color = forceColor;
                const animate = (ct) => {
                    const elapsed = ct - startTime, progress = Math.min(elapsed / duration, 1), ep = 1 - Math.pow(1 - progress, 3);
                    const cur = Math.abs(start) + (absVal - Math.abs(start)) * ep;
                    el.textContent = isInt ? Math.round(cur) : (value < 0 ? '- ' + A.fmtR(cur) : A.fmtR(cur));
                    if (progress < 1) requestAnimationFrame(animate);
                    else el.textContent = isInt ? Math.round(value) : (value < 0 ? '- ' + A.fmtR(absVal) : A.fmtR(absVal));
                };
                requestAnimationFrame(animate);
            },

            renderTable(list, tbodyId, emptyId, tipo) {
                const searchQ = (document.getElementById(tipo === 'entrada' ? 'search-entradas' : 'search-gastos')?.value || '').toLowerCase();
                const filtered = list.filter(i => (i.nome||'').toLowerCase().includes(searchQ) || (i.categoria||'').toLowerCase().includes(searchQ));
                
                const sorted = [...filtered].sort((a, b) => (b.data || '').localeCompare(a.data || ''));
                const tbody = document.getElementById(tbodyId), empty = document.getElementById(emptyId);
                if (sorted.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; }
                else {
                    empty.style.display = 'none';
                    const isIncome = tipo === 'entrada';
                    tbody.innerHTML = sorted.map((i, idx) => {
                        const isPend = i.status === 'Pendente', isRecur = i.recorrente === 'mensal' || i.recorrente === 'proximo';
                        return `<tr style="animation:fadeInUp 0.5s ease ${idx * 50}ms both;">
          <td style="color:var(--text-muted);font-size:13px;font-weight:600;white-space:nowrap">${A.fmtD(i.data)}</td>
          <td><div class="item-name">${esc(i.nome)}</div>${i.descricao ? `<div class="item-desc">${esc(i.descricao)}</div>` : ''}</td>
          <td><span class="cat-badge${isIncome ? ' income' : ''}">${esc(i.categoria || '‚Äî')}</span></td>
          <td><span class="recur-badge ${isRecur ? 'sim' : 'nao'}">${isRecur ? 'üîÑ Mensal' : '√önico'}</span></td>
          <td><span class="status-badge ${isPend ? 'pendente' : 'pago'}">${isPend ? '‚è≥ Pendente' : '‚úÖ ' + (isIncome ? 'Recebido' : 'Pago')}</span></td>
          <td class="amount-cell font-title" style="color:${isIncome ? 'var(--success)' : (isPend ? 'var(--text-muted)' : 'var(--text)')}">${isIncome ? '+ ' : ''}${A.fmtR(i.valor)}</td>
          <td style="text-align:center;white-space:nowrap">
            <button class="action-btn" onclick="A.edit('${i.id}')" title="Editar"><i data-lucide="edit-2" width="16" height="16"></i></button>
            <button class="action-btn del" onclick="A.del('${i.id}')" title="Excluir"><i data-lucide="trash-2" width="16" height="16"></i></button>
          </td></tr>`;
                    }).join('');
                    lucide.createIcons();
                }
            },

            renderAnnual(year) {
                document.getElementById('annual-title').textContent = `Balan√ßo Anual ${year}`;
                const grid = document.getElementById('annual-grid'), now = new Date();
                let allIn = [], allOut = [];
                for (let m = 0; m < 12; m++) {
                    allIn.push(A.filterByMonth(A.state.data.entradas || [], m, year).reduce((a, b) => a + Number(b.valor), 0));
                    allOut.push(A.filterByMonth(A.state.data.fixos || [], m, year).reduce((a, b) => a + Number(b.valor), 0) + A.filterByMonth(A.state.data.unicos || [], m, year).reduce((a, b) => a + Number(b.valor), 0));
                }
                const yearIn = allIn.reduce((a, b) => a + b, 0);
                const yearOut = allOut.reduce((a, b) => a + b, 0);
                const yearSaldo = yearIn - yearOut;
                const elTotalIn = document.getElementById('annual-total-in');
                const elTotalOut = document.getElementById('annual-total-out');
                const elSaldo = document.getElementById('annual-saldo');
                if (elTotalIn) elTotalIn.textContent = A.fmtR(yearIn);
                if (elTotalOut) elTotalOut.textContent = A.fmtR(yearOut);
                if (elSaldo) { elSaldo.textContent = A.fmtR(yearSaldo); elSaldo.style.color = yearSaldo >= 0 ? 'var(--success)' : 'var(--danger)'; }
                const maxVal = Math.max(...allIn, ...allOut, 1);
                grid.innerHTML = MONTHS.map((name, m) => {
                    const inv = allIn[m], outv = allOut[m], saldo = inv - outv;
                    const isCur = m === now.getMonth() && year === now.getFullYear();
                    const pctIn = Math.round((inv / maxVal) * 100);
                    const pctOut = Math.round((outv / maxVal) * 100);
                    return `<div class="month-tile${isCur ? ' current' : ''}" onclick="A.goToMonth(${m},${year})" style="animation:fadeInUp 0.5s ease ${m * 50}ms both;">
        <div class="month-tile-name">${name}${isCur ? ' <span style="font-size:11px;color:var(--primary);font-weight:800;">‚óè ATUAL</span>' : ''}</div>
        <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px;">
          <div style="color:var(--success);font-weight:800;font-size:13px;">+ ${A.fmtR(inv)}</div>
          <div style="color:var(--danger);font-weight:800;font-size:13px;">- ${A.fmtR(outv)}</div>
        </div>
        <div style="height:5px;background:rgba(255,255,255,0.05);border-radius:3px;display:flex;overflow:hidden;margin-bottom:10px;">
          <div style="background:var(--success);width:${pctIn}%;border-radius:3px 0 0 3px;transition:width 0.8s var(--transition);"></div>
          <div style="background:var(--danger);width:${pctOut}%;border-radius:0 3px 3px 0;transition:width 0.8s var(--transition);"></div>
        </div>
        <div style="font-size:12px;text-align:right;font-weight:800;color:${saldo >= 0 ? 'var(--success)' : 'var(--danger)'}">
          Saldo: ${saldo >= 0 ? '+' : ''}${A.fmtR(saldo)}
        </div>
      </div>`;
                }).join('');
            },

            goToMonth(m, y) { document.getElementById('fMonth').value = m; document.getElementById('fYear').value = y; A.tab('overview'); },

            initCharts() {
                const base = { chart: { background: 'transparent', fontFamily: 'Inter', toolbar: { show: false }, animations: { enabled: true, speed: 800, easing: 'easeinout' } }, theme: { mode: 'dark' } };
                A.ch.area = new ApexCharts(document.querySelector('#chart-area'), {
                    ...base,
                    series: [{ name: 'Receitas', data: [] }, { name: 'Despesas', data: [] }],
                    chart: { ...base.chart, type: 'area', height: 300 },
                    colors: ['#10b981', '#ef4444'],
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.05, stops: [0, 90, 100] } },
                    stroke: { curve: 'smooth', width: 3 },
                    dataLabels: { enabled: false },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4, xaxis: { lines: { show: false } } },
                    xaxis: { categories: [], labels: { style: { colors: '#94a3b8', fontSize: '13px', fontWeight: 600 } }, axisBorder: { show: false }, axisTicks: { show: false } },
                    yaxis: { labels: { style: { colors: '#94a3b8', fontSize: '12px' }, formatter: v => `R$${(v / 1000).toFixed(0)}k` } },
                    legend: { labels: { colors: '#94a3b8' }, fontWeight: 600 },
                    tooltip: { theme: 'dark', x: { show: true }, y: { formatter: v => A.fmtR(v) } }
                });
                A.ch.area.render();
                A.ch.donut = new ApexCharts(document.querySelector('#chart-donut'), { ...base, series: [], labels: [], chart: { ...base.chart, type: 'donut', height: 300 }, colors: ['#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd', '#0284c7', '#0369a1'], stroke: { show: true, colors: ['#0d1117'], width: 3 }, dataLabels: { enabled: false }, legend: { position: 'bottom', labels: { colors: '#94a3b8' }, fontSize: '13px', fontWeight: 600, itemMargin: { horizontal: 10, vertical: 5 } }, plotOptions: { pie: { donut: { size: '75%', labels: { show: true, name: { color: '#94a3b8', fontSize: '14px', fontWeight: 600 }, value: { color: 'white', fontSize: '24px', fontWeight: 900, formatter: v => A.fmtR(v) }, total: { show: true, label: 'Total Fixos', color: '#94a3b8', fontSize: '14px', fontWeight: 600, formatter: w => A.fmtR(w.globals.seriesTotals.reduce((a, b) => a + b, 0)) } } } } }, tooltip: { theme: 'dark', y: { formatter: v => A.fmtR(v) } } });
                A.ch.donut.render();
            },

            updateCharts() {
                if (!A.ch.area) return;
                const aRec = [], aDesp = [], aCats = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - i);
                    const m = d.getMonth(), y = d.getFullYear();
                    aRec.push(A.filterByMonth(A.state.data.entradas || [], m, y).reduce((a, b) => a + Number(b.valor), 0));
                    aDesp.push(A.filterByMonth(A.state.data.fixos || [], m, y).reduce((a, b) => a + Number(b.valor), 0) + A.filterByMonth(A.state.data.unicos || [], m, y).reduce((a, b) => a + Number(b.valor), 0));
                    aCats.push(MONTHS[m].substring(0, 3));
                }
                A.ch.area.updateSeries([{ name: 'Receitas', data: aRec }, { name: 'Despesas', data: aDesp }]);
                A.ch.area.updateOptions({ xaxis: { categories: aCats } });
                const mVal = document.getElementById('fMonth').value, year = parseInt(document.getElementById('fYear').value);
                let curFixos; if (mVal === 'anual') curFixos = A.filterByYear(A.state.data.fixos, year); else curFixos = A.filterByMonth(A.state.data.fixos, parseInt(mVal), year);
                const catMap = {}; curFixos.forEach(x => { catMap[x.categoria] = (catMap[x.categoria] || 0) + Number(x.valor); });
                const labels = Object.keys(catMap), series = Object.values(catMap);
                if (series.length > 0) { A.ch.donut.updateOptions({ labels }); A.ch.donut.updateSeries(series); }
                else { A.ch.donut.updateSeries([1]); A.ch.donut.updateOptions({ labels: ['Sem dados'], colors: ['#1e293b'] }); }
            },

            // ‚îÄ‚îÄ DRAWER REAL ‚îÄ‚îÄ
            setModo(modo) {
                A.state.modo = modo;
                document.getElementById('tab-modo-despesa').classList.toggle('active', modo === 'despesa');
                document.getElementById('tab-modo-entrada').classList.toggle('active', modo === 'entrada');
                const subTabs = document.getElementById('sub-type-tabs');
                const lblNome = document.getElementById('lbl-nome');
                const lblStatus = document.getElementById('lbl-status');
                const saveBtn = document.getElementById('btn-save');
                if (modo === 'entrada') {
                    subTabs.style.display = 'none';
                    lblNome.textContent = 'De onde vem a receita? *';
                    lblStatus.textContent = 'Status do Recebimento';
                    saveBtn.className = 'form-save save-income';
                    saveBtn.innerHTML = '<i data-lucide="save" width="20" height="20"></i> Salvar Entrada';
                    document.getElementById('drawer-title').textContent = 'Nova Entrada';
                    const sel = document.getElementById('f-cat'); sel.innerHTML = '';
                    CATS.entradas.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                } else {
                    subTabs.style.display = 'flex';
                    lblNome.textContent = 'O que est√° sendo pago? *';
                    lblStatus.textContent = 'Status do Pagamento';
                    saveBtn.className = 'form-save';
                    saveBtn.innerHTML = '<i data-lucide="save" width="20" height="20"></i> Salvar Registro';
                    document.getElementById('drawer-title').textContent = 'Novo Gasto';
                    A.setType(A.state.type);
                }
                lucide.createIcons();
            },

            openDrawer(item = null, modo = null) {
                document.getElementById('drawer').classList.add('open'); document.getElementById('overlay').classList.add('open');
                document.getElementById('overlay').setAttribute('aria-hidden', 'false');
                if (item) {
                    const isEntrada = (A.state.data.entradas||[]).some(i => i.id === item.id);
                    const isFixo = (A.state.data.fixos||[]).some(i => i.id === item.id);
                    A.setModo(isEntrada ? 'entrada' : 'despesa');
                    if (!isEntrada) A.setType(isFixo ? 'fixos' : 'unicos');
                    document.getElementById('drawer-title').textContent = isEntrada ? 'Editar Entrada' : 'Editar Gasto';
                    document.getElementById('f-id').value = item.id;
                    document.getElementById('f-nome').value = item.nome;
                    document.getElementById('f-valor').value = A.fmtR(item.valor).replace('R$\u00a0', '').replace('R$', '').trim();
                    document.getElementById('f-data').value = item.data || '';
                    document.getElementById('f-cat').value = item.categoria || '';
                    document.getElementById('f-status').value = item.status || 'Pago';
                    document.getElementById('f-desc').value = item.descricao || '';
                    document.getElementById('f-recor').value = item.recorrente || 'unico';
                    A.onRecorChange();
                } else {
                    A.setModo(modo || 'despesa');
                    const defType = A.state.tab === 'unicos' ? 'unicos' : 'fixos';
                    if (A.state.modo === 'despesa') A.setType(defType);
                    document.getElementById('f-id').value = ''; document.getElementById('f-nome').value = '';
                    document.getElementById('f-valor').value = ''; document.getElementById('f-data').value = new Date().toISOString().split('T')[0];
                    document.getElementById('f-status').value = 'Pago'; document.getElementById('f-desc').value = '';
                    document.getElementById('f-recor').value = 'unico'; A.onRecorChange();
                }
                setTimeout(() => document.getElementById('f-nome').focus(), 100); lucide.createIcons();
            },

            closeDrawer() { document.getElementById('drawer').classList.remove('open'); document.getElementById('overlay').classList.remove('open'); document.getElementById('overlay').setAttribute('aria-hidden', 'true'); },

            setType(t) {
                A.state.type = t;
                document.getElementById('tab-fixos').classList.toggle('active', t === 'fixos');
                document.getElementById('tab-unicos').classList.toggle('active', t === 'unicos');
                const sel = document.getElementById('f-cat'); sel.innerHTML = '';
                CATS[t].forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            },

            onRecorChange() { const v = document.getElementById('f-recor').value; document.getElementById('recor-hint').innerHTML = `<i data-lucide="info" width="14" height="14"></i> ${RECOR_HINTS[v] || ''}`; lucide.createIcons(); },

            async save() {
                const btn = document.getElementById('btn-save');
                if(btn.classList.contains('loading')) return; // Bloqueio UI Duplo Clique

                const nome = document.getElementById('f-nome').value.trim(), valor = A.cleanMoney(document.getElementById('f-valor').value);
                if (!nome || valor <= 0) { A.toast("Preencha nome e valor v√°lido.", "err"); document.getElementById('f-nome').focus(); return; }
                
                btn.classList.add('loading');
                try {
                    const dataBase = document.getElementById('f-data').value, recorrente = document.getElementById('f-recor').value, editId = document.getElementById('f-id').value;
                    const base = { nome, valor, data: dataBase, categoria: document.getElementById('f-cat').value, status: document.getElementById('f-status').value, descricao: document.getElementById('f-desc').value.trim(), recorrente };
                    const isIncome = A.state.modo === 'entrada';
                    const arrKey = isIncome ? 'entradas' : A.state.type;
                    const arr = A.state.data[arrKey] || [];
                    
                    if (editId) {
                        ['fixos', 'unicos', 'entradas'].forEach(k => { A.state.data[k] = (A.state.data[k]||[]).filter(i => i.id !== editId); });
                        arr.push({ id: editId, ...base });
                    } else {
                        if (recorrente === 'mensal') {
                            const [y, , d] = dataBase.split('-');
                            for (let m = 0; m < 12; m++) arr.push({ id: A.genId('bgt'), ...base, data: `${y}-${String(m + 1).padStart(2, '0')}-${d}` });
                            A.toast(`12 ${isIncome ? 'entradas' : 'lan√ßamentos'} mensais criados! ‚ú®`);
                        } else if (recorrente === 'proximo') {
                            const [y, mo, d] = dataBase.split('-'); const startM = parseInt(mo) - 1; let count = 0;
                            for (let m = startM; m < 12; m++) { arr.push({ id: A.genId('bgt'), ...base, data: `${y}-${String(m + 1).padStart(2, '0')}-${d}` }); count++; }
                            A.toast(`${count} ${isIncome ? 'entradas' : 'lan√ßamentos'} criados! ‚ú®`);
                        } else {
                            arr.push({ id: A.genId('bgt'), ...base });
                            A.toast(`${isIncome ? 'Entrada registrada' : 'Registro salvo'} com sucesso! ‚úÖ`);
                        }
                    }
                    
                    A.state.data[arrKey] = arr;
                    A.closeDrawer(); 
                    A.render(); 
                    await A.pushSync();
                } finally {
                    btn.classList.remove('loading');
                }
            },

            edit(id) { const item = (A.state.data.fixos||[]).find(i => i.id === id) || (A.state.data.unicos||[]).find(i => i.id === id) || (A.state.data.entradas||[]).find(i => i.id === id); if (item) A.openDrawer(item); },

            del(id) {
                if (confirm("Confirmar exclus√£o permanente deste registro?")) {
                    A.state.data.fixos = A.state.data.fixos.filter(i => i.id !== id);
                    A.state.data.unicos = A.state.data.unicos.filter(i => i.id !== id);
                    A.state.data.entradas = A.state.data.entradas.filter(i => i.id !== id);
                    A.render(); A.pushSync(); A.toast("Registro exclu√≠do. üóëÔ∏è");
                }
            },

            // ‚îÄ‚îÄ RELAT√ìRIOS ‚îÄ‚îÄ
            onReportTipoChange() {
                const tipo = document.getElementById('report-tipo').value;
                const sel = document.getElementById('report-period'); sel.innerHTML = '';
                if (tipo === 'mensal') MONTHS.forEach((m, i) => sel.innerHTML += `<option value="${i}">${m}</option>`);
                else if (tipo === 'trimestral') ['1¬∞ Trimestre (Jan-Mar)', '2¬∞ Trimestre (Abr-Jun)', '3¬∞ Trimestre (Jul-Set)', '4¬∞ Trimestre (Out-Dez)'].forEach((q, i) => sel.innerHTML += `<option value="${i}">${q}</option>`);
                else['1¬∞ Semestre (Jan-Jun)', '2¬∞ Semestre (Jul-Dez)'].forEach((s, i) => sel.innerHTML += `<option value="${i}">${s}</option>`);
                const curMonth = new Date().getMonth();
                if (tipo === 'mensal') sel.value = curMonth;
                else if (tipo === 'trimestral') sel.value = Math.floor(curMonth / 3);
                else sel.value = curMonth < 6 ? 0 : 1;
                A.renderRelatorios();
            },

            getReportRange() {
                const tipo = document.getElementById('report-tipo').value, period = parseInt(document.getElementById('report-period').value), year = parseInt(document.getElementById('report-year').value);
                let sm, em, label;
                if (tipo === 'mensal') { sm = em = period; label = `${MONTHS[period]} ${year}`; }
                else if (tipo === 'trimestral') { sm = period * 3; em = sm + 2; label = `${period + 1}¬∞ Trimestre ${year}`; }
                else { sm = period * 6; em = sm + 5; label = `${period + 1}¬∞ Semestre ${year}`; }
                return { sm, em, year, label };
            },

            renderRelatorios() {
                const { sm, em, year, label } = A.getReportRange();
                const entradas = A.filterByRange(A.state.data.entradas||[], sm, em, year);
                const fixos = A.filterByRange(A.state.data.fixos||[], sm, em, year);
                const unicos = A.filterByRange(A.state.data.unicos||[], sm, em, year);
                const totalE = entradas.reduce((a, b) => a + Number(b.valor), 0);
                const totalS = fixos.reduce((a, b) => a + Number(b.valor), 0) + unicos.reduce((a, b) => a + Number(b.valor), 0);
                const saldo = totalE - totalS; const totalMov = totalE + totalS;
                
                document.getElementById('report-kpis').innerHTML = `
      <div class="report-kpi"><div class="report-kpi-label">Total Movimentado</div><div class="report-kpi-value" style="color:var(--text)">${A.fmtR(totalMov)}</div></div>
      <div class="report-kpi"><div class="report-kpi-label">Total Entradas</div><div class="report-kpi-value positive">${A.fmtR(totalE)}</div></div>
      <div class="report-kpi"><div class="report-kpi-label">Total Sa√≠das</div><div class="report-kpi-value negative">${A.fmtR(totalS)}</div></div>
      <div class="report-kpi"><div class="report-kpi-label">Saldo do Per√≠odo</div><div class="report-kpi-value ${saldo >= 0 ? 'positive' : 'negative'}">${A.fmtR(saldo)}</div></div>`;
                
                const catMap = {};
                entradas.forEach(x => { const k = 'üì• ' + x.categoria; catMap[k] = (catMap[k] || { sum: 0, type: 'income' }); catMap[k].sum += Number(x.valor); });
                fixos.concat(unicos).forEach(x => { const k = 'üì§ ' + x.categoria; catMap[k] = (catMap[k] || { sum: 0, type: 'expense' }); catMap[k].sum += Number(x.valor); });
                const maxCat = Math.max(...Object.values(catMap).map(v => v.sum), 1);
                const catsEl = document.getElementById('report-cats');
                const sortedCats = Object.entries(catMap).sort((a, b) => b[1].sum - a[1].sum);
                if (sortedCats.length === 0) { catsEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);">Nenhum dado no per√≠odo selecionado</div>'; }
                else {
                    catsEl.innerHTML = sortedCats.map(([name, { sum, type }]) => {
                        const pct = Math.round((sum / maxCat) * 100);
                        return `<div class="report-cat-item">
        <div class="report-cat-name">${name}</div>
        <div class="report-cat-bar-wrap"><div class="report-cat-bar ${type}" style="width:${pct}%"></div></div>
        <div class="report-cat-val" style="color:${type === 'income' ? 'var(--success)' : 'var(--danger)'}">${A.fmtR(sum)}</div>
      </div>`;
                    }).join('');
                }
                lucide.createIcons();
            },

            // ‚îÄ‚îÄ PROJE√á√ïES M√ìDULO ISOLADO ‚îÄ‚îÄ
            loadProjecoes() {
                try {
                    const stored = localStorage.getItem('bg_projecoes');
                    if (stored) A.state.data.projecoes = JSON.parse(stored);
                    else A.state.data.projecoes = { entradas: [], saidas: [] };
                } catch(e) { A.state.data.projecoes = { entradas: [], saidas: [] }; }
            },

            saveProjecoes() {
                localStorage.setItem('bg_projecoes', JSON.stringify(A.state.data.projecoes));
            },

            setProjType(t) {
                A.state.pTipo = t;
                document.getElementById('ptab-entrada').classList.toggle('active', t === 'entrada');
                document.getElementById('ptab-saida').classList.toggle('active', t === 'saida');
                const sel = document.getElementById('pf-cat');
                sel.innerHTML = '';
                const cats = t === 'entrada' ? CATS.entradas : [...CATS.fixos, ...CATS.unicos];
                cats.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
                
                const btn = document.getElementById('btn-proj-save');
                if(t === 'entrada') {
                    btn.className = 'form-save save-income';
                } else {
                    btn.className = 'form-save';
                    btn.style.background = 'linear-gradient(135deg, var(--danger) 0%, #b91c1c 100%)';
                    btn.style.boxShadow = '0 6px 30px var(--danger-glow), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
                }
            },

            openProjDrawer(tipo, id = null) {
                document.getElementById('proj-drawer').classList.add('open'); 
                document.getElementById('proj-overlay').classList.add('open');
                
                if (id) {
                    const item = A.state.data.projecoes[tipo+'s'].find(i => i.id === id);
                    if(!item) return;
                    A.setProjType(tipo);
                    document.getElementById('proj-drawer-title').textContent = 'Editar Proje√ß√£o';
                    document.getElementById('pf-id').value = item.id;
                    document.getElementById('pf-nome').value = item.nome;
                    document.getElementById('pf-valor').value = A.fmtR(item.valor).replace('R$\u00a0', '').replace('R$', '').trim();
                    document.getElementById('pf-mes').value = item.mes;
                    document.getElementById('pf-cat').value = item.categoria || '';
                    document.getElementById('pf-status').value = item.status || 'Previsto';
                    document.getElementById('pf-desc').value = item.descricao || '';
                } else {
                    A.setProjType(tipo || 'saida');
                    document.getElementById('proj-drawer-title').textContent = 'Nova Proje√ß√£o';
                    document.getElementById('pf-id').value = '';
                    document.getElementById('pf-nome').value = '';
                    document.getElementById('pf-valor').value = '';
                    const now = new Date();
                    document.getElementById('pf-mes').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    document.getElementById('pf-status').value = 'Previsto';
                    document.getElementById('pf-desc').value = '';
                }
                setTimeout(() => document.getElementById('pf-nome').focus(), 100); 
                lucide.createIcons();
            },

            closeProjDrawer() {
                document.getElementById('proj-drawer').classList.remove('open'); 
                document.getElementById('proj-overlay').classList.remove('open');
            },

            saveProj() {
                const btn = document.getElementById('btn-proj-save');
                if(btn.classList.contains('loading')) return;
                
                const nome = document.getElementById('pf-nome').value.trim();
                const valor = A.cleanMoney(document.getElementById('pf-valor').value);
                if (!nome || valor <= 0) { A.toast("Preencha nome e valor v√°lido.", "err"); document.getElementById('pf-nome').focus(); return; }

                const mes = document.getElementById('pf-mes').value; 
                if(!mes) { A.toast("M√™s/Compet√™ncia √© obrigat√≥rio.", "err"); return; }

                btn.classList.add('loading');
                
                try {
                    const tipo = A.state.pTipo; 
                    const id = document.getElementById('pf-id').value || A.genId('proj');

                    const base = {
                        id, nome, valor, mes,
                        categoria: document.getElementById('pf-cat').value,
                        status: document.getElementById('pf-status').value,
                        descricao: document.getElementById('pf-desc').value.trim(),
                        created_at: new Date().toISOString()
                    };

                    const arrKey = tipo + 's'; 
                    A.state.data.projecoes.entradas = A.state.data.projecoes.entradas.filter(x => x.id !== id);
                    A.state.data.projecoes.saidas = A.state.data.projecoes.saidas.filter(x => x.id !== id);
                    
                    A.state.data.projecoes[arrKey].push(base);

                    A.saveProjecoes();
                    A.closeProjDrawer();
                    A.renderProjecoes();
                    A.toast("Proje√ß√£o salva com sucesso! üîÆ");
                } finally {
                    btn.classList.remove('loading');
                }
            },

            delProj(tipo, id) {
                if (confirm("Excluir permanentemente esta proje√ß√£o?")) {
                    A.state.data.projecoes.entradas = A.state.data.projecoes.entradas.filter(x => x.id !== id);
                    A.state.data.projecoes.saidas = A.state.data.projecoes.saidas.filter(x => x.id !== id);
                    A.saveProjecoes();
                    A.renderProjecoes();
                    A.toast("Proje√ß√£o removida. üóëÔ∏è");
                }
            },

            renderProjecoes() {
                const horizon = parseInt(document.getElementById('p-horizonte').value);
                const monthFilter = document.getElementById('p-mes-filter');
                const prevSelected = monthFilter.value;
                
                const now = new Date();
                const curY = now.getFullYear();
                const curM = now.getMonth() + 1; 
                const toAbs = (y, m) => y * 12 + m;
                const absNow = toAbs(curY, curM);
                const absEnd = absNow + horizon - 1;

                monthFilter.innerHTML = '<option value="all">Todos os meses do horizonte</option>';
                for(let i=0; i<horizon; i++) {
                   let targetAbs = absNow + i;
                   let ty = Math.floor((targetAbs - 1) / 12);
                   let tm = ((targetAbs - 1) % 12) + 1;
                   let str = `${ty}-${String(tm).padStart(2,'0')}`;
                   let label = `${MONTHS[tm-1]} ${ty}`;
                   monthFilter.innerHTML += `<option value="${str}">${label}</option>`;
                }
                if([...monthFilter.options].some(o => o.value === prevSelected)) monthFilter.value = prevSelected;

                const allProj = [
                   ...(A.state.data.projecoes.entradas || []).map(x => ({...x, _tipo: 'entrada'})),
                   ...(A.state.data.projecoes.saidas || []).map(x => ({...x, _tipo: 'saida'}))
                ];

                const filtered = allProj.filter(p => {
                   if(!p.mes) return false;
                   const [py, pm] = p.mes.split('-');
                   const pAbs = toAbs(parseInt(py), parseInt(pm));
                   if (pAbs < absNow || pAbs > absEnd) return false; 
                   if (monthFilter.value !== 'all' && p.mes !== monthFilter.value) return false;
                   return true;
                });

                const totalE = filtered.filter(x => x._tipo === 'entrada').reduce((acc, curr) => acc + Number(curr.valor), 0);
                const totalS = filtered.filter(x => x._tipo === 'saida').reduce((acc, curr) => acc + Number(curr.valor), 0);
                const saldo = totalE - totalS;

                A.animateValue('p-v-entradas', totalE, false, 'var(--success)');
                A.animateValue('p-v-saidas', totalS, false, 'var(--danger)');
                A.animateValue('p-v-saldo', saldo);

                const cardSaldo = document.getElementById('p-card-saldo');
                const valSaldo = document.getElementById('p-v-saldo');
                if (cardSaldo && valSaldo) {
                    if (saldo >= 0) { cardSaldo.className = 'card stat-card c-success'; valSaldo.style.color = 'var(--success)'; }
                    else { cardSaldo.className = 'card stat-card c-danger'; valSaldo.style.color = 'var(--danger)'; }
                }

                filtered.sort((a,b) => a.mes.localeCompare(b.mes));
                const tbody = document.getElementById('p-table-body');
                const empty = document.getElementById('p-table-empty');

                if(filtered.length === 0) {
                   tbody.innerHTML = '';
                   empty.style.display = 'block';
                } else {
                   empty.style.display = 'none';
                   tbody.innerHTML = filtered.map((i, idx) => {
                      const isE = i._tipo === 'entrada';
                      const isConf = i.status === 'Confirmado';
                      return `<tr style="animation:fadeInUp 0.5s ease ${idx*30}ms both;">
                         <td style="color:var(--text-muted);font-weight:600;white-space:nowrap">${i.mes.split('-').reverse().join('/')}</td>
                         <td><div class="item-name">${esc(i.nome)}</div>${i.descricao ? `<div class="item-desc">${esc(i.descricao)}</div>`:''}</td>
                         <td><span class="cat-badge ${isE ? 'income' : ''}">${esc(i.categoria||'‚Äî')}</span></td>
                         <td><span class="status-badge ${isConf ? 'pago' : 'pendente'}">${isConf ? '‚úÖ Confirmado' : '‚è≥ Previsto'}</span></td>
                         <td class="amount-cell font-title" style="color:${isE ? 'var(--success)' : 'var(--text)'}">${isE?'+ ':''}${A.fmtR(i.valor)}</td>
                         <td style="text-align:center;white-space:nowrap">
                            <button class="action-btn" onclick="A.openProjDrawer('${i._tipo}', '${i.id}')" title="Editar"><i data-lucide="edit-2" width="16" height="16"></i></button>
                            <button class="action-btn del" onclick="A.delProj('${i._tipo}', '${i.id}')" title="Excluir"><i data-lucide="trash-2" width="16" height="16"></i></button>
                         </td>
                      </tr>`;
                   }).join('');
                }
                lucide.createIcons();
            },

            // ‚îÄ‚îÄ EXPORT DE DADOS REAIS ‚îÄ‚îÄ
            openExportModal() { document.getElementById('export-modal').classList.add('open'); document.getElementById('export-overlay').classList.add('open'); },
            closeExportModal() { document.getElementById('export-modal').classList.remove('open'); document.getElementById('export-overlay').classList.remove('open'); },
            
            runExport() {
                const format = document.getElementById('exp-format').value;
                const monthsBack = parseInt(document.getElementById('exp-period').value);
                let allData = [];
                (A.state.data.entradas||[]).forEach(d => allData.push({...d, fluxo: 'Entrada'}));
                (A.state.data.fixos||[]).forEach(d => allData.push({...d, fluxo: 'Sa√≠da (Fixo)'}));
                (A.state.data.unicos||[]).forEach(d => allData.push({...d, fluxo: 'Sa√≠da (Vari√°vel)'}));
                
                const now = new Date(), curM = now.getMonth(), curY = now.getFullYear();
                let filtered = [];
                if (monthsBack === 12) { filtered = A.filterByYear(allData, curY); } 
                else {
                    filtered = allData.filter(d => {
                        const p = A.parseDate(d.data); if(!p) return false;
                        const itemDate = new Date(p.y, p.m, 1), limitDate = new Date(curY, curM - monthsBack + 1, 1), endDate = new Date(curY, curM + 1, 0); 
                        return itemDate >= limitDate && itemDate <= endDate;
                    });
                }
                filtered.sort((a,b) => (a.data||'').localeCompare(b.data||''));
                const filename = `Relatorio_Financeiro_BGTech_${monthsBack}M`;
                
                if (format === 'csv') {
                    const rows = [["Data", "Fluxo", "Descri√ß√£o", "Categoria", "Status", "Valor"]];
                    filtered.forEach(d => { rows.push([A.fmtD(d.data), d.fluxo, d.nome, d.categoria, d.status, d.valor]); });
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n")));
                    link.setAttribute("download", filename + ".csv");
                    document.body.appendChild(link); link.click();
                } else {
                    const { jsPDF } = window.jspdf; const doc = new jsPDF();
                    doc.setFontSize(16); doc.text("Relat√≥rio Financeiro - BG Tech", 14, 20);
                    doc.setFontSize(10); doc.text(`Per√≠odo: √öltimos ${monthsBack} meses`, 14, 28);
                    doc.autoTable({
                        startY: 35, head: [['Data', 'Fluxo', 'Descri√ß√£o', 'Categoria', 'Status', 'Valor (R$)']],
                        body: filtered.map(d => [ A.fmtD(d.data), d.fluxo, d.nome, d.categoria, d.status, A.fmtR(d.valor) ]),
                        theme: 'grid', headStyles: { fillColor: [14, 165, 233] }, styles: { fontSize: 8 }
                    });
                    doc.save(filename + ".pdf");
                }
                A.closeExportModal(); A.toast(`Relat√≥rio ${format.toUpperCase()} baixado! üì•`);
            },

            toast(msg, type = 'ok') {
                const w = document.getElementById('toast-wrap'), t = document.createElement('div');
                t.className = `toast${type === 'err' ? ' err' : ''}`;
                const icon = type === 'err' ? 'alert-circle' : 'check-circle', col = type === 'err' ? '#ef4444' : '#10b981';
                t.innerHTML = `<i data-lucide="${icon}" width="20" height="20" style="color:${col};flex-shrink:0"></i><span>${msg}</span>`;
                w.appendChild(t); lucide.createIcons();
                requestAnimationFrame(() => t.classList.add('show'));
                setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 500); }, 4500);
            }
        };

        function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
        window.onload = A.init;
        document.addEventListener('keydown', e => { if (e.key === 'Escape') { A.closeDrawer(); A.closeProjDrawer(); A.closeExportModal(); } });
    </script>
</body>
</html>
