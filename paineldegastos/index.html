<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestão Financeira | BG Tech</title>
  
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.1.9/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #05070D; color: #E6F2FF; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
    h1, h2, h3, h4, .font-display { font-family: 'Plus Jakarta Sans', sans-serif; }
    #root { min-height: 100vh; display: flex; flex-direction: column; }
    
    .hex-bg { position: absolute; inset: 0; pointer-events: none; z-index: 0; background-image: url("data:image/svg+xml,%3Csvg width='40' height='69.28' viewBox='0 0 40 69.28' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M40 17.32l-20 11.54L0 17.32V-5.77l20-11.54 20 11.54V17.32zM20 46.18l20-11.54V11.54L20 23.09 0 11.54v23.09L20 46.18zM0 63.5l20-11.54 20 11.54V86.6l-20 11.54-20-11.54V63.5z' fill='%2338D8FF' fill-opacity='0.02' fill-rule='evenodd'/%3E%3C/svg%3E"); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #05070D; }
    ::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #00A8FF; }
    
    .glass-panel { background: rgba(10, 31, 68, 0.65); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(0, 168, 255, 0.15); border-radius: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
    .btn-glow { transition: all 0.2s ease; position: relative; overflow: hidden; }
    .btn-glow:hover { box-shadow: 0 0 20px rgba(0, 168, 255, 0.5); transform: translateY(-2px); }
    .table-row { transition: all 0.2s ease; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .table-row:hover { background: rgba(0, 168, 255, 0.08); border-left: 3px solid #00A8FF; padding-left: 21px; }

    @keyframes pulse-glow {
      0% { text-shadow: 0 0 10px rgba(56, 216, 255, 0.2); transform: scale(1); }
      50% { text-shadow: 0 0 30px rgba(56, 216, 255, 0.8); transform: scale(1.02); }
      100% { text-shadow: 0 0 10px rgba(56, 216, 255, 0.2); transform: scale(1); }
    }
  </style>
</head>
<body>
  <div id="root">
    <div style="display:flex; height:100vh; flex-direction:column; align-items:center; justify-content:center; background:#05070D;">
      <div style="color:#38D8FF; font-family:'Plus Jakarta Sans', sans-serif; font-weight:800; letter-spacing:0.15em; animation:pulse-glow 1.5s infinite;">INICIANDO NÚCLEO...</div>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend } = window.Recharts;

    const ADMIN = { user: "bgtech", pass: "admin2024" };
    
    // Novas Categorias (Incluindo Receita)
    const CATS_RECEITA = ["Projeto de Automação", "Mensalidade Guardião", "Consultoria Estratégica", "Outros"];
    const CATS_FIXO  = ["Infraestrutura", "Software/SaaS", "Marketing", "Pessoal", "Escritório", "Financeiro", "Outros"];
    const CATS_UNICO = ["Equipamento", "Serviço Pontual", "Licença", "Viagem", "Marketing", "Investimento", "Outros"];

    const TOKENS = {
      electric: "#00A8FF", neon: "#38D8FF", textHero: "#E6F2FF", textMuted: "rgba(230, 242, 255, 0.5)",
      red: "#ef4444", green: "#10b981", chartColors: ["#00A8FF", "#38D8FF", "#8B5CF6", "#EC4899", "#F59E0B", "#10B981", "#E6F2FF"]
    };

    const MONTHS = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const fmt = v => new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(v || 0);
    const fmtDate = d => new Date(d + "T12:00:00").toLocaleDateString("pt-BR");
    const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2);

    // ============================================================================
    // SEU SUPABASE
    // ============================================================================
    const DB_CONFIG = {
      URL: "https://urpuiznydrlwmaqhdids.supabase.co",
      KEY: "sb_publishable_9G6JUKnfZ1mekk7qUKdTQA_TXbARtR0"
    };

    async function loadCloudData() {
      try {
        const res = await fetch(`${DB_CONFIG.URL}/rest/v1/painel_gastos?id=eq.1`, {
          headers: { 'apikey': DB_CONFIG.KEY, 'Authorization': `Bearer ${DB_CONFIG.KEY}` }
        });
        const data = await res.json();
        if (data && data.length > 0) return { fixos: data[0].fixos || [], unicos: data[0].unicos || [], receitas: data[0].receitas || [] };
      } catch (err) {}
      return { fixos: [], unicos: [], receitas: [] };
    }

    async function saveCloudData(data) {
      try {
        await fetch(`${DB_CONFIG.URL}/rest/v1/painel_gastos?id=eq.1`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'apikey': DB_CONFIG.KEY, 'Authorization': `Bearer ${DB_CONFIG.KEY}`, 'Prefer': 'return=minimal' },
          body: JSON.stringify({ fixos: data.fixos, unicos: data.unicos, receitas: data.receitas, updated_at: new Date().toISOString() })
        });
      } catch (err) {}
    }

    // ============================================================================
    // COMPONENTES DE UI
    // ============================================================================
    const InputStyle = { width: "100%", padding: "14px 16px", background: "rgba(0,0,0,0.3)", border: "1px solid rgba(0, 168, 255, 0.15)", borderRadius: 10, color: TOKENS.textHero, fontSize: 15, outline: "none", fontFamily: "inherit" };
    const PrimaryBtnStyle = { padding: "14px 28px", background: `linear-gradient(135deg, ${TOKENS.electric}, ${TOKENS.neon})`, border: "none", borderRadius: 10, color: "#05070D", fontWeight: 800, fontSize: 15, cursor: "pointer", fontFamily: "inherit" };
    function Lbl({ children }) { return <label style={{ display: "block", fontSize: 11, fontWeight: 800, color: TOKENS.neon, textTransform: "uppercase", letterSpacing: "0.1em", marginBottom: 8 }}>{children}</label>; }

    function Modal({ title, onClose, children }) {
      return (
        <div onClick={onClose} style={{ position: "fixed", inset: 0, background: "rgba(2, 6, 15, 0.85)", backdropFilter: "blur(12px)", zIndex: 9999, display: "flex", alignItems: "center", justifyContent: "center", padding: 20 }}>
          <div className="glass-panel" onClick={e => e.stopPropagation()} style={{ padding: 40, width: "100%", maxWidth: 540, maxHeight: "90vh", overflowY: "auto" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 32, borderBottom: "1px solid rgba(0, 168, 255, 0.15)", paddingBottom: 16 }}>
              <h3 className="font-display" style={{ color: TOKENS.textHero, margin: 0, fontSize: 22, fontWeight: 800 }}>{title}</h3>
              <button onClick={onClose} style={{ background: "transparent", border: "none", color: TOKENS.textMuted, cursor: "pointer", fontSize: 18 }}>✕</button>
            </div>
            {children}
          </div>
        </div>
      );
    }

    // FORMULÁRIO COM TODAS AS MELHORIAS DA AUDITORIA
    function Form({ type, onSave, onClose, initial, cats }) {
      const getToday = () => { const d = new Date(); return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0,10); };
      const [f, setF] = useState(initial || { nome: "", fornecedor: "", valor: "", categoria: cats[0], descricao: "", data: getToday(), status: "Pago" });
      const up = k => v => setF(p => ({ ...p, [k]: v }));
      
      const go = () => {
        if (!f.nome || !f.valor) return alert("Preencha o Título e o Valor.");
        const val = parseFloat(String(f.valor).replace(",", "."));
        if(isNaN(val)) return alert("Valor numérico inválido.");
        onSave({ ...f, valor: val, id: f.id || uid(), createdAt: f.createdAt || new Date().toISOString() });
        onClose();
      };

      // Dinâmica de Placeholder (Auditoria item 10)
      const getNomePlaceholder = () => {
        if (f.categoria === "Pessoal") return "Ex: Pró-labore Gabriel";
        if (f.categoria === "Software/SaaS") return "Ex: Assinatura Mensal Make";
        if (type === "receita") return "Ex: Projeto de Automação V2";
        return "Ex: Servidor AWS";
      };

      return (
        <React.Fragment>
          <div style={{ marginBottom: 20 }}>
            <Lbl>{type === "receita" ? "Título da Receita *" : "Título do Gasto *"}</Lbl>
            <input style={InputStyle} value={f.nome} onChange={e => up("nome")(e.target.value)} placeholder={getNomePlaceholder()} autoFocus />
          </div>
          <div style={{ marginBottom: 20 }}>
            <Lbl>{type === "receita" ? "Cliente Beneficiário" : "Fornecedor / Emitente"}</Lbl>
            <input style={InputStyle} value={f.fornecedor} onChange={e => up("fornecedor")(e.target.value)} placeholder={type === "receita" ? "Ex: LogMax S/A" : "Ex: Amazon Web Services"} />
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 20 }}>
            <div><Lbl>Valor (R$) *</Lbl><input style={InputStyle} type="number" step="0.01" value={f.valor} onChange={e => up("valor")(e.target.value)} placeholder="0.00" /></div>
            <div><Lbl>{type === "fixo" ? "Data Base Mês" : "Data da Movimentação"}</Lbl><input style={InputStyle} type="date" value={f.data} onChange={e => up("data")(e.target.value)} /></div>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 16, marginBottom: 24 }}>
            <div>
              <Lbl>Categoria Estratégica</Lbl>
              <select style={InputStyle} value={f.categoria} onChange={e => up("categoria")(e.target.value)}>{cats.map(c => <option key={c} value={c} style={{background:"#0A1F44"}}>{c}</option>)}</select>
            </div>
            <div>
              <Lbl>Status do Pagamento</Lbl>
              <select style={InputStyle} value={f.status} onChange={e => up("status")(e.target.value)}>
                <option value="Pago" style={{background:"#0A1F44"}}>✔️ Efetuado (Pago)</option>
                <option value="Pendente" style={{background:"#0A1F44"}}>⏳ Pendente (A Pagar)</option>
              </select>
            </div>
          </div>
          <div style={{ marginBottom: 32 }}><Lbl>Contexto / Justificativa</Lbl><input style={InputStyle} value={f.descricao} onChange={e => up("descricao")(e.target.value)} placeholder="Registro de contrato ou notas..." /></div>
          <div style={{ display: "flex", gap: 16 }}>
            <button onClick={onClose} style={{ flex: 1, padding: "14px", background: "transparent", border: `1px solid rgba(255,255,255,0.15)`, borderRadius: 10, color: TOKENS.textHero, fontWeight: 600, cursor: "pointer" }}>Cancelar</button>
            <button onClick={go} className="btn-glow" style={{ ...PrimaryBtnStyle, flex: 2 }}>Registrar Operação</button>
          </div>
        </React.Fragment>
      );
    }

    function StatCard({ label, value, sub, color = TOKENS.electric }) {
      return (
        <div className="glass-panel" style={{ padding: "28px 24px", flex: 1, minWidth: 200, borderLeft: `4px solid ${color}` }}>
          <div style={{ fontSize: 12, color: TOKENS.textMuted, fontWeight: 800, textTransform: "uppercase", letterSpacing: "0.08em", marginBottom: 16 }}>{label}</div>
          <div className="font-display" style={{ fontSize: 32, fontWeight: 800, color: TOKENS.textHero, letterSpacing: "-0.02em", marginBottom: 4 }}>{value}</div>
          <div style={{ fontSize: 13, color: "rgba(230,242,255,0.4)", fontWeight: 600 }}>{sub}</div>
        </div>
      );
    }

    // LINHA DE DADOS MELHORADA COM STATUS E FORNECEDOR
    function DataRow({ item, type, onEdit, onDelete }) {
      const [confirm, setConfirm] = useState(false);
      const isPending = item.status === "Pendente";
      const isReceita = type === "receita";

      return (
        <div className="table-row" style={{ display: "flex", alignItems: "center", gap: 16, padding: "18px 24px", borderLeft: "3px solid transparent", opacity: isPending ? 0.6 : 1 }}>
          <div style={{ flex: 1 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ color: TOKENS.textHero, fontWeight: 700, fontSize: 16 }}>{item.nome}</div>
              {isPending && <span style={{ background: "rgba(245, 158, 11, 0.15)", color: "#f59e0b", padding: "2px 8px", borderRadius: 4, fontSize: 10, fontWeight: 800, textTransform: "uppercase" }}>A Pagar</span>}
            </div>
            <div style={{ color: TOKENS.textMuted, fontSize: 12, marginTop: 6, display: "flex", gap: 8, alignItems: "center" }}>
              <span style={{ background: isReceita ? "rgba(16, 185, 129, 0.15)" : "rgba(0,168,255,0.1)", border: `1px solid ${isReceita ? "rgba(16, 185, 129, 0.3)" : "rgba(0,168,255,0.2)"}`, color: isReceita ? TOKENS.green : TOKENS.neon, padding: "4px 8px", borderRadius: 4, fontSize: 10, fontWeight: 800, textTransform: "uppercase" }}>{item.categoria}</span>
              <span>•</span> <span>{fmtDate(item.data)}</span>
              {item.fornecedor && <><span>•</span> <span style={{fontWeight: 600, color:"#94a3b8"}}>{isReceita ? 'Cliente:' : 'Fornec:'} {item.fornecedor}</span></>}
            </div>
            {item.descricao && <div style={{ color: "rgba(230,242,255,0.3)", fontSize: 13, marginTop: 8, fontStyle: "italic" }}>"{item.descricao}"</div>}
          </div>
          <div className="font-display" style={{ fontWeight: 800, color: isReceita ? TOKENS.green : TOKENS.textHero, fontSize: 18, minWidth: 130, textAlign: "right" }}>{isReceita ? '+' : '-'} {fmt(item.valor)}</div>
          <div style={{ display: "flex", gap: 8, flexShrink: 0, marginLeft: 24 }}>
            <button onClick={() => onEdit(item)} style={{ background: "rgba(255,255,255,0.05)", border: `1px solid rgba(255,255,255,0.2)`, borderRadius: 8, color: "white", padding: "8px 16px", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>Editar</button>
            {confirm
              ? <button onClick={() => { onDelete(item.id); setConfirm(false); }} style={{ background: "rgba(239,68,68,0.1)", border: "1px solid #ef4444", borderRadius: 8, color: "#ef4444", padding: "8px 16px", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>Apagar!</button>
              : <button onClick={() => setConfirm(true)} style={{ background: "transparent", border: `1px solid rgba(255,255,255,0.1)`, borderRadius: 8, color: TOKENS.textMuted, padding: "8px 16px", cursor: "pointer", fontSize: 12, fontWeight: 700 }}>Del</button>}
          </div>
        </div>
      );
    }

    function Login({ onLogin }) {
      const [u, setU] = useState(""); const [p, setP] = useState(""); const [err, setErr] = useState(""); const [load, setLoad] = useState(false);
      const go = () => {
        setLoad(true);
        setTimeout(() => {
          if (u.trim().toLowerCase() === ADMIN.user && p === ADMIN.pass) onLogin();
          else { setErr("Acesso Negado."); setLoad(false); }
        }, 800);
      };
      return (
        <div style={{ minHeight: "100vh", position: "relative", display: "flex", alignItems: "center", justifyContent: "center" }}>
          <div className="hex-bg" />
          <div className="glass-panel" style={{ padding: "48px", width: "100%", maxWidth: 440, zIndex: 10 }}>
            <div style={{ textAlign: "center", margin-bottom: 40 }}>
              <h1 className="font-display" style={{ color: "white", fontSize: 26, fontWeight: 800, margin: "0 0 8px" }}>BG <span style={{ color: TOKENS.electric }}>TECH</span></h1>
              <p style={{ color: TOKENS.neon, fontSize: 11, fontWeight: 800, margin: 0, textTransform: "uppercase", letterSpacing: "0.25em" }}>Painel Financeiro B2B</p>
            </div>
            <div style={{ marginBottom: 24 }}><Lbl>ID de Acesso</Lbl><input style={{...InputStyle, background: "rgba(0,0,0,0.5)"}} value={u} onChange={e => { setU(e.target.value); setErr(""); }} onKeyDown={e => e.key === "Enter" && go()} placeholder="Usuário root" autoFocus /></div>
            <div style={{ marginBottom: 32 }}><Lbl>Chave de Segurança</Lbl><input style={{...InputStyle, background: "rgba(0,0,0,0.5)"}} type="password" value={p} onChange={e => { setP(e.target.value); setErr(""); }} onKeyDown={e => e.key === "Enter" && go()} placeholder="••••••••" /></div>
            {err && <div style={{ background: "rgba(239,68,68,0.1)", border: "1px solid rgba(239,68,68,0.3)", borderRadius: 8, padding: 12, color: TOKENS.red, fontSize: 13, textAlign: "center", marginBottom: 24, fontWeight: 700 }}>⚠️ {err}</div>}
            <button onClick={go} disabled={load} className="btn-glow" style={{ ...PrimaryBtnStyle, width: "100%", padding: "18px", fontSize: 16 }}>{load ? "Autenticando..." : "Acessar Sistema"}</button>
          </div>
        </div>
      );
    }

    function Dashboard({ onLogout }) {
      const [tab, setTab] = useState("overview"); 
      const [fixos, setFixos] = useState([]); 
      const [unicos, setUnicos] = useState([]);
      const [receitas, setReceitas] = useState([]); // NOVO ESTADO DE RECEITAS
      
      const [modal, setModal] = useState(null); 
      const [mes, setMes] = useState(new Date().getMonth()); 
      const [ano, setAno] = useState(new Date().getFullYear());
      const [search, setSearch] = useState(""); // SISTEMA DE BUSCA
      
      const [ready, setReady] = useState(false); 
      const [syncing, setSyncing] = useState(false); 
      const pollRef = useRef(null);

      const refresh = useCallback(async (silent = false) => {
        if(!silent) setSyncing(true);
        const data = await loadCloudData();
        setFixos(data.fixos || []); setUnicos(data.unicos || []); setReceitas(data.receitas || []);
        setReady(true); setSyncing(false);
      }, []);

      useEffect(() => { refresh(); pollRef.current = setInterval(() => refresh(true), 15000); return () => clearInterval(pollRef.current); }, [refresh]);

      const persist = async (newFixos, newUnicos, newReceitas) => { 
        setFixos(newFixos); setUnicos(newUnicos); setReceitas(newReceitas); setSyncing(true); 
        await saveCloudData({ fixos: newFixos, unicos: newUnicos, receitas: newReceitas }); 
        setSyncing(false); 
      };
      
      // CRUDS
      const saveFixo = async item => await persist(fixos.find(i => i.id === item.id) ? fixos.map(i => i.id === item.id ? item : i) : [...fixos, item], unicos, receitas);
      const saveUnico = async item => await persist(fixos, unicos.find(i => i.id === item.id) ? unicos.map(i => i.id === item.id ? item : i) : [...unicos, item], receitas);
      const saveReceita = async item => await persist(fixos, unicos, receitas.find(i => i.id === item.id) ? receitas.map(i => i.id === item.id ? item : i) : [...receitas, item]);
      
      const delFixo = async id => await persist(fixos.filter(i => i.id !== id), unicos, receitas);
      const delUnico = async id => await persist(fixos, unicos.filter(i => i.id !== id), receitas);
      const delReceita = async id => await persist(fixos, unicos, receitas.filter(i => i.id !== id));

      // CÁLCULOS DO MÊS SELECIONADO
      const fMês = (arr) => arr.filter(u => { const d = new Date(u.data + "T12:00:00"); return d.getMonth() === mes && d.getFullYear() === ano; });
      
      const uf = fMês(unicos);
      const ur = fMês(receitas);
      
      // Custo Fixo a gente considera o total ativo, mas pra simplificar histórico filtramos também
      const ff = fMês(fixos); 

      const tF = ff.reduce((a, b) => a + (b.valor || 0), 0); 
      const tU = uf.reduce((a, b) => a + (b.valor || 0), 0);
      const tR = ur.reduce((a, b) => a + (b.valor || 0), 0);
      const margem = tR - (tF + tU); // CÁLCULO DE MARGEM

      // Filtros de Busca
      const searchStr = search.toLowerCase();
      const filteredF = ff.filter(i => i.nome.toLowerCase().includes(searchStr) || (i.fornecedor||"").toLowerCase().includes(searchStr));
      const filteredU = uf.filter(i => i.nome.toLowerCase().includes(searchStr) || (i.fornecedor||"").toLowerCase().includes(searchStr));
      const filteredR = ur.filter(i => i.nome.toLowerCase().includes(searchStr) || (i.fornecedor||"").toLowerCase().includes(searchStr));

      // Gráficos
      const catF = CATS_FIXO.map(c => ({ name: c, value: ff.filter(f => f.categoria === c).reduce((a, b) => a + b.valor, 0) })).filter(d => d.value > 0);
      
      const bar = Array.from({ length: 6 }, (_, i) => {
        const d = new Date(); d.setMonth(d.getMonth() - (5 - i)); const m = d.getMonth(), a = d.getFullYear();
        const mR = receitas.filter(u => { const dd = new Date(u.data + "T12:00:00"); return dd.getMonth() === m && dd.getFullYear() === a; }).reduce((s, u) => s + u.valor, 0);
        const mF = fixos.filter(u => { const dd = new Date(u.data + "T12:00:00"); return dd.getMonth() === m && dd.getFullYear() === a; }).reduce((s, u) => s + u.valor, 0);
        const mU = unicos.filter(u => { const dd = new Date(u.data + "T12:00:00"); return dd.getMonth() === m && dd.getFullYear() === a; }).reduce((s, u) => s + u.valor, 0);
        return { name: MONTHS[m], Entrada: mR, Saída: mF + mU };
      });

      const TooltipStyle = { background: "#020617", border: `1px solid ${TOKENS.border}`, borderRadius: 12, color: "white", padding: "16px" };
      const SelectStyle = { background: "rgba(0,0,0,0.3)", border: `1px solid ${TOKENS.border}`, borderRadius: 8, color: "white", padding: "12px 20px", fontSize: 14, fontFamily: "inherit", outline: "none", cursor: "pointer", fontWeight: 600 };

      if (!ready) return <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background:"#05070D" }}><div style={{ color: TOKENS.neon, fontFamily: "'Plus Jakarta Sans', sans-serif", fontWeight: 800, letterSpacing: "0.2em", fontSize: 12 }}>CARREGANDO DADOS...</div></div>;

      return (
        <div style={{ minHeight: "100vh", display: "flex" }}>
          <div className="hex-bg" style={{position:"fixed"}}/>
          
          <div style={{ width: 280, background: "rgba(2, 6, 15, 0.95)", borderRight: `1px solid rgba(255,255,255,0.05)`, display: "flex", flexDirection: "column", position: "fixed", top: 0, bottom: 0, left: 0, zIndex: 100, backdropFilter:"blur(20px)" }}>
            <div style={{ padding: "40px 32px 32px" }}>
              <h1 className="font-display" style={{ fontSize: 24, fontWeight: 900, color: "white", margin: "0 0 4px" }}>BG <span style={{ color: TOKENS.electric }}>TECH</span></h1>
              <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                <span style={{ color: TOKENS.neon, fontSize: 10, fontWeight: 800, letterSpacing: "0.2em", textTransform: "uppercase" }}>Engenharia</span>
                <span style={{ width: 8, height: 8, background: syncing ? TOKENS.neon : TOKENS.green, borderRadius: "50%" }}/>
              </div>
            </div>
            
            <nav style={{ flex: 1, padding: "0 20px" }}>
              {[{ id: "overview", label: "Visão CFO" }, { id: "receitas", label: "Entradas / MRR", color: TOKENS.green }, { id: "fixos", label: "Carga Fixa (Mês)" }, { id: "unicos", label: "Custos Variáveis" }].map(n => (
                <button key={n.id} onClick={() => {setTab(n.id); setSearch("");}} style={{ width: "100%", padding: "16px", borderRadius: 12, border: "none", background: tab === n.id ? "rgba(255,255,255,0.05)" : "transparent", color: tab === n.id ? "white" : TOKENS.textMuted, fontWeight: tab === n.id ? 800 : 600, fontSize: 14, cursor: "pointer", fontFamily: "inherit", marginBottom: 8, textAlign: "left", transition: "all 0.2s", borderLeft: tab === n.id ? `3px solid ${n.color || TOKENS.electric}` : "3px solid transparent" }}>{n.label}</button>
              ))}
            </nav>
            
            <div style={{ padding: "24px", borderTop: `1px solid rgba(255,255,255,0.05)` }}>
              <button onClick={onLogout} style={{ width: "100%", padding: "12px", background: "transparent", border: "none", color: TOKENS.textMuted, fontSize: 13, fontWeight: 700, cursor: "pointer" }}>Sair do Sistema</button>
            </div>
          </div>

          <div style={{ marginLeft: 280, flex: 1, padding: "56px 64px", position: "relative", zIndex: 1, maxWidth: 1400 }}>
            
            {/* CABEÇALHO GLOBAL DE FILTRO (Fica em todas as abas agora) */}
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-end", marginBottom: 48 }}>
              <div>
                <h1 className="font-display" style={{ color: "white", fontSize: 36, fontWeight: 800, margin: "0 0 12px" }}>
                  {tab === 'overview' ? 'Visão Executiva' : tab === 'receitas' ? 'Gestão de Receitas' : tab === 'fixos' ? 'Carga Fixa Operacional' : 'Despesas Variáveis'}
                </h1>
                {tab !== 'overview' && (
                  <div style={{ position: "relative", width: 300, marginTop: 24 }}>
                    <input type="text" placeholder="Buscar lançamento ou fornecedor..." value={search} onChange={e => setSearch(e.target.value)} style={{...InputStyle, padding: "10px 16px", background:"rgba(255,255,255,0.05)", fontSize: 14}} />
                  </div>
                )}
              </div>
              <div style={{ display: "flex", gap: 16 }}>
                <select value={mes} onChange={e => setMes(Number(e.target.value))} style={SelectStyle}>{MONTHS.map((m, i) => <option key={i} value={i}>{m}</option>)}</select>
                <select value={ano} onChange={e => setAno(Number(e.target.value))} style={SelectStyle}>{[2024, 2025, 2026, 2027].map(a => <option key={a} value={a}>{a}</option>)}</select>
              </div>
            </div>

            {tab === "overview" && (
              <div style={{ animation: "fadeIn 0.4s ease-out" }}>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(220px, 1fr))", gap: 24, marginBottom: 48 }}>
                  <StatCard label="Receita Bruta" value={fmt(tR)} sub={`${ur.length} contratos fechados`} color={TOKENS.green} />
                  <StatCard label="Saída Total (Fixo+Var)" value={fmt(tF + tU)} sub={`${ff.length + uf.length} despesas contabilizadas`} color={TOKENS.red} />
                  <StatCard label="Margem / Resultado" value={fmt(margem)} sub="Lucro Operacional" color={margem >= 0 ? TOKENS.green : TOKENS.red} />
                </div>

                <div className="glass-panel" style={{ padding: 40 }}>
                  <h3 className="font-display" style={{ color: "white", margin: "0 0 40px", fontSize: 18, fontWeight: 800 }}>DRE — Receita vs Saída (Últimos 6 Meses)</h3>
                  <ResponsiveContainer width="100%" height={320}>
                    <BarChart data={bar} barGap={8} margin={{ top: 10, right: 10, left: 10, bottom: 0 }}>
                      <XAxis dataKey="name" stroke={TOKENS.border} tick={{ fill: "rgba(255,255,255,0.4)", fontSize: 13, fontWeight: 600 }} tickMargin={16} />
                      <YAxis stroke={TOKENS.border} tick={{ fill: "rgba(255,255,255,0.4)", fontSize: 13, fontWeight: 600 }} tickFormatter={v => `R$ ${(v / 1000).toFixed(0)}k`} />
                      <Tooltip formatter={v => fmt(v)} contentStyle={TooltipStyle} cursor={{fill: "rgba(255,255,255,0.03)"}}/>
                      <Legend wrapperStyle={{paddingTop: 24, fontSize: 14, fontWeight: 600, color: "white"}}/>
                      <Bar dataKey="Entrada" fill={TOKENS.green} radius={[6, 6, 0, 0]} />
                      <Bar dataKey="Saída" fill={TOKENS.red} radius={[6, 6, 0, 0]} />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            )}

            {tab === "receitas" && (
              <div style={{ animation: "fadeIn 0.4s ease-out" }}>
                <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 24 }}>
                  <button onClick={() => setModal({ type: "receita", item: null })} className="btn-glow" style={{...PrimaryBtnStyle, background: `linear-gradient(135deg, #10b981, #059669)`}}>+ Lançar Contrato / Receita</button>
                </div>
                {filteredR.length === 0 ? <p style={{ color: TOKENS.textMuted }}>Nenhuma receita encontrada no período.</p> : (
                  <div className="glass-panel" style={{ overflow: "hidden" }}>
                    {filteredR.sort((a, b) => new Date(b.data) - new Date(a.data)).map(item => <DataRow key={item.id} item={item} type="receita" onEdit={item => setModal({ type: "receita", item })} onDelete={delReceita} />)}
                    <div style={{ padding: "24px 32px", background: "rgba(0,0,0,0.5)", textAlign: "right" }}><span className="font-display" style={{ color: TOKENS.green, fontSize: 28, fontWeight: 900 }}>{fmt(tR)}</span></div>
                  </div>
                )}
              </div>
            )}

            {tab === "fixos" && (
              <div style={{ animation: "fadeIn 0.4s ease-out" }}>
                <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 24 }}>
                  <button onClick={() => setModal({ type: "fixo", item: null })} className="btn-glow" style={PrimaryBtnStyle}>+ Registrar Novo Fixo</button>
                </div>
                {filteredF.length === 0 ? <p style={{ color: TOKENS.textMuted }}>Nenhum custo fixo no período.</p> : (
                  <div className="glass-panel" style={{ overflow: "hidden" }}>
                    {filteredF.sort((a, b) => new Date(b.data) - new Date(a.data)).map(item => <DataRow key={item.id} item={item} type="fixo" onEdit={item => setModal({ type: "fixo", item })} onDelete={delFixo} />)}
                    <div style={{ padding: "24px 32px", background: "rgba(0,0,0,0.5)", textAlign: "right" }}><span className="font-display" style={{ color: TOKENS.textHero, fontSize: 28, fontWeight: 900 }}>{fmt(tF)}</span></div>
                  </div>
                )}
              </div>
            )}

            {tab === "unicos" && (
              <div style={{ animation: "fadeIn 0.4s ease-out" }}>
                <div style={{ display: "flex", justifyContent: "flex-end", marginBottom: 24 }}>
                  <button onClick={() => setModal({ type: "unico", item: null })} className="btn-glow" style={PrimaryBtnStyle}>+ Lançar Variável</button>
                </div>
                {filteredU.length === 0 ? <p style={{ color: TOKENS.textMuted }}>Nenhuma saída em {MONTHS[mes]}/{ano}.</p> : (
                  <div className="glass-panel" style={{ overflow: "hidden" }}>
                    {filteredU.sort((a, b) => new Date(b.data) - new Date(a.data)).map(item => <DataRow key={item.id} item={item} type="unico" onEdit={item => setModal({ type: "unico", item })} onDelete={delUnico} />)}
                    <div style={{ padding: "24px 32px", background: "rgba(0,0,0,0.5)", textAlign: "right" }}><span className="font-display" style={{ color: TOKENS.textHero, fontSize: 28, fontWeight: 900 }}>{fmt(tU)}</span></div>
                  </div>
                )}
              </div>
            )}
          </div>

          {modal && (
            <Modal title={modal.item ? "Editar Lançamento" : modal.type === "receita" ? "Nova Receita" : modal.type === "fixo" ? "Novo Custo Fixo" : "Novo Custo Variável"} onClose={() => setModal(null)}>
              <Form 
                type={modal.type}
                onSave={modal.type === "fixo" ? saveFixo : modal.type === "receita" ? saveReceita : saveUnico} 
                onClose={() => setModal(null)} 
                initial={modal.item} 
                cats={modal.type === "receita" ? CATS_RECEITA : modal.type === "fixo" ? CATS_FIXO : CATS_UNICO} 
              />
            </Modal>
          )}
        </div>
      );
    }

    function App() {
      const [logged, setLogged] = useState(false);
      return <React.Fragment>{logged ? <Dashboard onLogout={() => setLogged(false)} /> : <Login onLogin={() => setLogged(true)} />}</React.Fragment>;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
