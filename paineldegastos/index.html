<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BG Tech | CFO Dashboard</title>
  
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;600;700;800;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <style>
    /* ==========================================================================
       DNA BG TECH & DESIGN SYSTEM
       ========================================================================== */
    :root {
      --bg-dark: #030712;
      --bg-surface: #0f172a;
      --bg-card: rgba(15, 23, 42, 0.7);
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --primary-glow: rgba(14, 165, 233, 0.3);
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.08);
      --glass-shadow: 0 24px 48px rgba(0,0,0,0.6), inset 0 1px 1px rgba(255,255,255,0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg-dark); color: var(--text-main); overflow-x: hidden; -webkit-font-smoothing: antialiased; }
    h1, h2, h3, .font-title { font-family: 'Plus Jakarta Sans', sans-serif; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* Correção do Autofill do Navegador (Fundo Branco nunca mais) */
    input:-webkit-autofill,
    input:-webkit-autofill:hover, 
    input:-webkit-autofill:focus, 
    input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px var(--bg-surface) inset !important;
        -webkit-text-fill-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    /* Fundo Tech */
    .bg-grid { position: fixed; inset: 0; z-index: -2; background-size: 50px 50px; background-image: linear-gradient(to right, rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, 0.02) 1px, transparent 1px); }
    .bg-glow-1 { position: fixed; width: 800px; height: 800px; background: radial-gradient(circle, var(--primary-glow) 0%, transparent 60%); top: -300px; right: -200px; z-index: -1; pointer-events: none; }
    .bg-glow-2 { position: fixed; width: 600px; height: 600px; background: radial-gradient(circle, rgba(239,68,68,0.1) 0%, transparent 60%); bottom: -200px; left: -100px; z-index: -1; pointer-events: none; }

    /* Layout Geral */
    .app-container { display: flex; min-height: 100vh; width: 100%; overflow: hidden; }
    .sidebar { width: 280px; background: rgba(3, 7, 18, 0.85); backdrop-filter: blur(24px); border-right: 1px solid var(--border); padding: 40px 24px; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 50; }
    .main-content { flex: 1; margin-left: 280px; padding: 48px clamp(20px, 5vw, 56px); max-width: 1600px; width: 100%; }

    /* Componentes Premium */
    .glass-card { background: var(--bg-card); backdrop-filter: blur(24px); border: 1px solid var(--border); border-radius: 24px; box-shadow: var(--glass-shadow); padding: clamp(20px, 4vw, 32px); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .glass-card:hover { border-color: rgba(14, 165, 233, 0.2); }

    .btn-action { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 14px 28px; border-radius: 14px; font-weight: 700; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 8px 24px var(--primary-glow), inset 0 1px 1px rgba(255,255,255,0.3); transition: 0.2s; white-space: nowrap; }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 12px 32px var(--primary-glow); filter: brightness(1.1); }
    .btn-action:active { transform: scale(0.98); }

    .nav-btn { display: flex; align-items: center; gap: 14px; width: 100%; padding: 16px 20px; border-radius: 16px; border: 1px solid transparent; background: transparent; color: var(--text-muted); font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 8px; }
    .nav-btn:hover { color: var(--text-main); background: rgba(255,255,255,0.03); }
    .nav-btn.active { background: linear-gradient(90deg, rgba(14,165,233,0.1), transparent); color: var(--primary); border-left: 2px solid var(--primary); }

    /* Formulários e Inputs */
    .input-wrapper { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; width: 100%; position: relative; }
    .input-label { font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; }
    .input-field { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); border-radius: 14px; padding: 16px; color: white; font-size: 16px; transition: 0.3s; box-shadow: inset 0 2px 6px rgba(0,0,0,0.5); }
    .input-field:focus { border-color: var(--primary); background: rgba(14,165,233,0.03); box-shadow: 0 0 0 4px var(--primary-glow), inset 0 2px 6px rgba(0,0,0,0.5); }
    .input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 20px; height: 20px; pointer-events: none; transition: 0.3s; }
    .input-field:focus + .input-icon { color: var(--primary); } /* Acende o ícone no foco */
    .input-with-icon { padding-left: 48px; }

    /* Header & Filters */
    .top-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 48px; gap: 20px; flex-wrap: wrap; }
    .header-actions { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .filters-box { display: flex; background: rgba(0,0,0,0.4); border: 1px solid var(--border); border-radius: 100px; padding: 6px; flex-wrap: nowrap; }
    .filter-select { background: transparent; color: var(--text-main); border: none; padding: 10px 16px; font-weight: 700; font-size: 14px; cursor: pointer; appearance: none; }
    .filter-select option { background: var(--bg-surface); }

    /* Dashboards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .chart-box { min-height: 420px; display: flex; flex-direction: column; }
    .chart-container { flex: 1; width: 100%; min-height: 300px; }

    /* Tabela Responsiva */
    .table-responsive-wrapper { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 16px; }
    .data-table { width: 100%; min-width: 800px; border-collapse: collapse; text-align: left; }
    .data-table th { padding: 20px; color: var(--text-muted); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid var(--border); white-space: nowrap; }
    .data-table td { padding: 20px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .data-table tr:hover td { background: rgba(255,255,255,0.02); }

    /* Badges & Icons */
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; }
    .status-badge.pago { background: rgba(16,185,129,0.1); color: var(--success); border: 1px solid rgba(16,185,129,0.2); }
    .status-badge.pendente { background: rgba(245,158,11,0.1); color: var(--warning); border: 1px solid rgba(245,158,11,0.2); }

    .action-icon { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; border-radius: 8px; transition: 0.2s; }
    .action-icon:hover { color: white; background: rgba(255,255,255,0.05); }
    .action-icon.del:hover { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

    /* Drawer Lateral (Responsivo) */
    .drawer-overlay { position: fixed; inset: 0; background: rgba(3,7,18,0.8); backdrop-filter: blur(8px); z-index: 999; opacity: 0; pointer-events: none; transition: 0.4s ease; }
    .drawer { position: fixed; top: 0; right: -100%; width: 100%; max-width: 540px; height: 100vh; background: var(--bg-surface); border-left: 1px solid var(--border); z-index: 1000; padding: clamp(24px, 5vw, 40px); box-shadow: -20px 0 60px rgba(0,0,0,0.8); transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1); overflow-y: auto; }
    .drawer.open { right: 0; }
    .drawer-overlay.open { opacity: 1; pointer-events: all; }
    
    .type-switcher { display: flex; background: rgba(0,0,0,0.5); border-radius: 16px; padding: 8px; margin-bottom: 32px; box-shadow: inset 0 2px 6px rgba(0,0,0,0.5); }
    .type-btn { flex: 1; padding: 14px; border: none; background: transparent; color: var(--text-muted); font-weight: 700; border-radius: 12px; cursor: pointer; transition: 0.3s; font-size: clamp(12px, 2vw, 14px); }
    .type-btn.active { background: var(--bg-card); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.1); }

    /* ==========================================================================
       MODO RESPONSIVO MOBILE
       ========================================================================== */
    @media (max-width: 1000px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: 32px 16px 120px; }
      .top-header { flex-direction: column; align-items: flex-start; margin-bottom: 32px; gap: 16px; }
      .header-actions { width: 100%; flex-direction: column; align-items: stretch; gap: 16px; }
      .filters-box { width: 100%; display: flex; justify-content: space-between; }
      .filter-select { flex: 1; text-align: center; }
      #page-title { font-size: clamp(28px, 8vw, 36px); }
      .stat-number { font-size: clamp(32px, 8vw, 40px) !important; }
      .charts-grid { grid-template-columns: 1fr; }
      .form-grid-mobile { display: flex !important; flex-direction: column !important; gap: 0 !important; }
      
      .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(3,7,18,0.95); backdrop-filter: blur(20px); border-top: 1px solid var(--border); padding: 12px 16px; z-index: 100; justify-content: space-around; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
      .m-nav-btn { background: transparent; border: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; transition: 0.3s; }
      .m-nav-btn.active { color: var(--primary); transform: translateY(-4px); filter: drop-shadow(0 4px 8px var(--primary-glow)); }
    }
    @media (min-width: 1001px) { .mobile-nav { display: none; } }

    /* Toasts e Sync */
    #toast-container { position: fixed; bottom: 32px; right: 32px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; }
    .toast { background: var(--bg-surface); border: 1px solid var(--border); border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: 16px; color: white; font-weight: 600; font-size: 14px; box-shadow: 0 12px 40px rgba(0,0,0,0.6); transform: translateX(120%); transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; gap: 12px; }
    .toast.show { transform: translateX(0); }
    .toast.error { border-left-color: var(--danger); }
    
    .sync-status { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 700; color: var(--text-muted); padding-left: 16px; }
    .sync-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
    @keyframes pulse-glow { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.05); opacity: 1; } }
  </style>
</head>
<body>

  <div id="login-screen" style="position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: var(--bg-dark);">
    <div class="bg-grid"></div>
    <div style="position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(14,165,233,0.15) 0%, transparent 60%); top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; filter: blur(40px); pointer-events: none; animation: pulse-glow 4s ease-in-out infinite;"></div>
    
    <div class="glass-card" style="width: 100%; max-width: 440px; margin: 20px; padding: 56px 40px; text-align: center; position: relative; z-index: 10;">
      
      <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom: 24px;">
        <i data-lucide="cpu" style="color:var(--primary); width:36px; height:36px;"></i>
        <h1 class="font-title" style="font-size: 36px; letter-spacing:-0.03em; margin:0;">BG <span>TECH</span></h1>
      </div>
      
      <div style="display:inline-flex; align-items:center; gap:6px; background:rgba(14,165,233,0.1); border:1px solid rgba(14,165,233,0.3); color:var(--primary); padding:6px 16px; border-radius:100px; font-size:11px; font-weight:800; letter-spacing:0.1em; margin-bottom: 48px;">
        <i data-lucide="shield-check" style="width:14px; height:14px;"></i> ACESSO RESTRITO CFO
      </div>
      
      <div style="position: relative; margin-bottom: 16px;">
        <input type="text" id="login-user" class="input-field input-with-icon" placeholder="ID de Acesso">
        <i data-lucide="user" class="input-icon"></i>
      </div>
      
      <div style="position: relative; margin-bottom: 40px;">
        <input type="password" id="login-pass" class="input-field input-with-icon" placeholder="Senha do Cofre">
        <i data-lucide="key" class="input-icon"></i>
      </div>
      
      <button class="btn-action" style="width: 100%; padding: 18px; font-size: 16px; justify-content: center; gap: 12px;" onclick="app.login()">
        Destrancar Sistema <i data-lucide="arrow-right" style="width: 18px;"></i>
      </button>
    </div>
  </div>

  <div class="app-container" id="main-app" style="display: none;">
    <div class="bg-grid"></div><div class="bg-glow-1"></div><div class="bg-glow-2"></div>

    <aside class="sidebar">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom: 48px; padding-left: 8px;">
        <i data-lucide="cpu" color="#0ea5e9" style="width:28px; height:28px;"></i>
        <h1 class="font-title" style="font-size: 24px;">BG <span>TECH</span></h1>
      </div>
      
      <nav style="flex:1;">
        <button class="nav-btn active" onclick="app.setTab('overview')"><i data-lucide="layout-dashboard"></i> Inteligência Geral</button>
        <button class="nav-btn" onclick="app.setTab('fixos')"><i data-lucide="anchor"></i> Estrutura Fixa</button>
        <button class="nav-btn" onclick="app.setTab('unicos')"><i data-lucide="zap"></i> Gastos Variáveis</button>
      </nav>

      <div class="sync-status" style="margin-bottom: 24px;">
        <div class="sync-dot" id="sync-indicator"></div> <span id="sync-text">Conectado à Nuvem</span>
      </div>
    </aside>

    <main class="main-content">
      <header class="top-header">
        <div>
          <h2 class="font-title" id="page-title" style="margin-bottom: 8px;">Resumo Financeiro</h2>
          <p style="color: var(--text-muted); font-size: 15px;">Monitoramento de despesas operacionais da base.</p>
        </div>
        <div class="header-actions">
          <div class="filters-box">
            <select id="filter-month" class="filter-select" onchange="app.render()"></select>
            <div style="width:1px; background:var(--border); margin:8px 0;"></div>
            <select id="filter-year" class="filter-select" onchange="app.render()">
              <option value="2025">2025</option><option value="2026" selected>2026</option>
            </select>
          </div>
          <button class="btn-action" style="width: 100%;" onclick="app.openDrawer()">
            <i data-lucide="plus"></i> Adicionar Gasto
          </button>
        </div>
      </header>

      <div id="view-overview">
        <div class="stats-grid">
          <div class="glass-card" style="border-top: 4px solid var(--danger);">
            <div style="display:flex; justify-content:space-between; margin-bottom: 16px;">
              <span style="font-size:13px; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Sangria Total (Mês)</span>
              <i data-lucide="trending-down" color="#ef4444"></i>
            </div>
            <h2 class="font-title stat-number" id="val-total" style="margin-bottom: 8px;">R$ 0,00</h2>
          </div>
          
          <div class="glass-card" style="border-top: 4px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; margin-bottom: 16px;">
              <span style="font-size:13px; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Custo Fixo</span>
              <i data-lucide="anchor" color="#0ea5e9"></i>
            </div>
            <h2 class="font-title stat-number" id="val-fixos" style="margin-bottom: 8px;">R$ 0,00</h2>
          </div>

          <div class="glass-card" style="border-top: 4px solid var(--warning);">
            <div style="display:flex; justify-content:space-between; margin-bottom: 16px;">
              <span style="font-size:13px; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Variáveis</span>
              <i data-lucide="zap" color="#f59e0b"></i>
            </div>
            <h2 class="font-title stat-number" id="val-unicos" style="margin-bottom: 8px;">R$ 0,00</h2>
          </div>
        </div>

        <div class="charts-grid">
          <div class="glass-card chart-box">
            <h3 class="font-title" style="margin-bottom: 24px; font-size: 18px;">Curva de Sangria (6 Meses)</h3>
            <div id="chart-area" class="chart-container"></div>
          </div>
          <div class="glass-card chart-box">
            <h3 class="font-title" style="margin-bottom: 24px; font-size: 18px;">Distribuição Fixa</h3>
            <div id="chart-donut" class="chart-container donut-center"></div>
          </div>
        </div>
      </div>

      <div id="view-list" style="display: none;">
        <div class="glass-card" style="padding: 0; overflow: hidden;">
          <div class="table-responsive-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Descrição do Lançamento</th>
                  <th>Categoria</th>
                  <th>Status</th>
                  <th style="text-align:right;">Valor</th>
                  <th style="text-align:center;">Gestão</th>
                </tr>
              </thead>
              <tbody id="table-body">
                </tbody>
            </table>
          </div>
          <div id="empty-table" style="display:none; text-align:center; padding: 80px 20px; color:var(--text-muted);">
            <i data-lucide="check-circle" style="width:48px; height:48px; margin-bottom:16px; opacity:0.5;"></i>
            <h3>Nenhum registro encontrado.</h3>
          </div>
        </div>
      </div>
    </main>

    <nav class="mobile-nav">
      <button class="m-nav-btn active" onclick="app.setTab('overview')"><i data-lucide="layout-dashboard"></i> Visão</button>
      <button class="m-nav-btn" onclick="app.setTab('fixos')"><i data-lucide="anchor"></i> Fixos</button>
      <button class="m-nav-btn" onclick="app.setTab('unicos')"><i data-lucide="zap"></i> Variáveis</button>
    </nav>

    <div class="drawer-overlay" id="drawer-overlay" onclick="app.closeDrawer()"></div>
    <div class="drawer" id="drawer">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 32px;">
        <h2 class="font-title" id="drawer-title" style="font-size: clamp(20px, 5vw, 24px);">Novo Registro</h2>
        <button style="background:rgba(255,255,255,0.05); border:none; color:white; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="app.closeDrawer()"><i data-lucide="x"></i></button>
      </div>

      <input type="hidden" id="form-id">
      
      <div class="type-switcher">
        <button class="type-btn active" id="btn-t-fixos" onclick="app.setFormType('fixos')">Custo Fixo</button>
        <button class="type-btn" id="btn-t-unicos" onclick="app.setFormType('unicos')">Variável</button>
      </div>

      <div class="input-wrapper">
        <label class="input-label">O que está sendo pago? *</label>
        <input type="text" id="form-nome" class="input-field" placeholder="Ex: Assinatura AWS, Escritório...">
      </div>

      <div class="form-grid-mobile" style="display:grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div class="input-wrapper">
          <label class="input-label">Valor (R$) *</label>
          <input type="text" id="form-valor" class="input-field input-money" placeholder="0,00" oninput="app.maskCurrency(event)">
        </div>
        <div class="input-wrapper">
          <label class="input-label">Data Limite</label>
          <input type="date" id="form-data" class="input-field">
        </div>
      </div>

      <div class="input-wrapper">
        <label class="input-label">Categoria Estratégica</label>
        <select id="form-categoria" class="input-field" style="cursor: pointer;"></select>
      </div>

      <div class="input-wrapper">
        <label class="input-label">Status do Pagamento</label>
        <select id="form-status" class="input-field" style="cursor: pointer;">
          <option value="Pago">✔️ Já Descontou (Pago)</option>
          <option value="Pendente">⏳ A Pagar (Agendado)</option>
        </select>
      </div>

      <div class="input-wrapper">
        <label class="input-label">Anotação (Opcional)</label>
        <input type="text" id="form-desc" class="input-field" placeholder="Detalhes, motivo da despesa...">
      </div>

      <button class="btn-action" style="width: 100%; margin-top: 16px; padding: 20px; font-size: 16px;" onclick="app.saveData()">
        Salvar Registro <i data-lucide="check-circle-2"></i>
      </button>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
    const DB = { url: "https://urpuiznydrlwmaqhdids.supabase.co/rest/v1/painel_gastos?id=eq.1", key: "sb_publishable_9G6JUKnfZ1mekk7qUKdTQA_TXbARtR0" };
    const CONF = { admin: "bgtech", pass: "admin2024", months: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"] };
    const CATS = { fixos: ["Software e Automação", "Nuvem e Infra", "Pró-labore e Equipe", "Marketing Fixo", "Estrutura", "Outros Custos"], unicos: ["Hardware e Peças", "Tráfego Pago", "Impostos e Taxas", "Terceirizados", "Eventos", "Gasto Não Previsto"] };

    const app = {
      state: { tab: 'overview', fType: 'fixos', data: { fixos: [], unicos: [] } },
      charts: { area: null, donut: null },

      init() {
        lucide.createIcons();
        const mSel = document.getElementById('filter-month');
        CONF.months.forEach((m, i) => mSel.innerHTML += `<option value="${i}">${m}</option>`);
        mSel.value = new Date().getMonth();

        document.getElementById('login-pass').addEventListener('keypress', e => { if(e.key === 'Enter') app.login() });
      },

      login() {
        const u = document.getElementById('login-user').value.toLowerCase().trim();
        const p = document.getElementById('login-pass').value;
        if(u === CONF.admin && p === CONF.pass) {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-app').style.display = 'flex';
          app.initCharts();
          app.fetchSync();
          setInterval(() => app.fetchSync(true), 15000);
        } else {
          app.toast("Credenciais Inválidas", "error");
        }
      },

      setTab(t) {
        app.state.tab = t;
        document.querySelectorAll('.nav-btn, .m-nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll(`[onclick="app.setTab('${t}')"]`).forEach(b => b.classList.add('active'));
        
        document.getElementById('view-overview').style.display = t === 'overview' ? 'block' : 'none';
        document.getElementById('view-list').style.display = t !== 'overview' ? 'block' : 'none';
        
        const titles = { overview: 'Resumo Financeiro', fixos: 'Estrutura Fixa', unicos: 'Variáveis e Extras' };
        document.getElementById('page-title').innerText = titles[t];
        app.render();
      },

      async fetchSync(silent = false) {
        if(!silent) app.syncUI('loading');
        try {
          const res = await fetch(DB.url, { headers: { 'apikey': DB.key, 'Authorization': `Bearer ${DB.key}` }});
          const d = await res.json();
          if (d && d[0]) {
            app.state.data.fixos = Array.isArray(d[0].fixos) ? d[0].fixos : JSON.parse(d[0].fixos || '[]');
            app.state.data.unicos = Array.isArray(d[0].unicos) ? d[0].unicos : JSON.parse(d[0].unicos || '[]');
          }
          app.syncUI('online');
          app.render();
        } catch(e) { app.syncUI('error'); }
      },

      async pushSync() {
        app.syncUI('loading');
        try {
          await fetch(DB.url, {
            method: 'PATCH',
            headers: { 'apikey': DB.key, 'Authorization': `Bearer ${DB.key}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify({ fixos: app.state.data.fixos, unicos: app.state.data.unicos, updated_at: new Date().toISOString() })
          });
          app.syncUI('online');
        } catch(e) { app.toast("Erro ao sincronizar nuvem.", "error"); app.syncUI('error'); }
      },

      syncUI(state) {
        const dot = document.getElementById('sync-indicator');
        const txt = document.getElementById('sync-text');
        if(state === 'loading') { dot.style.background = 'var(--warning)'; dot.style.boxShadow = '0 0 10px var(--warning)'; txt.innerText = "Sincronizando..."; }
        else if(state === 'online') { dot.style.background = 'var(--success)'; dot.style.boxShadow = '0 0 10px var(--success)'; txt.innerText = "Nuvem Conectada"; }
        else { dot.style.background = 'var(--danger)'; dot.style.boxShadow = '0 0 10px var(--danger)'; txt.innerText = "Modo Offline"; }
      },

      maskCurrency(e) {
        let v = e.target.value.replace(/\D/g, "");
        if(!v) { e.target.value = ""; return; }
        v = (parseInt(v) / 100).toFixed(2);
        e.target.value = v.replace(".", ",").replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
      },
      
      cleanMoney(str) { return parseFloat((str||"0").replace(/\./g, '').replace(',', '.')); },
      fmtR(v) { return new Intl.NumberFormat('pt-BR', {style: 'currency', currency: 'BRL'}).format(v||0); },
      fmtD(d) { if(!d) return "--/--"; const p = d.split('-'); return p.length===3 ? `${p[2]}/${p[1]}` : d; },

      render() {
        const mes = parseInt(document.getElementById('filter-month').value);
        const ano = parseInt(document.getElementById('filter-year').value);
        
        const filterFn = (x) => { if(!x.data) return false; const p = x.data.split('-'); return parseInt(p[1])-1===mes && parseInt(p[0])===ano; };
        
        const fixos = app.state.data.fixos.filter(filterFn);
        const unicos = app.state.data.unicos.filter(filterFn);
        
        const sumF = fixos.reduce((a,b) => a + Number(b.valor), 0);
        const sumU = unicos.reduce((a,b) => a + Number(b.valor), 0);

        document.getElementById('val-total').innerText = app.fmtR(sumF + sumU);
        document.getElementById('val-fixos').innerText = app.fmtR(sumF);
        document.getElementById('val-unicos').innerText = app.fmtR(sumU);

        if(app.state.tab !== 'overview') {
          const list = (app.state.tab === 'fixos' ? fixos : unicos).sort((a,b) => b.data.localeCompare(a.data));
          const tbody = document.getElementById('table-body');
          const empty = document.getElementById('empty-table');
          
          if(list.length === 0) { tbody.innerHTML = ''; empty.style.display = 'block'; }
          else {
            empty.style.display = 'none';
            tbody.innerHTML = list.map(i => `
              <tr>
                <td style="color:var(--text-muted); font-weight:600;">${app.fmtD(i.data)}</td>
                <td><div style="font-weight:700; font-size:15px; color:white;">${i.nome}</div><div style="font-size:12px; color:var(--text-muted); margin-top:4px;">${i.descricao||'-'}</div></td>
                <td><span style="background:rgba(255,255,255,0.05); padding:4px 10px; border-radius:6px; font-size:11px; font-weight:700; color:var(--text-muted);">${i.categoria}</span></td>
                <td><span class="status-badge ${i.status==='Pendente'?'pendente':'pago'}"><i data-lucide="${i.status==='Pendente'?'clock':'check'}" style="width:12px;"></i> ${i.status}</span></td>
                <td class="font-title" style="text-align:right; font-size:16px; font-weight:800; color:${i.status==='Pendente'?'var(--text-muted)':'white'};">${app.fmtR(i.valor)}</td>
                <td style="text-align:center; white-space:nowrap;">
                  <button class="action-icon" onclick="app.editItem('${i.id}')"><i data-lucide="edit-2" style="width:18px;"></i></button>
                  <button class="action-icon del" onclick="app.deleteItem('${i.id}')"><i data-lucide="trash-2" style="width:18px;"></i></button>
                </td>
              </tr>
            `).join('');
            lucide.createIcons(); 
          }
        }
        app.updateCharts();
      },

      initCharts() {
        const optArea = {
          series: [{ name: 'Gasto Total', data: [] }],
          chart: { type: 'area', height: '100%', toolbar: { show: false }, background: 'transparent', fontFamily: 'Inter' },
          colors: ['#0ea5e9'],
          fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.6, opacityTo: 0.05, stops: [0, 90, 100] } },
          dataLabels: { enabled: false },
          stroke: { curve: 'smooth', width: 3 },
          grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
          xaxis: { categories: [], labels: { style: { colors: '#94a3b8', fontWeight: 600 } }, axisBorder: { show: false }, axisTicks: { show: false } },
          yaxis: { labels: { style: { colors: '#94a3b8' }, formatter: (v) => `R$${(v/1000).toFixed(0)}k` } },
          theme: { mode: 'dark' },
          tooltip: { theme: 'dark', y: { formatter: v => app.fmtR(v) } }
        };
        app.charts.area = new ApexCharts(document.querySelector("#chart-area"), optArea);
        app.charts.area.render();

        const optDonut = {
          series: [], labels: [],
          chart: { type: 'donut', height: '100%', background: 'transparent', fontFamily: 'Inter' },
          colors: ['#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd', '#0284c7', '#0369a1'],
          stroke: { show: true, colors: ['#0f172a'], width: 2 },
          dataLabels: { enabled: false },
          legend: { position: 'bottom', labels: { colors: '#94a3b8' } },
          plotOptions: { pie: { donut: { size: '75%', labels: { show: true, name: { color: '#94a3b8' }, value: { color: 'white', fontSize: '24px', fontWeight: 800, formatter: v => app.fmtR(v) }, total: { show: true, label: 'Fixos', color: '#94a3b8', formatter: w => app.fmtR(w.globals.seriesTotals.reduce((a,b)=>a+b,0)) } } } } },
          theme: { mode: 'dark' }
        };
        app.charts.donut = new ApexCharts(document.querySelector("#chart-donut"), optDonut);
        app.charts.donut.render();
      },

      updateCharts() {
        if(!app.charts.area) return;
        const areaData = []; const areaCats = [];
        for(let i=5; i>=0; i--) {
          const d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - i);
          const m = d.getMonth(), a = d.getFullYear();
          const f = app.state.data.fixos.filter(x => {const p=x.data?.split('-'); return parseInt(p?.[1])-1===m && parseInt(p?.[0])===a}).reduce((s,x)=>s+Number(x.valor),0);
          const v = app.state.data.unicos.filter(x => {const p=x.data?.split('-'); return parseInt(p?.[1])-1===m && parseInt(p?.[0])===a}).reduce((s,x)=>s+Number(x.valor),0);
          areaData.push(f+v); areaCats.push(CONF.months[m].substring(0,3));
        }
        app.charts.area.updateSeries([{ data: areaData }]);
        app.charts.area.updateOptions({ xaxis: { categories: areaCats } });

        const mes = parseInt(document.getElementById('filter-month').value);
        const ano = parseInt(document.getElementById('filter-year').value);
        const curFixos = app.state.data.fixos.filter(x => {const p=x.data?.split('-'); return parseInt(p?.[1])-1===mes && parseInt(p?.[0])===ano});
        
        const catMap = {};
        curFixos.forEach(x => { catMap[x.categoria] = (catMap[x.categoria]||0) + Number(x.valor); });
        const labels = Object.keys(catMap);
        const series = Object.values(catMap);
        
        if(series.length > 0) {
          app.charts.donut.updateOptions({ labels: labels });
          app.charts.donut.updateSeries(series);
        } else {
          app.charts.donut.updateSeries([1]);
          app.charts.donut.updateOptions({ labels: ['Sem Dados'], colors: ['#1e293b'] });
        }
      },

      openDrawer(item = null) {
        document.getElementById('drawer').classList.add('open');
        document.getElementById('drawer-overlay').classList.add('open');
        document.getElementById('drawer-title').innerText = item ? 'Editar Gasto' : 'Novo Lançamento';
        
        if (item) {
          const isFixo = app.state.data.fixos.some(i => i.id === item.id);
          app.setFormType(isFixo ? 'fixos' : 'unicos');
          document.getElementById('form-id').value = item.id;
          document.getElementById('form-nome').value = item.nome;
          document.getElementById('form-valor').value = app.fmtR(item.valor).replace('R$', '').trim();
          document.getElementById('form-data').value = item.data;
          document.getElementById('form-categoria').value = item.categoria;
          document.getElementById('form-status').value = item.status || 'Pago';
          document.getElementById('form-desc').value = item.descricao || '';
        } else {
          app.setFormType(app.state.tab === 'overview' ? 'fixos' : app.state.tab);
          document.getElementById('form-id').value = '';
          document.getElementById('form-nome').value = '';
          document.getElementById('form-valor').value = '';
          document.getElementById('form-data').value = new Date().toISOString().split('T')[0];
          document.getElementById('form-status').value = 'Pago';
          document.getElementById('form-desc').value = '';
        }
      },

      closeDrawer() {
        document.getElementById('drawer').classList.remove('open');
        document.getElementById('drawer-overlay').classList.remove('open');
      },

      setFormType(t) {
        app.state.fType = t;
        document.getElementById('btn-t-fixos').classList.toggle('active', t === 'fixos');
        document.getElementById('btn-t-unicos').classList.toggle('active', t === 'unicos');
        
        const sel = document.getElementById('form-categoria');
        sel.innerHTML = '';
        CATS[t].forEach(c => sel.innerHTML += `<option value="${c}" style="background:#0f172a">${c}</option>`);
      },

      saveData() {
        const nome = document.getElementById('form-nome').value.trim();
        const valor = app.cleanMoney(document.getElementById('form-valor').value);
        if(!nome || valor <= 0) return app.toast("Obrigatório nome e valor válido.", "error");

        const obj = {
          id: document.getElementById('form-id').value || `bgt_${Date.now()}`,
          nome: nome, valor: valor,
          data: document.getElementById('form-data').value,
          categoria: document.getElementById('form-categoria').value,
          status: document.getElementById('form-status').value,
          descricao: document.getElementById('form-desc').value.trim()
        };

        const targetArr = app.state.data[app.state.fType];
        const idx = targetArr.findIndex(i => i.id === obj.id);
        
        if (idx >= 0) targetArr[idx] = obj; else targetArr.push(obj);

        const otherArr = app.state.fType === 'fixos' ? 'unicos' : 'fixos';
        app.state.data[otherArr] = app.state.data[otherArr].filter(i => i.id !== obj.id);

        app.closeDrawer();
        app.render(); 
        app.pushSync(); 
        app.toast("Salvo no Cofre BG Tech!");
      },

      editItem(id) {
        const item = app.state.data.fixos.find(i=>i.id===id) || app.state.data.unicos.find(i=>i.id===id);
        if(item) app.openDrawer(item);
      },

      deleteItem(id) {
        if(confirm("Confirma exclusão permanente deste registro?")) {
          app.state.data.fixos = app.state.data.fixos.filter(i=>i.id!==id);
          app.state.data.unicos = app.state.data.unicos.filter(i=>i.id!==id);
          app.render();
          app.pushSync();
          app.toast("Registro apagado.");
        }
      },

      toast(msg, type='success') {
        const box = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.innerHTML = `<i data-lucide="${type==='error'?'alert-circle':'check-circle'}" color="${type==='error'?'#ef4444':'#10b981'}"></i> <span>${msg}</span>`;
        box.appendChild(t);
        lucide.createIcons();
        setTimeout(() => t.classList.add('show'), 10);
        setTimeout(() => { t.classList.remove('show'); setTimeout(()=>t.remove(), 400); }, 3500);
      }
    };

    window.onload = app.init;
  </script>
</body>
</html>
